<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaPass • Dashboard</title>
    
    <!-- Iconify Icons -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== DESIGN SYSTEM UPDATED ===== */
        :root {
            /* Updated Mint Green Palette - As Accent */
            --mint-50: #E8F8F2;
            --mint-100: #D4F1E9;
            --mint-200: #B4E6D6;
            --mint-300: #2ED3B7; /* Updated Primary Accent */
            --mint-400: #1FAF95;
            --mint-500: #158C75;
            
            /* Updated Neutral Palette */
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            
            /* Semantic Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --danger-dark: #DC2626;
            --info: #3B82F6;
            --pending: #F59E0B;
            --pending-light: #FEF3C7;
            --blocked: #DC2626;
            --blocked-light: #FEE2E2;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-mint: 0 4px 20px rgba(46, 211, 183, 0.15);
            
            /* Light Theme (Default) */
            --bg-primary: var(--gray-50);
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            --border-hover: var(--mint-300);
            
            /* Dark Theme Variables */
            --dark-bg-primary: #0B1220;
            --dark-bg-secondary: #111827;
            --dark-bg-card: #111827;
            --dark-text-primary: #F1F5F9;
            --dark-text-secondary: #94A3B8;
            --dark-text-muted: #64748B;
            --dark-border-color: #1E293B;
            --dark-border-hover: #2ED3B7;
        }

        /* Apply Dark Theme */
        body.dark-mode {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-card: var(--dark-bg-card);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-muted: var(--dark-text-muted);
            --border-color: var(--dark-border-color);
            --border-hover: var(--dark-border-hover);
        }

        /* ===== LOADING STATES ===== */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--border-color) 25%,
                var(--bg-primary) 50%,
                var(--border-color) 75%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .skeleton-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        .skeleton-card {
            height: 280px;
            border-radius: 20px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: inherit;
        }

        body.dark-mode .loading-overlay {
            background: rgba(11, 18, 32, 0.9);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--mint-300);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ===== ACCESS OVERLAY ===== */
        .access-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn 0.4s ease;
        }

        body.dark-mode .access-overlay {
            background: rgba(11, 18, 32, 0.97);
        }

        .access-message {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.3s ease;
        }

        .access-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2.5rem;
        }

        .access-icon.pending {
            background: var(--pending-light);
            color: var(--pending);
        }

        .access-icon.blocked {
            background: var(--blocked-light);
            color: var(--blocked);
        }

        .access-message .h3 {
            margin-bottom: 1rem;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .access-message .body {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
            font-size: 1.125rem;
        }

        .access-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* ===== TYPOGRAPHY - UPDATED HIERARCHY ===== */
        .h1 { 
            font-size: 2.5rem; 
            font-weight: 700; 
            line-height: 1.2;
            color: var(--text-primary);
            margin-bottom: 1rem;
            position: relative;
            display: inline-block;
        }

        .h1 .gradient-text {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
        }

        .h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 0;
            width: 40%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--mint-300));
            border-radius: 2px;
        }

        .h2 { 
            font-size: 2rem; 
            font-weight: 700; 
            line-height: 1.3;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .h3 { 
            font-size: 1.5rem; 
            font-weight: 600; 
            line-height: 1.4;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        
        .h4 { 
            font-size: 1.25rem; 
            font-weight: 600; 
            line-height: 1.4;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .section-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 2rem;
            max-width: 600px;
        }
        
        .body-lg { 
            font-size: 1.125rem; 
            line-height: 1.7; 
            color: var(--text-secondary);
        }
        
        .body { 
            font-size: 1rem; 
            line-height: 1.6; 
            color: var(--text-secondary);
        }
        
        .body-sm { 
            font-size: 0.875rem; 
            line-height: 1.5; 
            color: var(--text-muted);
        }
        
        .caption { 
            font-size: 0.75rem; 
            line-height: 1.4; 
            color: var(--text-muted);
        }
        
        .text-gradient {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ===== NAVBAR - UPDATED ===== */
        .navbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.98);
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .navbar {
            background: rgba(17, 24, 39, 0.98);
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-text::after {
            content: '•';
            color: var(--mint-300);
            font-size: 1.8rem;
            line-height: 1;
        }

        .logo-dashboard {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ===== NAV TABS - UPDATED ===== */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            margin-right: 2rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .nav-tab:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        body.dark-mode .nav-tab:hover {
            background: rgba(46, 211, 183, 0.1);
        }

        .nav-tab.active {
            background: var(--mint-100);
            color: var(--mint-400);
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .nav-tab.active {
            background: rgba(46, 211, 183, 0.2);
            box-shadow: 0 2px 8px rgba(46, 211, 183, 0.15);
        }

        /* ===== SECTIONS MANAGEMENT ===== */
        .section {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin-bottom: 0.5rem;
        }

        /* ===== DASHBOARD SECTION - UPDATED ===== */
        .dashboard-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: calc(100vh - 88px);
        }

        .welcome-section {
            margin-bottom: 3rem;
        }

        .welcome-section .h1 {
            margin-bottom: 1rem;
        }

        .welcome-section .section-subtitle {
            margin-bottom: 0;
            max-width: 600px;
        }

        /* ===== SMART PASSWORD CARDS ===== */
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .board-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.5s ease;
            min-height: 320px;
        }

        .board-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
        }

        .board-card.loading {
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .board-icon-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .board-icon {
            width: 64px;
            height: 64px;
            background: var(--mint-50);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--mint-400);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .board-card:hover .board-icon {
            transform: scale(1.05);
            background: var(--mint-100);
            border-color: var(--mint-200);
        }

        body.dark-mode .board-icon {
            background: rgba(46, 211, 183, 0.1);
        }

        .category-dot {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid var(--bg-card);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            z-index: 2;
        }

        .category-dot:hover {
            transform: scale(1.3);
        }

        .category-dot.personal { background: var(--mint-300); }
        .category-dot.work { background: #4ECDC4; }
        .category-dot.important { background: #FF6B6B; }
        .category-dot.social { background: #9D4EDD; }
        .category-dot.finance { background: #FFD166; }
        .category-dot.other { background: #118AB2; }

        .board-info {
            flex: 1;
            min-width: 0;
        }

        .board-name {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .board-username {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .password-section {
            margin-top: 0.5rem;
        }

        .password-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .password-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s ease;
            position: relative;
        }

        .password-field:hover {
            border-color: var(--border-hover);
        }

        .password-field.focused {
            border-color: var(--mint-300);
            box-shadow: 0 0 0 3px rgba(46, 211, 183, 0.1);
        }

        .password-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            font-size: 1rem;
            letter-spacing: 0.05em;
            min-width: 0;
            outline: none;
            width: 100%;
        }

        .password-visibility-controls {
            display: flex;
            gap: 0.25rem;
        }

        /* Password Strength Badge */
        .password-strength-badge {
            position: absolute;
            top: -10px;
            left: 12px;
            background: var(--bg-card);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            z-index: 1;
        }

        .strength-weak {
            background: #FEE2E2;
            color: #DC2626;
            border-color: #FCA5A5;
        }

        .strength-medium {
            background: #FEF3C7;
            color: #D97706;
            border-color: #FBBF24;
        }

        .strength-good {
            background: #D1FAE5;
            color: #059669;
            border-color: #34D399;
        }

        .strength-excellent {
            background: #E0F2FE;
            color: #0369A1;
            border-color: #7DD3FC;
        }

        .copy-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .copy-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .copy-btn.email:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .copy-btn.password:hover {
            background: #E0F2FE;
            color: #0369A1;
            border-color: #7DD3FC;
        }

        .card-footer {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .action-btn {
            flex: 1;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .action-btn.edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border-color: var(--info);
        }

        .action-btn.delete:hover {
            background: var(--danger-light);
            color: var(--danger-dark);
            border-color: var(--danger);
        }

        /* ===== EMPTY STATES - ENHANCED ===== */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            animation: fadeIn 0.6s ease;
            background: var(--bg-card);
            border-radius: 20px;
            border: 2px dashed var(--border-color);
            margin: 2rem 0;
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--mint-100);
            margin-bottom: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }

        .empty-state .h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .empty-state .body {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        /* ===== DEVICES SECTION - ENHANCED ===== */
        .devices-section {
            max-width: 1280px;
            margin: 0 auto;
        }

        .devices-description {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
            font-size: 1.125rem;
        }

        .devices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .device-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--mint-200);
        }

        .device-card.current {
            border: 2px solid var(--mint-300);
            background: linear-gradient(135deg, 
                rgba(46, 211, 183, 0.05), 
                rgba(46, 211, 183, 0.02));
        }

        .device-card.current::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--mint-300);
        }

        .device-card.blocked {
            border: 2px solid var(--blocked);
            background: linear-gradient(135deg, 
                rgba(220, 38, 38, 0.05), 
                rgba(220, 38, 38, 0.02));
            opacity: 0.7;
        }

        .device-card.pending {
            border: 2px solid var(--pending);
            background: linear-gradient(135deg, 
                rgba(245, 158, 11, 0.05), 
                rgba(245, 158, 11, 0.02));
        }

        .device-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: var(--mint-50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mint-400);
            font-size: 1.75rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .device-card:hover .device-icon {
            transform: scale(1.05);
            background: var(--mint-100);
        }

        body.dark-mode .device-icon {
            background: rgba(46, 211, 183, 0.1);
        }

        body.dark-mode .device-card:hover .device-icon {
            background: rgba(46, 211, 183, 0.2);
        }

        .device-info {
            flex: 1;
            min-width: 0;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .device-name {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .device-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .device-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .device-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
        }

        .device-badge.current {
            background: var(--mint-50);
            color: var(--mint-400);
            border: 1px solid var(--mint-200);
        }

        .device-badge.owner {
            background: rgba(46, 211, 183, 0.2);
            color: var(--mint-400);
            border: 1px solid rgba(46, 211, 183, 0.3);
        }

        .device-badge.trusted {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .device-badge.blocked {
            background: var(--blocked-light);
            color: var(--blocked);
            border: 1px solid var(--blocked);
        }

        .device-badge.pending {
            background: var(--pending-light);
            color: var(--pending);
            border: 1px solid var(--pending);
        }

        body.dark-mode .device-badge.current {
            background: rgba(46, 211, 183, 0.2);
        }

        body.dark-mode .device-badge.trusted {
            background: rgba(16, 185, 129, 0.2);
        }

        .device-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .device-actions {
            display: flex;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
        }

        .device-card:hover .device-actions {
            opacity: 1;
            transform: translateX(0);
        }

        .device-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .device-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .device-action-btn.logout:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        .device-action-btn.trust:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .device-action-btn.approve:hover {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: var(--success);
        }

        .device-action-btn.block:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        .device-action-btn.unblock:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        body.dark-mode .device-action-btn.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        body.dark-mode .device-action-btn.trust:hover {
            background: rgba(46, 211, 183, 0.1);
        }

        .device-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ===== ACTIVITY LOGS SECTION - ENHANCED ===== */
        .activity-section {
            max-width: 1280px;
            margin: 0 auto;
        }

        .activity-description {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
            font-size: 1.125rem;
        }

        .activity-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .activity-filter {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .activity-filter:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .activity-filter.active {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-200);
            box-shadow: var(--shadow-sm);
        }

        .activity-timeline {
            position: relative;
            padding-right: 2rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .activity-day-group {
            margin-bottom: 3rem;
            position: relative;
        }

        .day-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .day-header::before {
            content: '';
            position: absolute;
            right: -2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--mint-300);
            border: 3px solid var(--bg-primary);
            z-index: 2;
        }

        .day-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.125rem;
        }

        .day-count {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .activity-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.3s ease;
            transition: all 0.2s ease;
            position: relative;
        }

        .activity-item:hover {
            border-color: var(--mint-200);
            transform: translateX(-4px);
            box-shadow: var(--shadow-sm);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.login { background: rgba(46, 211, 183, 0.1); color: var(--mint-400); }
        .activity-icon.logout { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.device_logout { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.add { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .activity-icon.edit { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .activity-icon.delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.copy { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .activity-icon.theme { background: rgba(46, 211, 183, 0.1); color: var(--mint-400); }
        .activity-icon.trust { background: rgba(46, 211, 183, 0.1); color: var(--mint-400); }
        .activity-icon.block { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.unblock { background: rgba(46, 211, 183, 0.1); color: var(--mint-400); }
        .activity-icon.approve { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .activity-icon.import { background: rgba(46, 211, 183, 0.1); color: var(--mint-400); }
        .activity-icon.export { background: rgba(59, 130, 246, 0.1); color: var(--info); }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-description-text {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .activity-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        /* ===== SETTINGS SECTION - REORGANIZED ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .settings-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }

        .settings-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--mint-50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mint-400);
            font-size: 1.5rem;
        }

        body.dark-mode .settings-card-icon {
            background: rgba(46, 211, 183, 0.1);
        }

        .settings-card-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .settings-card-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }

        .settings-item:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .settings-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
        }

        .settings-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .settings-description {
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ===== OLD DATA MIGRATION SECTION ===== */
        .migration-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            border: 2px dashed var(--border-color);
            margin: 3rem 0;
            text-align: center;
        }

        .migration-icon {
            font-size: 3rem;
            color: var(--mint-300);
            margin-bottom: 1.5rem;
        }

        .migration-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .migration-btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            min-width: 200px;
            justify-content: center;
        }

        .migration-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .migration-btn.import:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .migration-btn.export:hover {
            background: #E0F2FE;
            color: #0369A1;
            border-color: #7DD3FC;
        }

        .preview-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }

        /* ===== USER PROFILE - UPDATED ===== */
        .user-profile {
            position: relative;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: none;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .profile-trigger:hover {
            background: var(--mint-50);
        }

        body.dark-mode .profile-trigger:hover {
            background: rgba(46, 211, 183, 0.1);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            padding: 1rem;
            min-width: 280px;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            animation: slideDown 0.2s ease;
            border: 1px solid var(--border-color);
            z-index: 1000;
        }

        .profile-dropdown.active {
            display: flex;
        }

        .dropdown-header {
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
            min-height: 44px;
        }

        .dropdown-item:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(46, 211, 183, 0.1);
        }

        .dropdown-item.danger {
            color: var(--danger);
            margin-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.875rem;
        }

        .dropdown-item.danger:hover {
            background: var(--danger-light);
            color: var(--danger-dark);
        }

        body.dark-mode .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ===== FLOATING ADD BUTTON ===== */
        .floating-add-btn {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-mint);
            border: none;
            z-index: 900;
        }

        .floating-add-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 25px rgba(46, 211, 183, 0.3);
        }

        .floating-add-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* ===== MODALS - ENHANCED ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 520px;
            animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        /* ===== CONFIRM MODAL - ENHANCED ===== */
        .confirm-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }

        .confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2.5rem;
        }

        .confirm-icon.delete {
            background: var(--danger-light);
            color: var(--danger);
        }

        .confirm-icon.logout {
            background: var(--warning-light);
            color: var(--warning);
        }

        .confirm-icon.block {
            background: var(--danger-light);
            color: var(--danger);
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* ===== SETTINGS MODAL - REORGANIZED ===== */
        .settings-modal .modal-content {
            max-width: 800px;
        }

        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .settings-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .settings-tab:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        .settings-tab.active {
            background: var(--mint-100);
            color: var(--mint-400);
            box-shadow: var(--shadow-sm);
        }

        .settings-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* ===== FORM CONTROLS - ENHANCED ===== */
        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--border-hover);
            box-shadow: 0 0 0 4px rgba(46, 211, 183, 0.1);
        }

        .form-control:hover {
            border-color: var(--border-hover);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-control.error {
            border-color: var(--danger);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ===== RADIO AND SEGMENTED CONTROLS ===== */
        .radio-selector {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-circle {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            cursor: pointer;
        }

        .radio-circle:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .radio-circle.selected {
            border-color: white;
            box-shadow: 0 0 0 3px var(--mint-300);
        }

        .radio-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .segmented-control {
            display: flex;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
        }

        .segmented-option {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .segmented-option:hover {
            background: var(--mint-50);
        }

        .segmented-option.selected {
            background: var(--mint-100);
            color: var(--mint-400);
            box-shadow: var(--shadow-sm);
        }

        /* ===== ICON SELECTOR ===== */
        .icon-selector {
            margin-bottom: 2rem;
        }

        .icon-search-container {
            margin-bottom: 1.5rem;
        }

        .icon-categories {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .category-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        .category-btn.active {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-200);
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
        }

        .icon-option {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            transform: scale(1.1);
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-200);
        }

        .icon-option.selected {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-300);
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(46, 211, 183, 0.2);
        }

        /* ===== PASSWORD STRENGTH - ENHANCED ===== */
        .password-strength-advanced {
            margin-top: 1rem;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .strength-meter {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .strength-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .strength-criteria {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .strength-criteria.valid {
            color: var(--success);
        }

        .strength-criteria.valid iconify-icon {
            color: var(--success);
        }

        .strength-score {
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ===== MODAL ACTIONS ===== */
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2.5rem;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 211, 183, 0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--mint-50);
            border-color: var(--mint-300);
        }

        body.dark-mode .btn-secondary:hover {
            background: rgba(46, 211, 183, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* ===== TOAST NOTIFICATIONS - ENHANCED ===== */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: toastSlideIn 0.3s ease;
            transform-origin: bottom right;
            max-width: 320px;
        }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }

        .toast-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .toast.error .toast-icon {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .toast.info .toast-icon {
            background: rgba(46, 211, 183, 0.1);
            color: var(--mint-400);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100px) scale(0.9);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes copyPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .nav-tabs {
                display: none;
            }
            
            .dashboard-content {
                padding: 1.5rem 1rem;
            }
            
            .boards-grid {
                grid-template-columns: 1fr;
            }
            
            .device-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .device-actions {
                width: 100%;
                justify-content: flex-end;
                opacity: 1;
                transform: none;
            }
            
            .activity-timeline {
                padding-right: 1.5rem;
            }
            
            .activity-timeline::before {
                right: 0.5rem;
            }
            
            .day-header::before {
                right: -1.5rem;
            }
            
            .modal-content {
                padding: 2rem 1.5rem;
                margin: 0 1rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .floating-add-btn {
                bottom: 1.5rem;
                left: 1.5rem;
                width: 52px;
                height: 52px;
            }
            
            .action-btn {
                font-size: 0.8125rem;
                padding: 0 0.5rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .migration-actions {
                flex-direction: column;
            }
            
            .migration-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .logo-dashboard {
                display: none;
            }
            
            .user-info {
                display: none;
            }
            
            .profile-trigger {
                padding: 0.5rem;
            }
            
            .board-card {
                padding: 1.5rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .toast-container {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }
            
            .toast {
                max-width: none;
            }
            
            .device-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .device-badges {
                width: 100%;
            }
            
            .activity-item {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .activity-time {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Access Overlay -->
    <div class="access-overlay" id="accessOverlay" style="display: none;">
        <div class="access-message" id="accessMessage">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">NovaPass<span class="logo-dashboard" id="dashboardLabel">Dashboard</span></span>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="dashboardSection">
                    <iconify-icon icon="mdi:view-dashboard"></iconify-icon>
                    <span>لوحة التحكم</span>
                </button>
                <button class="nav-tab" data-section="devicesSection">
                    <iconify-icon icon="mdi:devices"></iconify-icon>
                    <span>الأجهزة</span>
                </button>
                <button class="nav-tab" data-section="activitySection">
                    <iconify-icon icon="mdi:history"></iconify-icon>
                    <span>سجلات النشاط</span>
                </button>
            </div>
            
            <div class="nav-actions">
                <!-- User Profile -->
                <div class="user-profile">
                    <button class="profile-trigger" id="profileBtn">
                        <div class="avatar" id="userAvatar">M</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">محمد</div>
                            <div class="user-status">
                                <iconify-icon icon="mdi:check-circle" style="font-size: 0.75rem;"></iconify-icon>
                                <span>متصلة</span>
                            </div>
                        </div>
                    </button>
                    
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <div class="user-name" id="dropdownName">محمد</div>
                            <div class="body-sm" style="color: var(--text-muted);" id="userEmail">mohamed@example.com</div>
                        </div>
                        
                        <a href="#" class="dropdown-item" data-section="devicesSection">
                            <iconify-icon icon="mdi:devices"></iconify-icon>
                            <span>الأجهزة</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" data-section="activitySection">
                            <iconify-icon icon="mdi:history"></iconify-icon>
                            <span>سجلات النشاط</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" id="settingsBtn">
                            <iconify-icon icon="mdi:cog"></iconify-icon>
                            <span>الإعدادات</span>
                        </a>
                        
                        <a href="#" class="dropdown-item danger" id="logoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Floating Add Button -->
    <button class="floating-add-btn" id="floatingAddBtn">
        <iconify-icon icon="mdi:plus" style="font-size: 1.5rem;"></iconify-icon>
    </button>

    <!-- Main Content -->
    <main class="dashboard-content">
        <!-- Dashboard Section (Default) -->
        <div class="section active" id="dashboardSection">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <h1 class="h1"><span class="gradient-text" id="welcomeMessage">مرحباً محمد!</span></h1>
                <p class="section-subtitle">
                    إدارة كلمات المرور الخاصة بك أصبحت أسهل وأكثر أماناً. كل شيء في مكان واحد، تحت سيطرتك الكاملة.
                </p>
            </div>

            <!-- Boards Grid -->
            <div class="boards-grid" id="boardsContainer">
                <!-- Loading State -->
                <div class="board-card loading" id="loadingState">
                    <div class="card-header">
                        <div class="skeleton-circle skeleton"></div>
                        <div style="flex: 1;">
                            <div class="skeleton-text skeleton" style="width: 70%;"></div>
                            <div class="skeleton-text skeleton" style="width: 50%;"></div>
                        </div>
                    </div>
                    <div class="password-section">
                        <div class="skeleton-text skeleton" style="width: 40%;"></div>
                        <div class="skeleton-text skeleton" style="height: 48px;"></div>
                        <div class="skeleton-text skeleton" style="width: 60%; margin-top: 1rem;"></div>
                    </div>
                    <div class="card-footer">
                        <div class="skeleton-text skeleton" style="flex: 1; height: 40px;"></div>
                        <div class="skeleton-text skeleton" style="flex: 1; height: 40px;"></div>
                    </div>
                </div>
            </div>

            <!-- Old Data Migration Section -->
            <div class="migration-section" id="migrationSection" style="display: none;">
                <div class="migration-icon">
                    <iconify-icon icon="mdi:database-import"></iconify-icon>
                </div>
                <h3 class="h3">ترحيل البيانات القديمة</h3>
                <p class="body">
                    استورد بياناتك من مدير كلمات المرور القديم أو حمل نسخة احتياطية من بياناتك الحالية.
                </p>
                <div class="migration-actions">
                    <button class="migration-btn import" id="importDataBtn">
                        <iconify-icon icon="mdi:import"></iconify-icon>
                        <span>استيراد بيانات</span>
                    </button>
                    <button class="migration-btn export" id="exportDataBtn">
                        <iconify-icon icon="mdi:export"></iconify-icon>
                        <span>تصدير البيانات</span>
                    </button>
                </div>
                <div class="preview-container" id="dataPreview" style="display: none;"></div>
            </div>
        </div>

        <!-- Devices Section -->
        <div class="section devices-section" id="devicesSection">
            <div class="section-header">
                <div>
                    <h2 class="h2">🔐 الأجهزة المرتبطة بالحساب</h2>
                    <p class="section-subtitle">
                        تحكم كامل في الأمان وجلسات الدخول من جميع الأجهزة
                    </p>
                </div>
            </div>
            
            <div class="devices-list" id="devicesList">
                <!-- Loading State -->
                <div class="device-card loading">
                    <div class="device-icon">
                        <div class="skeleton skeleton-circle"></div>
                    </div>
                    <div class="device-info">
                        <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 0.5rem;"></div>
                        <div class="skeleton skeleton-text" style="width: 40%; height: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Logs Section -->
        <div class="section activity-section" id="activitySection">
            <div class="section-header">
                <div>
                    <h2 class="h2">📜 سجلات النشاط</h2>
                    <p class="section-subtitle">
                        تتبع جميع الأنشطة المهمة على حسابك للحفاظ على الأمان والخصوصية
                    </p>
                </div>
            </div>
            
            <div class="activity-filters" id="activityFilters">
                <!-- Filters will be populated by JavaScript -->
            </div>
            
            <div class="activity-timeline" id="activityTimeline">
                <!-- Loading State -->
                <div class="activity-day-group">
                    <div class="day-header">
                        <div class="skeleton skeleton-text" style="width: 120px; height: 1.5rem;"></div>
                    </div>
                    <div class="activity-items">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
                            </div>
                            <div class="activity-content">
                                <div class="skeleton skeleton-text" style="width: 70%; height: 1.25rem; margin-bottom: 0.5rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 50%; height: 1rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section" id="settingsSection">
            <div class="section-header">
                <div>
                    <h2 class="h2">⚙️ الإعدادات</h2>
                    <p class="section-subtitle">
                        خصص تجربتك وادخل إلى الإعدادات المتقدمة
                    </p>
                </div>
            </div>
            
            <div class="settings-grid" id="settingsGrid">
                <!-- Settings cards will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Board Modal (Add/Edit) -->
    <div class="modal" id="boardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3" id="modalTitle">إضافة حساب جديد</h3>
                <button class="close-btn" id="closeModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <form id="boardForm">
                <input type="hidden" id="boardId">
                
                <div class="form-group">
                    <label class="form-label">اسم الحساب *</label>
                    <input type="text" id="boardName" class="form-control" 
                           placeholder="مثال: Facebook, Gmail, Instagram"
                           required>
                    <div class="error-message" id="nameError"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني / اسم المستخدم *</label>
                    <input type="text" id="boardEmail" class="form-control" 
                           placeholder="user@example.com أو اسم المستخدم"
                           required>
                    <div class="error-message" id="emailError"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">كلمة المرور *</label>
                    <input type="password" id="boardPassword" class="form-control" 
                           placeholder="أدخل كلمة المرور"
                           required>
                    <div class="error-message" id="passwordError"></div>
                    
                    <!-- Advanced Password Strength Meter -->
                    <div class="password-strength-advanced">
                        <div class="strength-meter">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-details" id="strengthDetails">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="strength-score" id="strengthScore">0%</div>
                    </div>
                </div>
                
                <!-- Icon Selector -->
                <div class="icon-selector">
                    <label class="form-label">اختر الأيقونة</label>
                    
                    <div class="icon-search-container">
                        <input type="text" id="iconSearch" class="form-control" 
                               placeholder="ابحث عن أيقونة...">
                    </div>
                    
                    <div class="icon-categories" id="iconCategories">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                    
                    <div class="icon-grid" id="iconGrid">
                        <!-- Icons will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Color Selector -->
                <div class="color-selector">
                    <label class="form-label">اختر التصنيف</label>
                    <div class="radio-selector" id="colorSelector">
                        <!-- Color options will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBoardBtn">
                        <iconify-icon icon="mdi:check"></iconify-icon>
                        <span>حفظ الحساب</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Action Modal -->
    <div class="modal confirm-modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3" id="confirmTitle">تأكيد الإجراء</h3>
                <button class="close-btn" id="closeConfirmModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div style="text-align: center; padding: 2rem 0;">
                <div class="confirm-icon" id="confirmIcon">
                    <iconify-icon icon="mdi:alert-circle" style="font-size: 2.5rem;"></iconify-icon>
                </div>
                
                <h4 class="h3" style="margin-bottom: 1rem;" id="confirmAction"></h4>
                <p class="confirm-message" id="confirmMessage">
                    هذا الإجراء لا يمكن التراجع عنه.
                </p>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelActionBtn">
                    إلغاء
                </button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">
                    <iconify-icon icon="mdi:check"></iconify-icon>
                    <span id="confirmActionText">تأكيد</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal settings-modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3">الإعدادات المتقدمة</h3>
                <button class="close-btn" id="closeSettings">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div class="settings-tabs" id="settingsTabs">
                <!-- Tabs will be populated by JavaScript -->
            </div>
            
            <div class="settings-tab-content" id="profileTab">
                <!-- Profile settings will be populated by JavaScript -->
            </div>
            
            <div class="settings-tab-content" id="appearanceTab">
                <!-- Appearance settings will be populated by JavaScript -->
            </div>
            
            <div class="settings-tab-content" id="securityTab">
                <!-- Security settings will be populated by JavaScript -->
            </div>
            
            <div class="settings-tab-content" id="advancedTab">
                <!-- Advanced settings will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal" id="dataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3" id="dataModalTitle">استيراد البيانات</h3>
                <button class="close-btn" id="closeDataModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div id="dataModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        // ===== FIREBASE IMPORTS =====
        import { 
            auth, 
            db,
            onAuthStateChanged,
            doc, 
            setDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            collection,
            query,
            where,
            orderBy,
            getDocs,
            addDoc,
            serverTimestamp,
            signOut,
            updateProfile
        } from './firebase-config.js';

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let userBoards = [];
        let currentEditingBoard = null;
        let boardToDelete = null;
        let currentDeviceId = null;
        let accountRef = null;
        let userSettings = {};
        let securityData = {};
        let userDevices = [];
        let isOwnerDevice = false;
        let deviceStatus = 'active'; // active, pending, blocked
        let isLoading = {
            dashboard: true,
            devices: true,
            activity: true,
            settings: true
        };

        // Icon Categories
        const iconCategories = {
            social: [
                { icon: 'logos:facebook', name: 'Facebook' },
                { icon: 'logos:instagram-icon', name: 'Instagram' },
                { icon: 'logos:telegram', name: 'Telegram' },
                { icon: 'logos:twitter', name: 'Twitter' },
                { icon: 'logos:linkedin-icon', name: 'LinkedIn' },
                { icon: 'logos:discord-icon', name: 'Discord' },
                { icon: 'logos:snapchat', name: 'Snapchat' }
            ],
            google: [
                { icon: 'logos:google-gmail', name: 'Gmail' },
                { icon: 'logos:google-drive', name: 'Google Drive' },
                { icon: 'logos:google', name: 'Google' },
                { icon: 'logos:outlook-icon', name: 'Outlook' }
            ],
            work: [
                { icon: 'logos:github-icon', name: 'GitHub' },
                { icon: 'logos:gitlab', name: 'GitLab' },
                { icon: 'logos:bitbucket', name: 'Bitbucket' },
                { icon: 'logos:slack-icon', name: 'Slack' },
                { icon: 'logos:notion-icon', name: 'Notion' }
            ],
            finance: [
                { icon: 'logos:paypal', name: 'PayPal' },
                { icon: 'logos:visa', name: 'Visa' },
                { icon: 'logos:mastercard', name: 'Mastercard' },
                { icon: 'logos:stripe', name: 'Stripe' }
            ],
            generic: [
                { icon: 'mdi:web', name: 'Website' },
                { icon: 'mdi:lock', name: 'Lock' },
                { icon: 'mdi:key', name: 'Key' },
                { icon: 'mdi:account', name: 'Account' },
                { icon: 'mdi:shield-lock', name: 'Shield' },
                { icon: 'mdi:email', name: 'Email' },
                { icon: 'mdi:cloud', name: 'Cloud' },
                { icon: 'mdi:database', name: 'Database' }
            ]
        };

        // Flatten icons array
        const allIcons = [
            ...iconCategories.social,
            ...iconCategories.google,
            ...iconCategories.work,
            ...iconCategories.finance,
            ...iconCategories.generic
        ];

        // Color options with labels and icons
        const colorOptions = [
            { color: '#2ED3B7', label: 'شخصي', class: 'personal', icon: 'mdi:account' },
            { color: '#4ECDC4', label: 'عمل', class: 'work', icon: 'mdi:briefcase' },
            { color: '#FF6B6B', label: 'مهم', class: 'important', icon: 'mdi:star' },
            { color: '#9D4EDD', label: 'اجتماعي', class: 'social', icon: 'mdi:account-group' },
            { color: '#FFD166', label: 'مالي', class: 'finance', icon: 'mdi:currency-usd' },
            { color: '#118AB2', label: 'أخرى', class: 'other', icon: 'mdi:dots-horizontal' }
        ];

        // Theme options
        const themeOptions = [
            { value: 'light', label: 'فاتح', icon: 'mdi:weather-sunny' },
            { value: 'dark', label: 'داكن', icon: 'mdi:weather-night' },
            { value: 'system', label: 'النظام', icon: 'mdi:laptop' }
        ];

        // Password visibility options
        const passwordVisibilityOptions = [
            { value: 'hold', label: 'الضغط المطول', icon: 'mdi:timer-outline' },
            { value: 'click', label: 'النقر', icon: 'mdi:cursor-click' },
            { value: 'always', label: 'دائماً', icon: 'mdi:eye-outline' }
        ];

        // Category names for filter
        const categoryNames = {
            social: 'اجتماعي',
            google: 'جوجل',
            work: 'عمل',
            finance: 'مالي',
            generic: 'عام'
        };

        // Password strength criteria
        const passwordCriteria = [
            { id: 'length', label: '8 أحرف على الأقل', test: (p) => p.length >= 8, weight: 20 },
            { id: 'lowercase', label: 'حرف صغير', test: (p) => /[a-z]/.test(p), weight: 15 },
            { id: 'uppercase', label: 'حرف كبير', test: (p) => /[A-Z]/.test(p), weight: 15 },
            { id: 'numbers', label: 'رقم', test: (p) => /[0-9]/.test(p), weight: 15 },
            { id: 'special', label: 'رمز خاص', test: (p) => /[^A-Za-z0-9]/.test(p), weight: 15 },
            { id: 'length12', label: '12 حرف أو أكثر', test: (p) => p.length >= 12, weight: 10 },
            { id: 'unique', label: 'أحرف متنوعة', test: (p) => new Set(p).size >= 8, weight: 10 }
        ];

        // Password strength levels
        const passwordStrengthLevels = {
            weak: { threshold: 30, label: 'ضعيف', class: 'strength-weak', icon: 'mdi:alert-circle' },
            medium: { threshold: 60, label: 'متوسط', class: 'strength-medium', icon: 'mdi:shield-half-full' },
            good: { threshold: 80, label: 'جيد', class: 'strength-good', icon: 'mdi:shield' },
            excellent: { threshold: 90, label: 'ممتاز', class: 'strength-excellent', icon: 'mdi:shield-check' }
        };

        // Activity types
        const activityIcons = {
            login: { icon: 'mdi:login', label: 'تسجيل دخول' },
            logout: { icon: 'mdi:logout', label: 'تسجيل خروج' },
            add: { icon: 'mdi:plus', label: 'إضافة حساب' },
            edit: { icon: 'mdi:pencil', label: 'تعديل حساب' },
            delete: { icon: 'mdi:delete', label: 'حذف حساب' },
            copy: { icon: 'mdi:content-copy', label: 'نسخ كلمة مرور' },
            theme: { icon: 'mdi:palette', label: 'تغيير المظهر' },
            device_logout: { icon: 'mdi:device-off', label: 'تسجيل خروج من جهاز' },
            trust: { icon: 'mdi:shield-check', label: 'تعيين جهاز كموثوق' },
            block: { icon: 'mdi:block-helper', label: 'منع جهاز' },
            unblock: { icon: 'mdi:lock-open', label: 'إلغاء منع جهاز' },
            approve: { icon: 'mdi:check-circle', label: 'موافقة على جهاز' },
            import: { icon: 'mdi:import', label: 'استيراد بيانات' },
            export: { icon: 'mdi:export', label: 'تصدير بيانات' }
        };

        const activityDescriptions = {
            login: (details) => `تم تسجيل الدخول ${details.isNewDevice ? 'من جهاز جديد' : ''}`,
            logout: () => 'تم تسجيل الخروج',
            add: (details) => `تم إضافة حساب جديد: ${details.boardName || ''}`,
            edit: (details) => `تم تعديل حساب: ${details.boardName || ''}`,
            delete: (details) => `تم حذف حساب: ${details.boardName || ''}`,
            copy: (details) => `تم نسخ كلمة مرور لحساب: ${details.boardName || ''}`,
            theme: (details) => `تم تغيير المظهر إلى الوضع ${details.theme === 'dark' ? 'الداكن' : 'الفاتح'}`,
            device_logout: (details) => `تم تسجيل الخروج من جهاز: ${details.deviceName || ''}`,
            trust: (details) => `تم ${details.trusted ? 'تعيين' : 'إلغاء'} الثقة في جهاز: ${details.deviceName || ''}`,
            block: (details) => `تم ${details.permanent ? 'منع نهائي' : 'منع مؤقت'} لجهاز: ${details.deviceName || ''}`,
            unblock: (details) => `تم إلغاء منع جهاز: ${details.deviceName || ''}`,
            approve: (details) => `تم الموافقة على جهاز: ${details.deviceName || ''}`,
            import: () => 'تم استيراد البيانات بنجاح',
            export: () => 'تم تصدير البيانات بنجاح'
        };

        // Settings tabs
        const settingsTabs = [
            { id: 'profile', label: 'الملف الشخصي', icon: 'mdi:account-circle' },
            { id: 'appearance', label: 'المظهر', icon: 'mdi:palette' },
            { id: 'security', label: 'الأمان', icon: 'mdi:shield-lock' },
            { id: 'advanced', label: 'متقدم', icon: 'mdi:cog' }
        ];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            setupEventListeners();
            checkAuth();
        });

        // ===== AUTH CHECK =====
        async function checkAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                currentUser = user;
                currentDeviceId = getStableDeviceId();
                await initializeAccount();
                await checkDeviceAccess();
                await loadUserData();
                updateUserUI();
            });
        }

        // ===== ACCOUNT-CENTRIC STRUCTURE =====
        async function initializeAccount() {
            if (!currentUser) return;
            
            accountRef = doc(db, 'accounts', currentUser.uid);
            const accountDoc = await getDoc(accountRef);
            
            if (!accountDoc.exists()) {
                // Create new account with owner set to current device
                await setDoc(accountRef, {
                    profile: {
                        name: currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم',
                        email: currentUser.email,
                        plan: 'مجانية',
                        createdAt: serverTimestamp()
                    },
                    vault: {
                        boards: []
                    },
                    settings: {
                        theme: 'light',
                        passwordVisibility: 'hold',
                        showMigrationSection: true
                    },
                    security: {
                        ownerDeviceId: currentDeviceId,
                        trustedDevices: {
                            [currentDeviceId]: {
                                deviceId: currentDeviceId,
                                trustedAt: serverTimestamp(),
                                trustedBy: currentDeviceId
                            }
                        },
                        blockedDevices: {},
                        pendingDevices: {}
                    },
                    lastUpdated: serverTimestamp()
                });
                
                // Register device as trusted
                await registerOrUpdateDevice(true, true);
                await logActivity('login', { 
                    isNewDevice: true, 
                    isOwner: true,
                    autoTrusted: true 
                });
            } else {
                // Load existing account data
                const data = accountDoc.data();
                userSettings = data.settings || {};
                securityData = data.security || {};
                applyTheme(userSettings.theme || 'light');
                
                // Register/update device
                await registerOrUpdateDevice(false, securityData.ownerDeviceId === currentDeviceId);
                await logActivity('login', { isNewDevice: false });
            }
        }

        // ===== DEVICE ACCESS CONTROL =====
        async function checkDeviceAccess() {
            if (!accountRef || !securityData) return;
            
            const { 
                ownerDeviceId = '', 
                blockedDevices = {}, 
                pendingDevices = {},
                trustedDevices = {}
            } = securityData;
            
            // القاعدة 1: أول جهاز يسجل = owner
            if (!ownerDeviceId) {
                await updateDoc(accountRef, {
                    'security.ownerDeviceId': currentDeviceId,
                    [`security.trustedDevices.${currentDeviceId}`]: {
                        deviceId: currentDeviceId,
                        trustedAt: serverTimestamp(),
                        trustedBy: currentDeviceId
                    }
                }, { merge: true });
                
                securityData.ownerDeviceId = currentDeviceId;
                securityData.trustedDevices = securityData.trustedDevices || {};
                securityData.trustedDevices[currentDeviceId] = {
                    deviceId: currentDeviceId,
                    trustedAt: new Date(),
                    trustedBy: currentDeviceId
                };
                
                isOwnerDevice = true;
                deviceStatus = 'active';
                return;
            }
            
            isOwnerDevice = (ownerDeviceId === currentDeviceId);
            
            if (isOwnerDevice) {
                deviceStatus = 'active';
                hideAccessOverlay();
                return;
            }
            
            if (blockedDevices[currentDeviceId]) {
                deviceStatus = 'blocked';
                showAccessOverlay('blocked', blockedDevices[currentDeviceId]);
                return;
            }
            
            if (trustedDevices && trustedDevices[currentDeviceId]) {
                deviceStatus = 'active';
                hideAccessOverlay();
                return;
            }
            
            if (pendingDevices && pendingDevices[currentDeviceId]) {
                deviceStatus = 'pending';
                showAccessOverlay('pending');
                return;
            }
            
            if (!ownerDeviceId) {
                await updateDoc(accountRef, {
                    'security.ownerDeviceId': currentDeviceId,
                    [`security.trustedDevices.${currentDeviceId}`]: {
                        deviceId: currentDeviceId,
                        trustedAt: serverTimestamp(),
                        trustedBy: currentDeviceId
                    }
                }, { merge: true });
                
                isOwnerDevice = true;
                deviceStatus = 'active';
                hideAccessOverlay();
                await logActivity('login', { 
                    isNewDevice: true, 
                    isOwner: true,
                    failSafeOwner: true 
                });
            } else {
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${currentDeviceId}`]: {
                        deviceId: currentDeviceId,
                        addedAt: serverTimestamp(),
                        deviceName: getDeviceInfo().name
                    }
                }, { merge: true });
                
                deviceStatus = 'pending';
                showAccessOverlay('pending');
                await logActivity('login', { 
                    isNewDevice: true, 
                    status: 'pending',
                    needsApproval: true 
                });
            }
        }

        function showAccessOverlay(type, blockData = null) {
            const overlay = document.getElementById('accessOverlay');
            const message = document.getElementById('accessMessage');
            
            if (!overlay || !message) return;
            
            let title = '';
            let text = '';
            let icon = '';
            let actions = '';
            
            switch(type) {
                case 'blocked':
                    title = '⛔ تم تقييد الوصول من هذا الجهاز';
                    text = 'لأسباب أمنية، لا يمكن استخدام هذا الجهاز للوصول إلى الحساب.';
                    if (blockData?.reason) {
                        text += `<br><br><strong>السبب:</strong> ${blockData.reason}`;
                    }
                    if (blockData?.blockedAt) {
                        const blockedDate = new Date(blockData.blockedAt.seconds * 1000);
                        text += `<br><small>تم التقييد في: ${formatDate(blockedDate)}</small>`;
                    }
                    icon = '<iconify-icon icon="mdi:block-helper" style="font-size: 2.5rem;"></iconify-icon>';
                    actions = `
                        <button class="btn btn-danger" id="blockedLogoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </button>
                    `;
                    break;
                    
                case 'pending':
                    title = '⏳ هذا جهاز جديد';
                    text = 'هذا الجهاز في انتظار موافقة الجهاز الرئيسي للحساب. يمكنك الانتظار أو تسجيل الخروج.';
                    icon = '<iconify-icon icon="mdi:clock-outline" style="font-size: 2.5rem;"></iconify-icon>';
                    actions = `
                        <button class="btn btn-secondary" id="refreshAccessBtn" style="margin-left: 0.5rem;">
                            <iconify-icon icon="mdi:refresh"></iconify-icon>
                            <span>تحديث الحالة</span>
                        </button>
                        <button class="btn btn-danger" id="pendingLogoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </button>
                    `;
                    break;
            }
            
            message.innerHTML = `
                <div class="access-icon ${type}">
                    ${icon}
                </div>
                <h3 class="h3">${title}</h3>
                <p class="body">${text}</p>
                <div class="access-actions">
                    ${actions}
                </div>
            `;
            
            overlay.style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('blockedLogoutBtn')?.addEventListener('click', handleLogout);
                document.getElementById('pendingLogoutBtn')?.addEventListener('click', handleLogout);
                document.getElementById('refreshAccessBtn')?.addEventListener('click', async () => {
                    await checkDeviceAccess();
                    showToast('تم تحديث حالة الجهاز', 'info');
                });
            }, 100);
        }

        function hideAccessOverlay() {
            const overlay = document.getElementById('accessOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ===== DEVICE MANAGEMENT =====
        function getStableDeviceId() {
            let deviceId = localStorage.getItem('novapass_device_id');
            
            if (!deviceId) {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substr(2, 8);
                deviceId = `device_${timestamp}_${random}`;
                localStorage.setItem('novapass_device_id', deviceId);
            }
            
            return deviceId;
        }

        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceName = 'Unknown Device';
            let browser = 'Unknown Browser';
            let os = 'Unknown OS';
            
            if (/mobile/i.test(userAgent)) {
                deviceName = 'هاتف محمول';
            } else if (/tablet/i.test(userAgent)) {
                deviceName = 'تابلت';
            } else {
                deviceName = 'حاسوب';
            }
            
            if (/edg/i.test(userAgent)) {
                browser = 'Microsoft Edge';
            } else if (/chrome/i.test(userAgent) && !/edg/i.test(userAgent)) {
                browser = 'Google Chrome';
            } else if (/firefox/i.test(userAgent)) {
                browser = 'Mozilla Firefox';
            } else if (/safari/i.test(userAgent) && !/chrome/i.test(userAgent)) {
                browser = 'Safari';
            } else if (/opera/i.test(userAgent)) {
                browser = 'Opera';
            }
            
            if (/windows/i.test(userAgent)) {
                os = 'Windows';
            } else if (/macintosh/i.test(userAgent)) {
                os = 'macOS';
            } else if (/linux/i.test(userAgent)) {
                os = 'Linux';
            } else if (/android/i.test(userAgent)) {
                os = 'Android';
            } else if (/iphone|ipad|ipod/i.test(userAgent)) {
                os = 'iOS';
            }
            
            return { 
                name: deviceName, 
                browser, 
                os,
                userAgent: userAgent.substring(0, 100)
            };
        }

        async function registerOrUpdateDevice(isFirstDevice = false, isOwner = false) {
            if (!accountRef) return;
            
            const deviceInfo = getDeviceInfo();
            
            const devicesRef = collection(accountRef, 'devices');
            const deviceDocRef = doc(devicesRef, currentDeviceId);
            
            const deviceData = {
                deviceName: deviceInfo.name,
                browser: deviceInfo.browser,
                os: deviceInfo.os,
                userAgent: deviceInfo.userAgent,
                isCurrent: true,
                trusted: isOwner || isFirstDevice,
                isOwner: isOwner,
                lastActive: serverTimestamp(),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            const deviceDoc = await getDoc(deviceDocRef);
            
            if (deviceDoc.exists()) {
                await updateDoc(deviceDocRef, {
                    ...deviceData,
                    createdAt: deviceDoc.data().createdAt
                });
            } else {
                await setDoc(deviceDocRef, deviceData);
            }
            
            const allDevices = await getDocs(devicesRef);
            allDevices.forEach(async (doc) => {
                if (doc.id !== currentDeviceId) {
                    await updateDoc(doc.ref, {
                        isCurrent: false,
                        updatedAt: serverTimestamp()
                    });
                }
            });
        }

        async function loadDevices() {
            if (!accountRef) return [];
            
            try {
                const devicesRef = collection(accountRef, 'devices');
                const q = query(devicesRef, orderBy('lastActive', 'desc'));
                const snapshot = await getDocs(q);
                
                const devices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    devices.push({
                        id: doc.id,
                        ...data,
                        lastActive: data.lastActive?.toDate?.() || new Date(),
                        createdAt: data.createdAt?.toDate?.() || new Date()
                    });
                });
                
                return devices;
            } catch (error) {
                console.error('Error loading devices:', error);
                showToast('حدث خطأ في تحميل الأجهزة', 'error');
                return [];
            }
        }

        async function updateDeviceStatus(deviceId, updates) {
            try {
                const deviceRef = doc(accountRef, 'devices', deviceId);
                await updateDoc(deviceRef, {
                    ...updates,
                    updatedAt: serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('Error updating device:', error);
                return false;
            }
        }

        // ===== SECURITY MANAGEMENT =====
        async function blockDevice(deviceId, permanent = false, reason = '') {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه منع الأجهزة', 'error');
                return false;
            }
            
            try {
                const blockData = {
                    deviceId,
                    blockedAt: serverTimestamp(),
                    blockedBy: currentDeviceId,
                    permanent,
                    reason: reason || (permanent ? 'منع نهائي' : 'منع مؤقت')
                };
                
                await updateDoc(accountRef, {
                    [`security.blockedDevices.${deviceId}`]: blockData
                }, { merge: true });
                
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await updateDoc(accountRef, {
                    [`security.trustedDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await updateDeviceStatus(deviceId, { 
                    trusted: false,
                    isOwner: false 
                });
                
                await logActivity('block', { 
                    deviceId, 
                    permanent, 
                    reason,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error blocking device:', error);
                return false;
            }
        }

        async function unblockDevice(deviceId) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه إلغاء منع الأجهزة', 'error');
                return false;
            }
            
            try {
                await updateDoc(accountRef, {
                    [`security.blockedDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await logActivity('unblock', { 
                    deviceId,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error unblocking device:', error);
                return false;
            }
        }

        async function approveDevice(deviceId) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه الموافقة على الأجهزة', 'error');
                return false;
            }
            
            try {
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await updateDoc(accountRef, {
                    [`security.trustedDevices.${deviceId}`]: {
                        deviceId,
                        trustedAt: serverTimestamp(),
                        trustedBy: currentDeviceId
                    }
                }, { merge: true });
                
                await updateDeviceStatus(deviceId, { 
                    trusted: true 
                });
                
                await logActivity('approve', { 
                    deviceId,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error approving device:', error);
                return false;
            }
        }

        async function toggleDeviceTrust(deviceId, trusted) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه تغيير حالة الثقة', 'error');
                return false;
            }
            
            try {
                if (trusted) {
                    await updateDoc(accountRef, {
                        [`security.trustedDevices.${deviceId}`]: {
                            deviceId,
                            trustedAt: serverTimestamp(),
                            trustedBy: currentDeviceId
                        }
                    }, { merge: true });
                } else {
                    await updateDoc(accountRef, {
                        [`security.trustedDevices.${deviceId}`]: deleteField()
                    }, { merge: true });
                }
                
                await updateDeviceStatus(deviceId, { trusted });
                
                await logActivity('trust', { 
                    deviceId,
                    trusted,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error toggling device trust:', error);
                return false;
            }
        }

        // ===== ACTIVITY LOGS =====
        async function logActivity(action, details = {}) {
            if (!accountRef) return;
            
            try {
                const logsRef = collection(accountRef, 'activity_logs');
                const deviceInfo = getDeviceInfo();
                
                await addDoc(logsRef, {
                    action,
                    details,
                    deviceId: currentDeviceId,
                    deviceName: deviceInfo.name,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function loadActivityLogs(filter = 'all') {
            if (!accountRef) return [];
            
            try {
                const logsRef = collection(accountRef, 'activity_logs');
                const q = query(logsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                const logs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    logs.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate?.() || new Date()
                    });
                });
                
                if (filter !== 'all') {
                    return logs.filter(log => 
                        (filter === 'security' && ['login', 'logout', 'device_logout', 'trust', 'block', 'unblock', 'approve'].includes(log.action)) ||
                        (filter === 'vault' && ['add', 'edit', 'delete', 'copy', 'import', 'export'].includes(log.action))
                    );
                }
                
                return logs;
            } catch (error) {
                console.error('Error loading activity logs:', error);
                showToast('حدث خطأ في تحميل سجلات النشاط', 'error');
                return [];
            }
        }

        // ===== UI INITIALIZATION =====
        function initializeUI() {
            setupIconCategories();
            populateIconGrid();
            setupColorSelector();
            setupPasswordStrength();
            setupThemeSelector();
            setupPasswordVisibilitySelector();
            setupSettingsTabs();
        }

        function setupIconCategories() {
            const categoriesContainer = document.getElementById('iconCategories');
            if (!categoriesContainer) return;
            
            categoriesContainer.innerHTML = '';
            
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn active';
            allBtn.textContent = 'الكل';
            allBtn.setAttribute('data-category', 'all');
            allBtn.addEventListener('click', (e) => filterIconsByCategory('all', e.target));
            categoriesContainer.appendChild(allBtn);
            
            Object.keys(categoryNames).forEach(categoryKey => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = categoryNames[categoryKey];
                btn.setAttribute('data-category', categoryKey);
                btn.addEventListener('click', (e) => filterIconsByCategory(categoryKey, e.target));
                categoriesContainer.appendChild(btn);
            });
        }

        function populateIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            if (!iconGrid) return;
            
            iconGrid.innerHTML = '';
            
            allIcons.forEach((iconData, index) => {
                const iconElement = createIconElement(iconData, index === 0);
                iconGrid.appendChild(iconElement);
            });
        }

        function createIconElement(iconData, isSelected = false) {
            const iconElement = document.createElement('div');
            iconElement.className = `icon-option ${isSelected ? 'selected' : ''}`;
            iconElement.setAttribute('data-icon', iconData.icon);
            iconElement.setAttribute('data-name', iconData.name);
            iconElement.setAttribute('title', iconData.name);
            
            let category = 'generic';
            if (iconCategories.social.includes(iconData)) category = 'social';
            else if (iconCategories.google.includes(iconData)) category = 'google';
            else if (iconCategories.work.includes(iconData)) category = 'work';
            else if (iconCategories.finance.includes(iconData)) category = 'finance';
            
            iconElement.setAttribute('data-category', category);
            
            try {
                iconElement.innerHTML = `<iconify-icon icon="${iconData.icon}"></iconify-icon>`;
            } catch (error) {
                iconElement.innerHTML = `<iconify-icon icon="mdi:web"></iconify-icon>`;
            }
            
            iconElement.addEventListener('click', () => {
                selectIcon(iconElement);
            });
            
            return iconElement;
        }

        function filterIconsByCategory(category, button) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            const iconOptions = document.querySelectorAll('.icon-option');
            iconOptions.forEach(icon => {
                if (category === 'all') {
                    icon.style.display = 'flex';
                } else {
                    icon.style.display = icon.getAttribute('data-category') === category ? 'flex' : 'none';
                }
            });
        }

        function setupColorSelector() {
            const colorSelector = document.getElementById('colorSelector');
            if (!colorSelector) return;
            
            colorSelector.innerHTML = '';
            
            colorOptions.forEach((colorData, index) => {
                const colorElement = document.createElement('div');
                colorElement.className = 'radio-option';
                
                colorElement.innerHTML = `
                    <div class="radio-circle" style="background: ${colorData.color};" 
                         data-color="${colorData.color}" 
                         data-class="${colorData.class}"
                         data-label="${colorData.label}"
                         title="${colorData.label}">
                        <iconify-icon icon="${colorData.icon}"></iconify-icon>
                    </div>
                    <span class="radio-label">${colorData.label}</span>
                `;
                
                const radioCircle = colorElement.querySelector('.radio-circle');
                radioCircle.addEventListener('click', () => {
                    selectColor(radioCircle);
                });
                
                if (index === 0) {
                    radioCircle.classList.add('selected');
                }
                
                colorSelector.appendChild(colorElement);
            });
        }

        function setupPasswordStrength() {
            const passwordInput = document.getElementById('boardPassword');
            if (!passwordInput) return;
            
            passwordInput.addEventListener('input', updatePasswordStrength);
            updatePasswordStrength();
        }

        function updatePasswordStrength() {
            const password = document.getElementById('boardPassword').value;
            const strengthFill = document.getElementById('strengthFill');
            const strengthDetails = document.getElementById('strengthDetails');
            const strengthScore = document.getElementById('strengthScore');
            
            if (!strengthFill || !strengthDetails || !strengthScore) return;
            
            let totalScore = 0;
            let totalWeight = 0;
            
            const criteriaResults = passwordCriteria.map(criteria => {
                const passes = criteria.test(password);
                const score = passes ? criteria.weight : 0;
                totalScore += score;
                totalWeight += criteria.weight;
                
                return {
                    ...criteria,
                    passes,
                    score
                };
            });
            
            const lengthBonus = Math.min(password.length * 2, 20);
            totalScore += lengthBonus;
            totalWeight += 20;
            
            const percentage = Math.min(Math.round((totalScore / totalWeight) * 100), 100);
            
            strengthFill.style.width = `${percentage}%`;
            strengthScore.textContent = `${percentage}%`;
            
            strengthDetails.innerHTML = '';
            criteriaResults.forEach(criteria => {
                const criteriaElement = document.createElement('div');
                criteriaElement.className = `strength-criteria ${criteria.passes ? 'valid' : ''}`;
                criteriaElement.innerHTML = `
                    <iconify-icon icon="${criteria.passes ? 'mdi:check-circle' : 'mdi:close-circle'}"></iconify-icon>
                    <span>${criteria.label}</span>
                `;
                strengthDetails.appendChild(criteriaElement);
            });
            
            const lengthElement = document.createElement('div');
            lengthElement.className = 'strength-criteria valid';
            lengthElement.innerHTML = `
                <iconify-icon icon="mdi:check-circle"></iconify-icon>
                <span>${password.length} حرف (${lengthBonus}%)</span>
            `;
            strengthDetails.appendChild(lengthElement);
        }

        function setupThemeSelector() {
            const themeSelector = document.getElementById('themeSelector');
            if (!themeSelector) return;
            
            themeSelector.innerHTML = '';
            
            themeOptions.forEach(theme => {
                const option = document.createElement('div');
                option.className = 'segmented-option';
                option.setAttribute('data-theme', theme.value);
                option.innerHTML = `
                    <iconify-icon icon="${theme.icon}"></iconify-icon>
                    <span>${theme.label}</span>
                `;
                
                option.addEventListener('click', () => {
                    selectTheme(option);
                });
                
                themeSelector.appendChild(option);
                
                if (theme.value === (userSettings.theme || 'light')) {
                    option.classList.add('selected');
                }
            });
        }

        function setupPasswordVisibilitySelector() {
            const selector = document.getElementById('passwordVisibilitySelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            
            passwordVisibilityOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'segmented-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.innerHTML = `
                    <iconify-icon icon="${option.icon}"></iconify-icon>
                    <span>${option.label}</span>
                `;
                
                optionElement.addEventListener('click', () => {
                    selectPasswordVisibility(optionElement);
                });
                
                selector.appendChild(optionElement);
                
                if (option.value === (userSettings.passwordVisibility || 'hold')) {
                    optionElement.classList.add('selected');
                }
            });
        }

        function setupSettingsTabs() {
            const tabsContainer = document.getElementById('settingsTabs');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = settingsTabs.map((tab, index) => `
                <button class="settings-tab ${index === 0 ? 'active' : ''}" 
                        data-tab="${tab.id}">
                    <iconify-icon icon="${tab.icon}"></iconify-icon>
                    <span>${tab.label}</span>
                </button>
            `).join('');
            
            // Add event listeners for tabs
            tabsContainer.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchSettingsTab(tabId);
                });
            });
        }

        // ===== THEME MANAGEMENT =====
        function applyTheme(theme) {
            let isDark = false;
            
            if (theme === 'system') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = theme === 'dark';
            }
            
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('novapass_theme', theme);
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Navigation Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const sectionId = e.currentTarget.getAttribute('data-section');
                    showSection(sectionId);
                    
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    e.currentTarget.classList.add('active');
                });
            });
            
            // Profile dropdown navigation
            document.querySelectorAll('.dropdown-item[data-section]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.currentTarget.getAttribute('data-section');
                    showSection(sectionId);
                    
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.getAttribute('data-section') === sectionId) {
                            tab.classList.add('active');
                        }
                    });
                    
                    closeProfileDropdown();
                });
            });
            
            // Floating add button
            document.getElementById('floatingAddBtn')?.addEventListener('click', () => openBoardModal('add'));
            document.getElementById('firstBoardBtn')?.addEventListener('click', () => openBoardModal('add'));
            
            // Profile dropdown
            document.getElementById('profileBtn')?.addEventListener('click', toggleProfileDropdown);
            document.addEventListener('click', closeProfileDropdown);
            
            // Icon search
            document.getElementById('iconSearch')?.addEventListener('input', searchIcons);
            
            // Modals
            document.getElementById('closeModal')?.addEventListener('click', closeAllModals);
            document.getElementById('cancelBtn')?.addEventListener('click', closeAllModals);
            document.getElementById('closeConfirmModal')?.addEventListener('click', closeAllModals);
            document.getElementById('cancelActionBtn')?.addEventListener('click', closeAllModals);
            document.getElementById('closeSettings')?.addEventListener('click', closeAllModals);
            document.getElementById('closeDataModal')?.addEventListener('click', closeAllModals);
            
            // Board form
            document.getElementById('boardForm')?.addEventListener('submit', handleBoardSubmit);
            
            // Settings
            document.getElementById('settingsBtn')?.addEventListener('click', openSettingsModal);
            document.getElementById('logoutBtn')?.addEventListener('click', () => confirmLogout());
            document.getElementById('logoutSettingsBtn')?.addEventListener('click', () => confirmLogout());
            document.getElementById('editNameBtn')?.addEventListener('click', editUserName);
            
            // Data migration
            document.getElementById('importDataBtn')?.addEventListener('click', openImportModal);
            document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
            
            // Confirm action
            document.getElementById('confirmActionBtn')?.addEventListener('click', handleConfirmAction);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAllModals();
                if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    openBoardModal('add');
                }
            });
            
            // System theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (userSettings.theme === 'system') {
                    applyTheme('system');
                }
            });
        }

        function searchIcons(e) {
            const searchTerm = e.target.value.toLowerCase();
            const iconOptions = document.querySelectorAll('.icon-option');
            
            iconOptions.forEach(icon => {
                const iconName = icon.getAttribute('data-name').toLowerCase();
                if (iconName.includes(searchTerm)) {
                    icon.style.display = 'flex';
                } else {
                    icon.style.display = 'none';
                }
            });
        }

        // ===== SECTION MANAGEMENT =====
        function showSection(sectionId) {
            if (deviceStatus !== 'active' && sectionId !== 'dashboardSection') {
                showToast('الجهاز غير نشط حالياً', 'error');
                return;
            }
            
            hideAccessOverlay();
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                updateNavLabel(sectionId);
                
                switch(sectionId) {
                    case 'devicesSection':
                        loadAndRenderDevices();
                        break;
                    case 'activitySection':
                        loadAndRenderActivityLogs();
                        setupActivityFilters();
                        break;
                    case 'settingsSection':
                        loadAndRenderSettings();
                        break;
                }
            }
            
            const floatingBtn = document.getElementById('floatingAddBtn');
            if (floatingBtn) {
                floatingBtn.style.display = sectionId === 'dashboardSection' && deviceStatus === 'active' ? 'flex' : 'none';
            }
        }

        function updateNavLabel(sectionId) {
            const label = document.getElementById('dashboardLabel');
            switch(sectionId) {
                case 'devicesSection': label.textContent = 'الأجهزة'; break;
                case 'activitySection': label.textContent = 'سجلات النشاط'; break;
                case 'settingsSection': label.textContent = 'الإعدادات'; break;
                default: label.textContent = 'Dashboard';
            }
        }

        // ===== PROFILE DROPDOWN =====
        function toggleProfileDropdown(e) {
            e?.stopPropagation();
            document.getElementById('profileDropdown')?.classList.toggle('active');
        }

        function closeProfileDropdown(e) {
            if (!e?.target.closest('.user-profile')) {
                document.getElementById('profileDropdown')?.classList.remove('active');
            }
        }

        // ===== MODAL MANAGEMENT =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            resetBoardForm();
        }

        function openBoardModal(mode, board = null) {
            const modal = document.getElementById('boardModal');
            const title = document.getElementById('modalTitle');
            
            if (!modal || !title) return;
            
            if (mode === 'edit' && board) {
                title.textContent = 'تعديل الحساب';
                document.getElementById('boardId').value = board.id;
                document.getElementById('boardName').value = board.name;
                document.getElementById('boardEmail').value = board.email;
                document.getElementById('boardPassword').value = board.password;
                updatePasswordStrength();
                
                const iconToSelect = document.querySelector(`.icon-option[data-icon="${board.icon}"]`);
                if (iconToSelect) {
                    document.querySelectorAll('.icon-option').forEach(icon => icon.classList.remove('selected'));
                    iconToSelect.classList.add('selected');
                }
                
                const colorToSelect = document.querySelector(`.radio-circle[data-color="${board.color}"]`);
                if (colorToSelect) {
                    document.querySelectorAll('.radio-circle').forEach(circle => circle.classList.remove('selected'));
                    colorToSelect.classList.add('selected');
                }
                
                currentEditingBoard = board.id;
            } else {
                title.textContent = 'إضافة حساب جديد';
                currentEditingBoard = null;
            }
            
            openModal('boardModal');
            document.getElementById('boardName').focus();
        }

        function resetBoardForm() {
            const boardForm = document.getElementById('boardForm');
            if (boardForm) {
                boardForm.reset();
                document.getElementById('boardId').value = '';
                document.getElementById('iconSearch').value = '';
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.category-btn[data-category="all"]').classList.add('active');
                showAllIcons();
                currentEditingBoard = null;
                updatePasswordStrength();
            }
        }

        function showAllIcons() {
            const iconOptions = document.querySelectorAll('.icon-option');
            iconOptions.forEach(icon => {
                icon.style.display = 'flex';
            });
        }

        // ===== CONFIRMATION MODAL =====
        let pendingAction = null;
        let pendingActionData = null;

        function showConfirmationModal(type, data = {}) {
            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmTitle');
            const action = document.getElementById('confirmAction');
            const message = document.getElementById('confirmMessage');
            const icon = document.getElementById('confirmIcon');
            const actionText = document.getElementById('confirmActionText');
            const actionBtn = document.getElementById('confirmActionBtn');
            
            if (!modal) return;
            
            pendingAction = type;
            pendingActionData = data;
            
            switch(type) {
                case 'delete':
                    title.textContent = 'تأكيد الحذف';
                    action.textContent = `حذف ${data.boardName}`;
                    message.textContent = `سيتم حذف حساب "${data.boardName}" نهائياً. لا يمكن التراجع عن هذا الإجراء.`;
                    icon.className = 'confirm-icon delete';
                    icon.innerHTML = '<iconify-icon icon="mdi:delete" style="font-size: 2.5rem;"></iconify-icon>';
                    actionText.textContent = 'نعم، احذف';
                    actionBtn.className = 'btn btn-danger';
                    break;
                    
                case 'logout':
                    title.textContent = 'تأكيد تسجيل الخروج';
                    action.textContent = 'تسجيل الخروج';
                    message.textContent = 'سيتم تسجيل خروجك من جميع الأجهزة. هل أنت متأكد؟';
                    icon.className = 'confirm-icon logout';
                    icon.innerHTML = '<iconify-icon icon="mdi:logout" style="font-size: 2.5rem;"></iconify-icon>';
                    actionText.textContent = 'نعم، سجل الخروج';
                    actionBtn.className = 'btn btn-danger';
                    break;
                    
                case 'block':
                    title.textContent = 'تأكيد المنع';
                    action.textContent = `منع ${data.deviceName}`;
                    message.textContent = `سيتم منع الجهاز "${data.deviceName}" من الوصول إلى الحساب.`;
                    icon.className = 'confirm-icon block';
                    icon.innerHTML = '<iconify-icon icon="mdi:block-helper" style="font-size: 2.5rem;"></iconify-icon>';
                    actionText.textContent = 'نعم، امنع';
                    actionBtn.className = 'btn btn-danger';
                    break;
            }
            
            openModal('confirmModal');
        }

        async function handleConfirmAction() {
            if (!pendingAction || !pendingActionData) return;
            
            try {
                switch(pendingAction) {
                    case 'delete':
                        await deleteBoard(pendingActionData.boardId);
                        break;
                    case 'logout':
                        await handleLogout();
                        break;
                    case 'block':
                        await blockDevice(pendingActionData.deviceId, false, 'حظر يدوي');
                        loadAndRenderDevices();
                        break;
                }
                
                closeAllModals();
                pendingAction = null;
                pendingActionData = null;
            } catch (error) {
                console.error('Error executing action:', error);
                showToast('حدث خطأ أثناء تنفيذ الإجراء', 'error');
            }
        }

        function confirmLogout() {
            showConfirmationModal('logout', {});
        }

        // ===== SETTINGS MODAL =====
        function openSettingsModal() {
            if (!currentUser) {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            updateSettingsUI();
            openModal('settingsModal');
            switchSettingsTab('profile');
        }

        function switchSettingsTab(tabId) {
            // Update tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(`${tabId}Tab`);
            if (tabContent) {
                tabContent.classList.add('active');
                renderSettingsTab(tabId);
            }
        }

        function renderSettingsTab(tabId) {
            const tabContent = document.getElementById(`${tabId}Tab`);
            if (!tabContent) return;
            
            switch(tabId) {
                case 'profile':
                    renderProfileTab(tabContent);
                    break;
                case 'appearance':
                    renderAppearanceTab(tabContent);
                    break;
                case 'security':
                    renderSecurityTab(tabContent);
                    break;
                case 'advanced':
                    renderAdvancedTab(tabContent);
                    break;
            }
        }

        function renderProfileTab(container) {
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            const email = currentUser.email || 'غير محدد';
            const createdAt = userSettings.createdAt ? formatDate(userSettings.createdAt.toDate()) : formatDate(new Date());
            
            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:account-circle"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">معلومات الحساب</h4>
                            <p class="settings-card-description">إدارة معلومات ملفك الشخصي</p>
                        </div>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الاسم الكامل</span>
                                <span class="settings-description">اسمك المعروض في التطبيق</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span id="profileName">${displayName}</span>
                                <button class="action-btn edit" id="editProfileNameBtn">
                                    <iconify-icon icon="mdi:pencil"></iconify-icon>
                                    <span>تعديل</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">البريد الإلكتروني</span>
                                <span class="settings-description">البريد الإلكتروني المرتبط بالحساب</span>
                            </div>
                            <span id="profileEmail">${email}</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">تاريخ الإنشاء</span>
                                <span class="settings-description">تاريخ إنشاء حسابك في NovaPass</span>
                            </div>
                            <span id="profileCreatedAt">${createdAt}</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الخطة الحالية</span>
                                <span class="settings-description">استمتع بميزات NovaPass الأساسية</span>
                            </div>
                            <span class="plan-badge" id="profilePlan">${userSettings.plan || 'مجانية'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.querySelector('#editProfileNameBtn')?.addEventListener('click', editUserName);
        }

        function renderAppearanceTab(container) {
            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:palette"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">المظهر</h4>
                            <p class="settings-card-description">خصّص مظهر التطبيق حسب تفضيلاتك</p>
                        </div>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الوضع</span>
                                <span class="settings-description">اختر المظهر المناسب لك</span>
                            </div>
                            <div class="segmented-control" id="themeSelectorTab">
                                ${themeOptions.map(theme => `
                                    <div class="segmented-option ${theme.value === (userSettings.theme || 'light') ? 'selected' : ''}" 
                                         data-theme="${theme.value}">
                                        <iconify-icon icon="${theme.icon}"></iconify-icon>
                                        <span>${theme.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">كثافة الواجهة</span>
                                <span class="settings-description">تحكم في المسافات بين العناصر</span>
                            </div>
                            <select class="form-control" style="width: auto;" id="densitySelector">
                                <option value="comfortable">مريح</option>
                                <option value="compact">مضغوط</option>
                                <option value="spacious">واسع</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for theme selector
            container.querySelectorAll('#themeSelectorTab .segmented-option').forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-theme');
                    selectTheme(option);
                });
            });
        }

        function renderSecurityTab(container) {
            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:shield-lock"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">الأمان</h4>
                            <p class="settings-card-description">إدارة إعدادات الأمان والخصوصية</p>
                        </div>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">جلسة المستخدم</span>
                                <span class="settings-description">حالة الاتصال الحالية</span>
                            </div>
                            <span class="caption" style="color: var(--success); display: flex; align-items: center; gap: 0.25rem;">
                                <iconify-icon icon="mdi:check-circle"></iconify-icon>
                                نشط
                            </span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">إظهار كلمة المرور</span>
                                <span class="settings-description">طريقة إظهار كلمات المرور</span>
                            </div>
                            <div class="segmented-control" id="passwordVisibilitySelectorTab">
                                ${passwordVisibilityOptions.map(option => `
                                    <div class="segmented-option ${option.value === (userSettings.passwordVisibility || 'hold') ? 'selected' : ''}" 
                                         data-value="${option.value}">
                                        <iconify-icon icon="${option.icon}"></iconify-icon>
                                        <span>${option.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">جلسات الدخول النشطة</span>
                                <span class="settings-description">إدارة جميع جلسات الدخول</span>
                            </div>
                            <button class="action-btn" onclick="showSection('devicesSection'); closeAllModals();">
                                <iconify-icon icon="mdi:devices"></iconify-icon>
                                <span>عرض الأجهزة</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for password visibility selector
            container.querySelectorAll('#passwordVisibilitySelectorTab .segmented-option').forEach(option => {
                option.addEventListener('click', () => {
                    const value = option.getAttribute('data-value');
                    selectPasswordVisibility(option);
                });
            });
        }

        function renderAdvancedTab(container) {
            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:cog"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">ميزات متقدمة</h4>
                            <p class="settings-card-description">إعدادات إضافية وميزات متقدمة</p>
                        </div>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">نسخة احتياطية</span>
                                <span class="settings-description">قم بعمل نسخة احتياطية من بياناتك</span>
                            </div>
                            <button class="action-btn" id="backupDataBtn">
                                <iconify-icon icon="mdi:download"></iconify-icon>
                                <span>تحميل النسخة</span>
                            </button>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">استيراد البيانات</span>
                                <span class="settings-description">استورد بيانات من مدير كلمات مرور آخر</span>
                            </div>
                            <button class="action-btn" id="importDataBtnAdvanced">
                                <iconify-icon icon="mdi:import"></iconify-icon>
                                <span>استيراد</span>
                            </button>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">مسح البيانات</span>
                                <span class="settings-description">احذف جميع البيانات المخزنة محلياً</span>
                            </div>
                            <button class="action-btn delete" id="clearDataBtn">
                                <iconify-icon icon="mdi:delete"></iconify-icon>
                                <span>مسح</span>
                            </button>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">سجلات التصحيح</span>
                                <span class="settings-description">سجلات النظام والأخطاء</span>
                            </div>
                            <button class="action-btn" id="debugLogsBtn">
                                <iconify-icon icon="mdi:bug"></iconify-icon>
                                <span>عرض السجلات</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for advanced settings
            container.querySelector('#backupDataBtn')?.addEventListener('click', exportData);
            container.querySelector('#importDataBtnAdvanced')?.addEventListener('click', openImportModal);
            container.querySelector('#clearDataBtn')?.addEventListener('click', clearLocalData);
            container.querySelector('#debugLogsBtn')?.addEventListener('click', showDebugLogs);
        }

        function updateSettingsUI() {
            if (!currentUser) return;
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            const email = currentUser.email || 'غير محدد';
            const createdAt = userSettings.createdAt ? formatDate(userSettings.createdAt.toDate()) : formatDate(new Date());
            
            document.getElementById('settingsName').textContent = displayName;
            document.getElementById('settingsEmail').textContent = email;
            document.getElementById('settingsCreatedAt').textContent = createdAt;
            
            const plan = userSettings.plan || 'مجانية';
            document.getElementById('currentPlan').textContent = plan;
            document.getElementById('currentPlan').className = `plan-badge ${plan === 'مجانية' ? '' : 'pro'}`;
            
            document.getElementById('boardsLimit').textContent = plan === 'مجانية' ? '10 حسابات' : 'غير محدود';
        }

        function editUserName() {
            const currentName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            const newName = prompt('أدخل اسمك الجديد:', currentName);
            
            if (newName && newName.trim() && newName !== currentName) {
                const trimmedName = newName.trim();
                updateUserName(trimmedName);
            }
        }

        async function updateUserName(name) {
            try {
                await updateProfile(currentUser, {
                    displayName: name
                });
                
                await updateDoc(accountRef, {
                    'profile.name': name,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                updateUserUI();
                showToast('تم تحديث الاسم بنجاح', 'success');
            } catch (error) {
                console.error('Error updating name:', error);
                showToast('حدث خطأ أثناء تحديث الاسم', 'error');
            }
        }

        function selectTheme(option) {
            const theme = option.getAttribute('data-theme');
            
            option.parentElement.querySelectorAll('.segmented-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            applyTheme(theme);
            
            userSettings.theme = theme;
            updateSettings();
            
            logActivity('theme', { theme });
            showToast('تم تغيير المظهر بنجاح', 'success');
        }

        function selectPasswordVisibility(option) {
            const value = option.getAttribute('data-value');
            
            option.parentElement.querySelectorAll('.segmented-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            userSettings.passwordVisibility = value;
            updateSettings();
            showToast('تم حفظ التفضيل', 'success');
        }

        async function updateSettings() {
            if (!accountRef) return;
            
            try {
                await updateDoc(accountRef, {
                    settings: userSettings,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error updating settings:', error);
            }
        }

        // ===== DATA MIGRATION =====
        function openImportModal() {
            const modal = document.getElementById('dataModal');
            const title = document.getElementById('dataModalTitle');
            const content = document.getElementById('dataModalContent');
            
            if (!modal || !title || !content) return;
            
            title.textContent = 'استيراد البيانات';
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">اختر ملف البيانات (JSON)</label>
                    <input type="file" id="dataFileInput" class="form-control" accept=".json" />
                    <p class="body-sm" style="color: var(--text-muted); margin-top: 0.5rem;">
                        يجب أن يكون الملف بتنسيق JSON صالح ويحتوي على مصفوفة من الحسابات.
                    </p>
                </div>
                
                <div class="preview-container" id="importPreview" style="display: none; margin-top: 1.5rem;"></div>
                
                <div class="modal-actions" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAllModals()">
                        إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" id="importDataConfirmBtn" disabled>
                        <iconify-icon icon="mdi:import"></iconify-icon>
                        <span>استيراد البيانات</span>
                    </button>
                </div>
            `;
            
            openModal('dataModal');
            
            // Add event listeners
            setTimeout(() => {
                const fileInput = document.getElementById('dataFileInput');
                const importBtn = document.getElementById('importDataConfirmBtn');
                const preview = document.getElementById('importPreview');
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        previewData(file, preview);
                        importBtn.disabled = false;
                    }
                });
                
                importBtn.addEventListener('click', () => {
                    importData(fileInput.files[0]);
                });
            }, 100);
        }

        function previewData(file, previewContainer) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        previewContainer.innerHTML = `
                            <h4 class="h4" style="margin-bottom: 1rem;">معاينة البيانات</h4>
                            <p class="body-sm">تم العثور على ${data.length} حساب</p>
                            <div style="margin-top: 1rem;">
                                ${data.slice(0, 5).map((item, index) => `
                                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                                        <div style="font-weight: 500;">${item.name || 'غير معروف'}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${item.email || 'لا يوجد بريد'}</div>
                                    </div>
                                `).join('')}
                                ${data.length > 5 ? `
                                    <div style="padding: 0.5rem; text-align: center; color: var(--text-muted);">
                                        و ${data.length - 5} حساب إضافي...
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        previewContainer.style.display = 'block';
                    } else {
                        previewContainer.innerHTML = '<p style="color: var(--danger);">تنسيق الملف غير صالح. يجب أن يحتوي على مصفوفة.</p>';
                        previewContainer.style.display = 'block';
                    }
                } catch (error) {
                    previewContainer.innerHTML = `<p style="color: var(--danger);">خطأ في قراءة الملف: ${error.message}</p>`;
                    previewContainer.style.display = 'block';
                }
            };
            
            reader.readAsText(file);
        }

        async function importData(file) {
            if (!file) {
                showToast('الرجاء اختيار ملف', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        showToast('تنسيق الملف غير صالح', 'error');
                        return;
                    }
                    
                    // Validate and prepare data
                    const validBoards = data.filter(item => 
                        item.name && item.email && item.password
                    ).map(item => ({
                        id: generateId(),
                        name: item.name,
                        email: item.email,
                        password: item.password,
                        icon: item.icon || 'mdi:web',
                        color: item.color || '#2ED3B7',
                        colorClass: item.colorClass || 'personal',
                        colorLabel: item.colorLabel || 'شخصي',
                        updatedAt: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    }));
                    
                    if (validBoards.length === 0) {
                        showToast('لم يتم العثور على بيانات صالحة', 'error');
                        return;
                    }
                    
                    // Add to existing boards
                    userBoards = [...userBoards, ...validBoards];
                    
                    // Update Firebase
                    await updateDoc(accountRef, {
                        'vault.boards': userBoards,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    // Log activity
                    await logActivity('import', { count: validBoards.length });
                    
                    // Hide migration section if it was shown
                    await updateDoc(accountRef, {
                        'settings.showMigrationSection': false
                    }, { merge: true });
                    
                    // Update UI
                    renderBoards();
                    closeAllModals();
                    showToast(`تم استيراد ${validBoards.length} حساب بنجاح`, 'success');
                    
                } catch (error) {
                    console.error('Error importing data:', error);
                    showToast('حدث خطأ أثناء استيراد البيانات', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function exportData() {
            try {
                const data = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    count: userBoards.length,
                    boards: userBoards.map(board => ({
                        name: board.name,
                        email: board.email,
                        password: board.password,
                        icon: board.icon,
                        color: board.color,
                        colorClass: board.colorClass,
                        colorLabel: board.colorLabel,
                        createdAt: board.createdAt,
                        updatedAt: board.updatedAt
                    }))
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `novapass-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logActivity('export', { count: userBoards.length });
                showToast(`تم تصدير ${userBoards.length} حساب بنجاح`, 'success');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('حدث خطأ أثناء تصدير البيانات', 'error');
            }
        }

        function clearLocalData() {
            if (confirm('هل تريد مسح جميع البيانات المخزنة محلياً؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                localStorage.clear();
                showToast('تم مسح البيانات المحلية', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        function showDebugLogs() {
            const logs = [
                `User: ${currentUser?.email || 'غير معروف'}`,
                `Device: ${currentDeviceId}`,
                `Is Owner: ${isOwnerDevice}`,
                `Boards Count: ${userBoards.length}`,
                `Devices Count: ${userDevices.length}`,
                `Theme: ${userSettings.theme || 'light'}`,
                `Last Login: ${new Date().toLocaleString('ar-SA')}`
            ];
            
            alert('سجلات التصحيح:\n\n' + logs.join('\n'));
        }

        // ===== UI RENDERING =====
        async function loadUserData() {
            if (!accountRef) return;
            
            try {
                isLoading.dashboard = true;
                renderLoadingState('dashboard');
                
                const accountDoc = await getDoc(accountRef);
                if (accountDoc.exists()) {
                    const data = accountDoc.data();
                    userBoards = data.vault?.boards || [];
                    userSettings = data.settings || {};
                    securityData = data.security || {};
                    
                    // Show/hide migration section
                    const migrationSection = document.getElementById('migrationSection');
                    if (migrationSection) {
                        migrationSection.style.display = userSettings.showMigrationSection && userBoards.length === 0 ? 'block' : 'none';
                    }
                    
                    renderBoards();
                    isLoading.dashboard = false;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('حدث خطأ في تحميل البيانات', 'error');
                renderErrorState('dashboard');
                isLoading.dashboard = false;
            }
        }

        function renderLoadingState(section) {
            switch(section) {
                case 'dashboard':
                    const boardsContainer = document.getElementById('boardsContainer');
                    if (boardsContainer) {
                        boardsContainer.innerHTML = `
                            <div class="board-card loading">
                                <div class="card-header">
                                    <div class="skeleton-circle skeleton"></div>
                                    <div style="flex: 1;">
                                        <div class="skeleton-text skeleton" style="width: 70%;"></div>
                                        <div class="skeleton-text skeleton" style="width: 50%;"></div>
                                    </div>
                                </div>
                                <div class="password-section">
                                    <div class="skeleton-text skeleton" style="width: 40%;"></div>
                                    <div class="skeleton-text skeleton" style="height: 48px;"></div>
                                    <div class="skeleton-text skeleton" style="width: 60%; margin-top: 1rem;"></div>
                                </div>
                                <div class="card-footer">
                                    <div class="skeleton-text skeleton" style="flex: 1; height: 40px;"></div>
                                    <div class="skeleton-text skeleton" style="flex: 1; height: 40px;"></div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'devices':
                    const devicesList = document.getElementById('devicesList');
                    if (devicesList) {
                        devicesList.innerHTML = `
                            <div class="device-card loading">
                                <div class="device-icon">
                                    <div class="skeleton skeleton-circle"></div>
                                </div>
                                <div class="device-info">
                                    <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 0.5rem;"></div>
                                    <div class="skeleton skeleton-text" style="width: 40%; height: 1rem;"></div>
                                </div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'activity':
                    const activityTimeline = document.getElementById('activityTimeline');
                    if (activityTimeline) {
                        activityTimeline.innerHTML = `
                            <div class="activity-day-group">
                                <div class="day-header">
                                    <div class="skeleton skeleton-text" style="width: 120px; height: 1.5rem;"></div>
                                </div>
                                <div class="activity-items">
                                    <div class="activity-item">
                                        <div class="activity-icon">
                                            <div class="skeleton skeleton-circle" style="width: 40px; height: 40px;"></div>
                                        </div>
                                        <div class="activity-content">
                                            <div class="skeleton skeleton-text" style="width: 70%; height: 1.25rem; margin-bottom: 0.5rem;"></div>
                                            <div class="skeleton skeleton-text" style="width: 50%; height: 1rem;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    break;
            }
        }

        function renderErrorState(section) {
            switch(section) {
                case 'dashboard':
                    const boardsContainer = document.getElementById('boardsContainer');
                    if (boardsContainer) {
                        boardsContainer.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <iconify-icon icon="mdi:alert-circle"></iconify-icon>
                                </div>
                                <h3 class="h3">حدث خطأ في التحميل</h3>
                                <p class="body">
                                    تعذر تحميل البيانات. يرجى المحاولة مرة أخرى لاحقاً.
                                </p>
                                <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 1.5rem;">
                                    <iconify-icon icon="mdi:refresh"></iconify-icon>
                                    <span>إعادة المحاولة</span>
                                </button>
                            </div>
                        `;
                    }
                    break;
                    
                case 'devices':
                    const devicesList = document.getElementById('devicesList');
                    if (devicesList) {
                        devicesList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <iconify-icon icon="mdi:alert-circle"></iconify-icon>
                                </div>
                                <h3 class="h3">حدث خطأ في التحميل</h3>
                                <p class="body">
                                    تعذر تحميل قائمة الأجهزة. يرجى المحاولة مرة أخرى لاحقاً.
                                </p>
                                <button class="btn btn-primary" onclick="loadAndRenderDevices()" style="margin-top: 1.5rem;">
                                    <iconify-icon icon="mdi:refresh"></iconify-icon>
                                    <span>إعادة المحاولة</span>
                                </button>
                            </div>
                        `;
                    }
                    break;
            }
        }

        async function loadAndRenderDevices() {
            try {
                isLoading.devices = true;
                renderLoadingState('devices');
                
                userDevices = await loadDevices();
                renderDevices(userDevices);
                isLoading.devices = false;
            } catch (error) {
                console.error('Error loading devices:', error);
                renderErrorState('devices');
                isLoading.devices = false;
            }
        }

        function renderDevices(devices) {
            const devicesList = document.getElementById('devicesList');
            if (!devicesList) return;
            
            if (devices.length === 0) {
                devicesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <iconify-icon icon="mdi:devices"></iconify-icon>
                        </div>
                        <h3 class="h3">لا توجد أجهزة</h3>
                        <p class="body">
                            سيظهر هنا أي جهاز تقوم بتسجيل الدخول منه. جرب تسجيل الدخول من جهاز آخر لتراه هنا.
                        </p>
                    </div>
                `;
                return;
            }
            
            devicesList.innerHTML = '';
            
            devices.forEach(device => {
                const deviceElement = createDeviceElement(device);
                devicesList.appendChild(deviceElement);
            });
        }

        function createDeviceElement(device) {
            const isCurrent = device.id === currentDeviceId;
            const isOwner = securityData?.ownerDeviceId === device.id;
            const isBlocked = securityData?.blockedDevices?.[device.id];
            const isPending = securityData?.pendingDevices?.[device.id] && !isOwner;
            const isTrusted = securityData?.trustedDevices?.[device.id] || device.trusted;
            
            let deviceClass = 'device-card';
            if (isCurrent) deviceClass += ' current';
            if (isBlocked) deviceClass += ' blocked';
            if (isPending) deviceClass += ' pending';
            
            const element = document.createElement('div');
            element.className = deviceClass;
            
            const lastActive = formatTimeAgo(device.lastActive);
            const deviceIcon = getDeviceIcon(device.deviceName);
            
            element.innerHTML = `
                <div class="device-icon">
                    <iconify-icon icon="${deviceIcon}"></iconify-icon>
                </div>
                
                <div class="device-info">
                    <div class="device-header">
                        <div>
                            <div class="device-name">${device.deviceName}</div>
                            <div class="device-details">
                                ${device.browser} • ${device.os}
                            </div>
                        </div>
                        <div class="device-badges">
                            ${isCurrent ? `
                                <span class="device-badge current">
                                    <iconify-icon icon="mdi:check-circle"></iconify-icon>
                                    هذا الجهاز
                                </span>
                            ` : ''}
                            ${isOwner ? `
                                <span class="device-badge owner">
                                    <iconify-icon icon="mdi:crown"></iconify-icon>
                                    الجهاز الرئيسي
                                </span>
                            ` : ''}
                            ${isTrusted && !isBlocked ? `
                                <span class="device-badge trusted">
                                    <iconify-icon icon="mdi:shield-check"></iconify-icon>
                                    موثوق
                                </span>
                            ` : ''}
                            ${isBlocked ? `
                                <span class="device-badge blocked">
                                    <iconify-icon icon="mdi:block-helper"></iconify-icon>
                                    محظور
                                </span>
                            ` : ''}
                            ${isPending ? `
                                <span class="device-badge pending">
                                    <iconify-icon icon="mdi:clock-outline"></iconify-icon>
                                    في انتظار الموافقة
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="device-time">
                        <iconify-icon icon="mdi:clock-outline"></iconify-icon>
                        <span>آخر نشاط: ${lastActive}</span>
                    </div>
                </div>
                
                <div class="device-actions">
                    ${renderDeviceActions(device, isCurrent, isOwner, isBlocked, isPending, isTrusted)}
                </div>
            `;
            
            setTimeout(() => {
                if (!isCurrent && isOwnerDevice) {
                    const logoutBtn = element.querySelector('.logout');
                    const trustBtn = element.querySelector('.trust');
                    const untrustBtn = element.querySelector('.untrust');
                    const blockBtn = element.querySelector('.block');
                    const unblockBtn = element.querySelector('.unblock');
                    const approveBtn = element.querySelector('.approve');
                    
                    logoutBtn?.addEventListener('click', () => signOutDevice(device));
                    trustBtn?.addEventListener('click', () => toggleDeviceTrustAction(device.id, true));
                    untrustBtn?.addEventListener('click', () => toggleDeviceTrustAction(device.id, false));
                    blockBtn?.addEventListener('click', () => showBlockConfirmation(device));
                    unblockBtn?.addEventListener('click', () => unblockDeviceAction(device.id));
                    approveBtn?.addEventListener('click', () => approveDeviceAction(device.id));
                }
            }, 100);
            
            return element;
        }

        function showBlockConfirmation(device) {
            showConfirmationModal('block', {
                deviceId: device.id,
                deviceName: device.deviceName
            });
        }

        function renderDeviceActions(device, isCurrent, isOwner, isBlocked, isPending, isTrusted) {
            if (isCurrent) {
                return '';
            }
            
            if (!isOwnerDevice) {
                return '';
            }
            
            let actions = '';
            
            if (isBlocked) {
                actions += `
                    <button class="device-action-btn unblock" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:lock-open"></iconify-icon>
                        إلغاء الحظر
                    </button>
                `;
            } else if (isPending) {
                actions += `
                    <button class="device-action-btn approve" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:check-circle"></iconify-icon>
                        الموافقة
                    </button>
                    <button class="device-action-btn block" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:block-helper"></iconify-icon>
                        رفض
                    </button>
                `;
            } else {
                actions += `
                    <button class="device-action-btn logout" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:logout"></iconify-icon>
                        تسجيل الخروج
                    </button>
                    ${isTrusted ? `
                        <button class="device-action-btn untrust" data-device-id="${device.id}">
                            <iconify-icon icon="mdi:shield-off"></iconify-icon>
                            إلغاء الثقة
                        </button>
                    ` : `
                        <button class="device-action-btn trust" data-device-id="${device.id}">
                            <iconify-icon icon="mdi:shield-check"></iconify-icon>
                            تعيين كموثوق
                        </button>
                    `}
                    <button class="device-action-btn block" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:block-helper"></iconify-icon>
                        حظر
                    </button>
                `;
            }
            
            return actions;
        }

        async function signOutDevice(device) {
            try {
                const confirm = window.confirm(`هل تريد تسجيل الخروج من الجهاز "${device.deviceName}"؟`);
                if (!confirm) return;
                
                const deviceRef = doc(accountRef, 'devices', device.id);
                await deleteDoc(deviceRef);
                
                await logActivity('device_logout', {
                    deviceName: device.deviceName
                });
                
                await loadAndRenderDevices();
                showToast('تم تسجيل الخروج من الجهاز بنجاح', 'success');
            } catch (error) {
                console.error('Error signing out device:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج من الجهاز', 'error');
            }
        }

        function toggleDeviceTrustAction(deviceId, trusted) {
            const action = trusted ? 'تعيين كموثوق' : 'إلغاء الثقة';
            const confirmMsg = trusted 
                ? 'هل تريد تعيين هذا الجهاز كموثوق؟ الأجهزة الموثوقة يمكنها الوصول بدون موافقة.'
                : 'هل تريد إلغاء الثقة عن هذا الجهاز؟ سيحتاج الجهاز إلى موافقة عند تسجيل الدخول التالي.';
            
            if (confirm(confirmMsg)) {
                toggleDeviceTrust(deviceId, trusted).then(success => {
                    if (success) {
                        loadAndRenderDevices();
                    }
                });
            }
        }

        function unblockDeviceAction(deviceId) {
            if (confirm('هل تريد إلغاء حظر هذا الجهاز؟ سيكون بإمكان الجهاز تسجيل الدخول مرة أخرى.')) {
                unblockDevice(deviceId).then(success => {
                    if (success) {
                        loadAndRenderDevices();
                    }
                });
            }
        }

        function approveDeviceAction(deviceId) {
            if (confirm('هل تريد الموافقة على هذا الجهاز؟ سيتمكن الجهاز من الوصول إلى الحساب.')) {
                approveDevice(deviceId).then(success => {
                    if (success) {
                        loadAndRenderDevices();
                    }
                });
            }
        }

        // ===== ACTIVITY LOGS =====
        function setupActivityFilters() {
            const filtersContainer = document.getElementById('activityFilters');
            if (!filtersContainer) return;
            
            const filters = [
                { value: 'all', label: 'الكل' },
                { value: 'security', label: 'الأمان' },
                { value: 'vault', label: 'الحسابات' }
            ];
            
            filtersContainer.innerHTML = filters.map(filter => `
                <button class="activity-filter ${filter.value === 'all' ? 'active' : ''}" 
                        data-filter="${filter.value}">
                    ${filter.label}
                </button>
            `).join('');
            
            filtersContainer.querySelectorAll('.activity-filter').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const filter = e.target.getAttribute('data-filter');
                    
                    filtersContainer.querySelectorAll('.activity-filter').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    await loadAndRenderActivityLogs(filter);
                });
            });
        }

        async function loadAndRenderActivityLogs(filter = 'all') {
            try {
                isLoading.activity = true;
                renderLoadingState('activity');
                
                const logs = await loadActivityLogs(filter);
                renderActivityLogs(logs);
                isLoading.activity = false;
            } catch (error) {
                console.error('Error loading activity logs:', error);
                renderErrorState('activity');
                isLoading.activity = false;
            }
        }

        function renderActivityLogs(logs) {
            const timeline = document.getElementById('activityTimeline');
            if (!timeline) return;
            
            if (logs.length === 0) {
                timeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <iconify-icon icon="mdi:history"></iconify-icon>
                        </div>
                        <h3 class="h3">لا توجد سجلات نشاط</h3>
                        <p class="body">
                            سيظهر هنا أي نشاط تقوم به على حسابك. جرب إضافة حساب جديد أو تعديل إعداداتك.
                        </p>
                    </div>
                `;
                return;
            }
            
            const logsByDay = groupLogsByDay(logs);
            
            timeline.innerHTML = '';
            
            Object.keys(logsByDay).forEach(day => {
                const dayGroup = document.createElement('div');
                dayGroup.className = 'activity-day-group';
                
                dayGroup.innerHTML = `
                    <div class="day-header">
                        <h3 class="day-label">${day}</h3>
                        <span class="day-count">${logsByDay[day].length} نشاط</span>
                    </div>
                    <div class="activity-items">
                        ${logsByDay[day].map(log => createActivityItem(log)).join('')}
                    </div>
                `;
                
                timeline.appendChild(dayGroup);
            });
        }

        function createActivityItem(log) {
            const activity = getActivityInfo(log.action);
            const description = getActivityDescription(log.action, log.details);
            
            return `
                <div class="activity-item">
                    <div class="activity-icon ${log.action}">
                        <iconify-icon icon="${activity.icon}"></iconify-icon>
                    </div>
                    <div class="activity-content">
                        <div class="activity-description-text">${description}</div>
                        <div class="activity-details">
                            ${log.deviceName ? `من ${log.deviceName}` : ''}
                        </div>
                    </div>
                    <div class="activity-time">
                        ${formatTime(log.timestamp)}
                    </div>
                </div>
            `;
        }

        // ===== SETTINGS SECTION =====
        async function loadAndRenderSettings() {
            const settingsGrid = document.getElementById('settingsGrid');
            if (!settingsGrid) return;
            
            settingsGrid.innerHTML = `
                <div class="settings-card" onclick="openSettingsModal();">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:account-circle"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">الملف الشخصي</h4>
                            <p class="settings-card-description">إدارة معلومات حسابك وتفضيلاتك</p>
                        </div>
                    </div>
                    <div class="settings-items">
                        <div class="settings-item">
                            <span class="settings-name">الاسم: ${currentUser?.displayName || 'المستخدم'}</span>
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </div>
                    </div>
                </div>
                
                <div class="settings-card" onclick="openSettingsModal(); switchSettingsTab('appearance');">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:palette"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">المظهر</h4>
                            <p class="settings-card-description">تخصيص مظهر واجهة التطبيق</p>
                        </div>
                    </div>
                    <div class="settings-items">
                        <div class="settings-item">
                            <span class="settings-name">الوضع: ${userSettings.theme === 'dark' ? 'داكن' : userSettings.theme === 'system' ? 'النظام' : 'فاتح'}</span>
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </div>
                    </div>
                </div>
                
                <div class="settings-card" onclick="openSettingsModal(); switchSettingsTab('security');">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:shield-lock"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">الأمان</h4>
                            <p class="settings-card-description">إدارة إعدادات الأمان والخصوصية</p>
                        </div>
                    </div>
                    <div class="settings-items">
                        <div class="settings-item">
                            <span class="settings-name">إظهار الباسورد: ${userSettings.passwordVisibility === 'hold' ? 'الضغط المطول' : userSettings.passwordVisibility === 'click' ? 'النقر' : 'دائماً'}</span>
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </div>
                    </div>
                </div>
                
                <div class="settings-card" onclick="openSettingsModal(); switchSettingsTab('advanced');">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <iconify-icon icon="mdi:cog"></iconify-icon>
                        </div>
                        <div>
                            <h4 class="settings-card-title">متقدم</h4>
                            <p class="settings-card-description">ميزات متقدمة وإعدادات إضافية</p>
                        </div>
                    </div>
                    <div class="settings-items">
                        <div class="settings-item">
                            <span class="settings-name">نسخ احتياطي، استيراد، سجلات</span>
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== SMART PASSWORD CARDS =====
        function renderBoards() {
            const container = document.getElementById('boardsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (userBoards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <iconify-icon icon="mdi:lock-outline"></iconify-icon>
                        </div>
                        <h3 class="h3">لا توجد حسابات بعد</h3>
                        <p class="body">
                            ابدأ بحفظ أول حساب لتجربة أمان NovaPass. إدارة كلمات المرور أصبحت أسهل وأكثر أماناً.
                        </p>
                        <button class="btn btn-primary" id="firstBoardBtn" style="margin-top: 1.5rem;">
                            <iconify-icon icon="mdi:plus"></iconify-icon>
                            <span>ابدأ بإضافة حساب</span>
                        </button>
                    </div>
                `;
                
                document.getElementById('firstBoardBtn')?.addEventListener('click', () => openBoardModal('add'));
                return;
            }
            
            userBoards.forEach(board => {
                const boardElement = createSmartBoardElement(board);
                if (boardElement) {
                    container.appendChild(boardElement);
                }
            });
        }

        function createSmartBoardElement(board) {
            const element = document.createElement('div');
            element.className = 'board-card';
            
            // Calculate password strength
            const password = board.password;
            let strength = 0;
            let totalWeight = 0;
            
            passwordCriteria.forEach(criteria => {
                if (criteria.test(password)) {
                    strength += criteria.weight;
                }
                totalWeight += criteria.weight;
            });
            
            const lengthBonus = Math.min(password.length * 2, 20);
            strength += lengthBonus;
            totalWeight += 20;
            
            const percentage = Math.min(Math.round((strength / totalWeight) * 100), 100);
            
            // Determine strength level
            let strengthLevel = passwordStrengthLevels.weak;
            if (percentage >= passwordStrengthLevels.excellent.threshold) {
                strengthLevel = passwordStrengthLevels.excellent;
            } else if (percentage >= passwordStrengthLevels.good.threshold) {
                strengthLevel = passwordStrengthLevels.good;
            } else if (percentage >= passwordStrengthLevels.medium.threshold) {
                strengthLevel = passwordStrengthLevels.medium;
            }
            
            element.innerHTML = `
                <div class="card-header">
                    <div class="board-icon-wrapper">
                        <div class="board-icon">
                            <iconify-icon icon="${board.icon || 'mdi:web'}"></iconify-icon>
                        </div>
                        <div class="category-dot ${board.colorClass || 'personal'}" title="${board.colorLabel || 'شخصي'}"></div>
                    </div>
                    
                    <div class="board-info">
                        <h4 class="board-name">${escapeHtml(board.name)}</h4>
                        <div class="board-username">${escapeHtml(board.email)}</div>
                    </div>
                </div>
                
                <div class="password-section">
                    <div class="password-label">
                        <span class="caption">كلمة المرور</span>
                        <span class="caption" style="color: var(--text-muted);">• ${getPasswordVisibilityText()}</span>
                    </div>
                    
                    <div class="password-field" id="passwordField-${board.id}">
                        <div class="password-strength-badge ${strengthLevel.class}">
                            <iconify-icon icon="${strengthLevel.icon}"></iconify-icon>
                            <span>${strengthLevel.label} (${percentage}%)</span>
                        </div>
                        <input type="password" 
                               class="password-input" 
                               id="password-${board.id}"
                               value="${escapeHtml(board.password)}" 
                               readonly>
                        <div class="password-visibility-controls">
                            <button class="action-btn toggle" 
                                    type="button"
                                    aria-label="إظهار كلمة المرور"
                                    data-board-id="${board.id}">
                                <iconify-icon icon="mdi:eye"></iconify-icon>
                            </button>
                            <button class="action-btn copy" 
                                    type="button"
                                    aria-label="نسخ كلمة المرور"
                                    data-board-id="${board.id}">
                                <iconify-icon icon="mdi:content-copy"></iconify-icon>
                            </button>
                        </div>
                    </div>
                    
                    <div class="copy-buttons">
                        <button class="copy-btn email" data-board-id="${board.id}">
                            <iconify-icon icon="mdi:email"></iconify-icon>
                            <span>نسخ البريد</span>
                        </button>
                        <button class="copy-btn password" data-board-id="${board.id}">
                            <iconify-icon icon="mdi:key"></iconify-icon>
                            <span>نسخ الباسورد</span>
                        </button>
                    </div>
                </div>
                
                <div class="card-footer">
                    <button class="action-btn edit" 
                            type="button"
                            aria-label="تعديل الحساب"
                            data-board-id="${board.id}">
                        <iconify-icon icon="mdi:pencil"></iconify-icon>
                        <span>تعديل</span>
                    </button>
                    <button class="action-btn delete" 
                            type="button"
                            aria-label="حذف الحساب"
                            data-board-id="${board.id}">
                        <iconify-icon icon="mdi:delete"></iconify-icon>
                        <span>حذف</span>
                    </button>
                </div>
            `;
            
            // Add event listeners
            const emailCopyBtn = element.querySelector('.copy-btn.email');
            const passwordCopyBtn = element.querySelector('.copy-btn.password');
            const editButton = element.querySelector('.action-btn.edit');
            const deleteButton = element.querySelector('.action-btn.delete');
            const toggleButton = element.querySelector('.action-btn.toggle');
            const copyButton = element.querySelector('.action-btn.copy');
            const passwordInput = element.querySelector(`#password-${board.id}`);
            const passwordField = element.querySelector(`#passwordField-${board.id}`);
            
            emailCopyBtn.addEventListener('click', () => {
                copyToClipboard(board.email, emailCopyBtn, board.name, 'email');
            });
            
            passwordCopyBtn.addEventListener('click', () => {
                copyToClipboard(board.password, passwordCopyBtn, board.name, 'password');
            });
            
            copyButton.addEventListener('click', () => {
                copyToClipboard(board.password, copyButton, board.name, 'password');
            });
            
            editButton.addEventListener('click', () => {
                const boardToEdit = userBoards.find(b => b.id === board.id);
                if (boardToEdit) openBoardModal('edit', boardToEdit);
            });
            
            deleteButton.addEventListener('click', () => {
                showConfirmationModal('delete', {
                    boardId: board.id,
                    boardName: board.name
                });
            });
            
            if (toggleButton && passwordInput) {
                setupPasswordVisibility(toggleButton, passwordInput, passwordField);
            }
            
            return element;
        }

        function getPasswordVisibilityText() {
            const mode = userSettings.passwordVisibility || 'hold';
            switch(mode) {
                case 'hold': return 'إظهار بالضغط المطول';
                case 'click': return 'إظهار بالنقر';
                case 'always': return 'مرئي دائماً';
                default: return 'إظهار بالضغط المطول';
            }
        }

        function setupPasswordVisibility(toggleButton, passwordInput, passwordField) {
            const visibilityMode = userSettings.passwordVisibility || 'hold';
            
            if (visibilityMode === 'always') {
                passwordInput.type = 'text';
                toggleButton.innerHTML = '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                toggleButton.addEventListener('click', () => {
                    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                    toggleButton.innerHTML = passwordInput.type === 'password' ? 
                        '<iconify-icon icon="mdi:eye"></iconify-icon>' : 
                        '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                });
            } else if (visibilityMode === 'click') {
                toggleButton.addEventListener('click', () => {
                    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                    toggleButton.innerHTML = passwordInput.type === 'password' ? 
                        '<iconify-icon icon="mdi:eye"></iconify-icon>' : 
                        '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                });
            } else {
                let holdTimer;
                
                const showPassword = () => {
                    passwordInput.type = 'text';
                    toggleButton.innerHTML = '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                    passwordField.classList.add('focused');
                };
                
                const hidePassword = () => {
                    clearTimeout(holdTimer);
                    passwordInput.type = 'password';
                    toggleButton.innerHTML = '<iconify-icon icon="mdi:eye"></iconify-icon>';
                    passwordField.classList.remove('focused');
                };
                
                toggleButton.addEventListener('mousedown', () => {
                    holdTimer = setTimeout(showPassword, 500);
                });
                
                toggleButton.addEventListener('mouseup', hidePassword);
                toggleButton.addEventListener('mouseleave', hidePassword);
                
                toggleButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    holdTimer = setTimeout(showPassword, 500);
                });
                
                toggleButton.addEventListener('touchend', hidePassword);
                toggleButton.addEventListener('touchcancel', hidePassword);
            }
        }

        // ===== BOARD OPERATIONS =====
        async function handleBoardSubmit(e) {
            e.preventDefault();
            
            const boardName = document.getElementById('boardName').value.trim();
            const boardEmail = document.getElementById('boardEmail').value.trim();
            const boardPassword = document.getElementById('boardPassword').value.trim();
            
            let isValid = true;
            
            if (!boardName) {
                showError('nameError', 'اسم الحساب مطلوب');
                isValid = false;
            } else {
                hideError('nameError');
            }
            
            if (!boardEmail) {
                showError('emailError', 'البريد الإلكتروني مطلوب');
                isValid = false;
            } else {
                hideError('emailError');
            }
            
            if (!boardPassword) {
                showError('passwordError', 'كلمة المرور مطلوبة');
                isValid = false;
            } else {
                hideError('passwordError');
            }
            
            if (!isValid) {
                showToast('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            const selectedIcon = document.querySelector('.icon-option.selected');
            const selectedColor = document.querySelector('.radio-circle.selected');
            
            if (!selectedIcon || !selectedColor) {
                showToast('الرجاء اختيار أيقونة وتصنيف', 'error');
                return;
            }
            
            const boardIcon = selectedIcon.getAttribute('data-icon');
            const boardColor = selectedColor.getAttribute('data-color');
            const boardColorClass = selectedColor.getAttribute('data-class');
            const boardColorLabel = selectedColor.getAttribute('data-label');
            
            const saveBtn = document.getElementById('saveBoardBtn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<iconify-icon icon="mdi:loading" style="animation: spin 1s linear infinite;"></iconify-icon> جاري الحفظ...';
            saveBtn.disabled = true;
            
            try {
                const boardData = {
                    id: currentEditingBoard || generateId(),
                    name: boardName,
                    email: boardEmail,
                    password: boardPassword,
                    icon: boardIcon,
                    color: boardColor,
                    colorClass: boardColorClass,
                    colorLabel: boardColorLabel,
                    updatedAt: new Date().toISOString(),
                    createdAt: currentEditingBoard ? 
                        userBoards.find(b => b.id === currentEditingBoard)?.createdAt || new Date().toISOString() : 
                        new Date().toISOString()
                };
                
                if (currentEditingBoard) {
                    const index = userBoards.findIndex(b => b.id === currentEditingBoard);
                    if (index !== -1) {
                        userBoards[index] = boardData;
                        showToast('تم تحديث الحساب بنجاح!', 'success');
                    }
                } else {
                    userBoards.push(boardData);
                    showToast('تم إضافة الحساب بنجاح!', 'success');
                }
                
                await updateDoc(accountRef, {
                    'vault.boards': userBoards,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                await logActivity(currentEditingBoard ? 'edit' : 'add', { boardName: boardName });
                renderBoards();
                closeAllModals();
            } catch (error) {
                console.error('Error saving board:', error);
                showToast('حدث خطأ أثناء حفظ الحساب', 'error');
            } finally {
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
            }
        }

        async function deleteBoard(boardId) {
            try {
                userBoards = userBoards.filter(b => b.id !== boardId);
                
                await updateDoc(accountRef, {
                    'vault.boards': userBoards,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                await logActivity('delete', { 
                    boardName: userBoards.find(b => b.id === boardId)?.name || 'حساب'
                });
                
                renderBoards();
                showToast('تم حذف الحساب بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting board:', error);
                showToast('حدث خطأ أثناء حذف الحساب', 'error');
            }
        }

        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
                const input = document.getElementById(errorId.replace('Error', ''));
                if (input) {
                    input.classList.add('error');
                }
            }
        }

        function hideError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.classList.remove('show');
                const input = document.getElementById(errorId.replace('Error', ''));
                if (input) {
                    input.classList.remove('error');
                }
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function selectIcon(iconElement) {
            document.querySelectorAll('.icon-option').forEach(icon => {
                icon.classList.remove('selected');
            });
            iconElement.classList.add('selected');
            
            iconElement.style.animation = 'copyPulse 0.6s';
            setTimeout(() => {
                iconElement.style.animation = '';
            }, 600);
        }

        function selectColor(colorCircle) {
            document.querySelectorAll('.radio-circle').forEach(circle => {
                circle.classList.remove('selected');
            });
            colorCircle.classList.add('selected');
            
            colorCircle.style.boxShadow = '0 0 0 4px rgba(46, 211, 183, 0.2)';
            setTimeout(() => {
                colorCircle.style.boxShadow = '';
            }, 300);
        }

        function getDeviceIcon(deviceName) {
            if (deviceName.includes('هاتف')) return 'mdi:cellphone';
            if (deviceName.includes('تابلت')) return 'mdi:tablet';
            if (deviceName.includes('حاسوب')) return 'mdi:laptop';
            return 'mdi:devices';
        }

        function getActivityInfo(action) {
            return activityIcons[action] || { icon: 'mdi:information', label: 'نشاط' };
        }

        function getActivityDescription(action, details) {
            return activityDescriptions[action]?.(details) || 'نشاط جديد';
        }

        function groupLogsByDay(logs) {
            const groups = {};
            
            logs.forEach(log => {
                const date = log.timestamp.toLocaleDateString('ar-SA', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!groups[date]) {
                    groups[date] = [];
                }
                
                groups[date].push(log);
            });
            
            return groups;
        }

        function copyToClipboard(text, button, boardName = '', type = '') {
            navigator.clipboard.writeText(text).then(() => {
                const message = type === 'email' ? 'تم نسخ البريد الإلكتروني!' : 'تم نسخ كلمة المرور!';
                showToast(message, 'success');
                
                if (button) {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<iconify-icon icon="mdi:check" style="color: var(--success);"></iconify-icon>';
                    
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                    }, 2000);
                }
                
                if (boardName) {
                    logActivity('copy', { 
                        boardName: boardName,
                        type: type 
                    });
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('حدث خطأ أثناء النسخ', 'error');
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatDate(date) {
            if (!date) return '-';
            
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(date) {
            if (!date) return '';
            
            return date.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} ساعة`;
            if (diffDays < 7) return `منذ ${diffDays} يوم`;
            
            return date.toLocaleDateString('ar-SA');
        }

        function updateUserUI() {
            if (!currentUser) return;
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            document.getElementById('userName').textContent = displayName;
            document.getElementById('dropdownName').textContent = displayName;
            document.getElementById('userEmail').textContent = currentUser.email || 'user@example.com';
            document.getElementById('welcomeMessage').textContent = `مرحباً ${displayName}!`;
            
            const initial = displayName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
        }

        // ===== LOGOUT =====
        async function handleLogout() {
            try {
                await logActivity('logout');
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
            }
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            
            const icon = {
                success: 'mdi:check-circle',
                error: 'mdi:alert-circle',
                info: 'mdi:information'
            }[type];
            
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <iconify-icon icon="${icon}"></iconify-icon>
                </div>
                <span class="body-sm">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Firebase deleteField helper
        const deleteField = () => {
            return null;
        };
    </script>
</body>
</html>