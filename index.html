<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaPass • Dashboard</title>
    
    <!-- Iconify Icons -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== DESIGN SYSTEM ===== */
        :root {
            /* Primary Mint Green System */
            --mint-50: #E8F8F2;
            --mint-100: #D4F1E9;
            --mint-200: #B4E6D6;
            --mint-300: #3EB489;
            --mint-400: #1F7A5A;
            --mint-500: #165C46;
            
            /* Neutral Palette */
            --gray-50: #F9FFFC;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Semantic Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --danger-light: #FEE2E2;
            --danger-dark: #DC2626;
            --pending: #F59E0B;
            --pending-light: #FEF3C7;
            --blocked: #DC2626;
            --blocked-light: #FEE2E2;
            --debug: #8B5CF6;
            --debug-light: #EDE9FE;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-mint: 0 4px 20px rgba(62, 180, 137, 0.15);
            
            /* Light Theme (Default) */
            --bg-primary: var(--gray-50);
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            --border-hover: var(--mint-300);
            
            /* Dark Theme Variables */
            --dark-bg-primary: #0F172A;
            --dark-bg-secondary: #1E293B;
            --dark-bg-card: #1E293B;
            --dark-text-primary: #E5E7EB;
            --dark-text-secondary: #94A3B8;
            --dark-text-muted: #64748B;
            --dark-border-color: #334155;
            --dark-border-hover: #4ADE80;
        }

        /* Apply Dark Theme */
        body.dark-mode {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-card: var(--dark-bg-card);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-muted: var(--dark-text-muted);
            --border-color: var(--dark-border-color);
            --border-hover: var(--dark-border-hover);
        }

        /* ===== BASE RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ===== BLOCKED/PENDING OVERLAY ===== */
        .access-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn 0.3s ease;
        }

        body.dark-mode .access-overlay {
            background: rgba(15, 23, 42, 0.95);
        }

        .access-message {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.3s ease;
        }

        .access-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2.5rem;
        }

        .access-icon.blocked {
            background: var(--blocked-light);
            color: var(--blocked);
        }

        .access-icon.pending {
            background: var(--pending-light);
            color: var(--pending);
        }

        .access-message .h3 {
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .access-message .body {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .access-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* ===== TYPOGRAPHY ===== */
        .h1 { 
            font-size: 2.5rem; 
            font-weight: 700; 
            line-height: 1.2;
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            display: inline-block;
        }

        .h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 0;
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--mint-300));
            border-radius: 2px;
        }

        .h2 { font-size: 2rem; font-weight: 700; line-height: 1.3; }
        .h3 { font-size: 1.5rem; font-weight: 600; line-height: 1.4; }
        .h4 { font-size: 1.25rem; font-weight: 600; line-height: 1.4; }
        
        .body-lg { font-size: 1.125rem; line-height: 1.7; }
        .body { font-size: 1rem; line-height: 1.6; }
        .body-sm { font-size: 0.875rem; line-height: 1.5; }
        .caption { font-size: 0.75rem; line-height: 1.4; color: var(--text-muted); }
        
        .text-gradient {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ===== NAVBAR ===== */
        .navbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.98);
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .navbar {
            background: rgba(30, 41, 59, 0.98);
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-text::after {
            content: '•';
            color: var(--mint-300);
            font-size: 1.8rem;
            line-height: 1;
        }

        .logo-dashboard {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ===== NAV TABS ===== */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            margin-right: 2rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .nav-tab:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        body.dark-mode .nav-tab:hover {
            background: rgba(62, 180, 137, 0.1);
        }

        .nav-tab.active {
            background: var(--mint-100);
            color: var(--mint-400);
        }

        body.dark-mode .nav-tab.active {
            background: rgba(62, 180, 137, 0.2);
        }

        /* ===== SECTIONS MANAGEMENT ===== */
        .section {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* ===== DASHBOARD SECTION ===== */
        .dashboard-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: calc(100vh - 88px);
        }

        .welcome-section {
            margin-bottom: 3rem;
        }

        .welcome-section .body-lg {
            color: var(--text-secondary);
            margin-top: 1rem;
            max-width: 600px;
        }

        /* ===== BOARDS GRID ===== */
        .boards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .board-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.5s ease;
            min-height: 280px;
        }

        .board-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-hover);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .board-icon-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .board-icon {
            width: 64px;
            height: 64px;
            background: var(--mint-50);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--mint-400);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .board-card:hover .board-icon {
            transform: scale(1.05);
            background: var(--mint-100);
            border-color: var(--mint-200);
        }

        body.dark-mode .board-icon {
            background: rgba(62, 180, 137, 0.1);
        }

        .color-dot {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid var(--bg-card);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .color-dot:hover {
            transform: scale(1.3);
        }

        .color-dot.personal { background: var(--mint-300); }
        .color-dot.work { background: #4ECDC4; }
        .color-dot.important { background: #FF6B6B; }
        .color-dot.social { background: #9D4EDD; }
        .color-dot.finance { background: #FFD166; }
        .color-dot.other { background: #118AB2; }

        .board-info {
            flex: 1;
            min-width: 0;
        }

        .board-name {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .board-username {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .password-section {
            margin-top: 0.5rem;
        }

        .password-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .password-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s ease;
        }

        .password-field:hover {
            border-color: var(--border-hover);
        }

        .password-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            font-size: 1rem;
            letter-spacing: 0.05em;
            min-width: 0;
            outline: none;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .board-card:hover .card-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .action-btn {
            flex: 1;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .action-btn.copy:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .action-btn.edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border-color: var(--info);
        }

        .action-btn.delete:hover {
            background: var(--danger-light);
            color: var(--danger-dark);
            border-color: var(--danger);
        }

        /* ===== DEVICES SECTION ===== */
        .devices-section {
            max-width: 1280px;
            margin: 0 auto;
        }

        .devices-description {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
        }

        .devices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .device-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--mint-200);
        }

        .device-card.current {
            border: 2px solid var(--mint-300);
            background: linear-gradient(135deg, 
                rgba(62, 180, 137, 0.05), 
                rgba(62, 180, 137, 0.02));
        }

        .device-card.current::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--mint-300);
        }

        .device-card.blocked {
            border: 2px solid var(--blocked);
            background: linear-gradient(135deg, 
                rgba(220, 38, 38, 0.05), 
                rgba(220, 38, 38, 0.02));
            opacity: 0.8;
        }

        .device-card.pending {
            border: 2px solid var(--pending);
            background: linear-gradient(135deg, 
                rgba(245, 158, 11, 0.05), 
                rgba(245, 158, 11, 0.02));
        }

        .device-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: var(--mint-50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mint-400);
            font-size: 1.75rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .device-card:hover .device-icon {
            transform: scale(1.05);
            background: var(--mint-100);
        }

        body.dark-mode .device-icon {
            background: rgba(62, 180, 137, 0.1);
        }

        body.dark-mode .device-card:hover .device-icon {
            background: rgba(62, 180, 137, 0.2);
        }

        .device-info {
            flex: 1;
            min-width: 0;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .device-name {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .device-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .device-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .device-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
        }

        .device-badge.current {
            background: var(--mint-50);
            color: var(--mint-400);
            border: 1px solid var(--mint-200);
        }

        .device-badge.owner {
            background: rgba(62, 180, 137, 0.2);
            color: var(--mint-400);
            border: 1px solid rgba(62, 180, 137, 0.3);
        }

        .device-badge.trusted {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .device-badge.blocked {
            background: var(--blocked-light);
            color: var(--blocked);
            border: 1px solid var(--blocked);
        }

        .device-badge.pending {
            background: var(--pending-light);
            color: var(--pending);
            border: 1px solid var(--pending);
        }

        .device-badge.debug {
            background: var(--debug-light);
            color: var(--debug);
            border: 1px solid var(--debug);
        }

        body.dark-mode .device-badge.current {
            background: rgba(62, 180, 137, 0.2);
        }

        body.dark-mode .device-badge.trusted {
            background: rgba(16, 185, 129, 0.2);
        }

        .device-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .device-actions {
            display: flex;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
        }

        .device-card:hover .device-actions {
            opacity: 1;
            transform: translateX(0);
        }

        .device-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .device-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .device-action-btn.logout:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        .device-action-btn.trust:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        .device-action-btn.approve:hover {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-color: var(--success);
        }

        .device-action-btn.block:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        .device-action-btn.unblock:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        body.dark-mode .device-action-btn.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        body.dark-mode .device-action-btn.trust:hover {
            background: rgba(62, 180, 137, 0.1);
        }

        .device-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ===== ACTIVITY LOGS SECTION ===== */
        .activity-section {
            max-width: 1280px;
            margin: 0 auto;
        }

        .activity-description {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
        }

        .activity-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .activity-filter {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .activity-filter:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        .activity-filter.active {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-200);
        }

        .activity-timeline {
            position: relative;
            padding-right: 2rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .activity-day-group {
            margin-bottom: 3rem;
            position: relative;
        }

        .day-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .day-header::before {
            content: '';
            position: absolute;
            right: -2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--mint-300);
            border: 3px solid var(--bg-primary);
            z-index: 2;
        }

        .day-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.125rem;
        }

        .day-count {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .activity-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.3s ease;
            transition: all 0.2s ease;
            position: relative;
        }

        .activity-item:hover {
            border-color: var(--mint-200);
            transform: translateX(-4px);
            box-shadow: var(--shadow-sm);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.login { background: rgba(62, 180, 137, 0.1); color: var(--mint-400); }
        .activity-icon.logout { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.device_logout { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.add { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .activity-icon.edit { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .activity-icon.delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.copy { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .activity-icon.theme { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }
        .activity-icon.trust { background: rgba(62, 180, 137, 0.1); color: var(--mint-400); }
        .activity-icon.block { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .activity-icon.unblock { background: rgba(62, 180, 137, 0.1); color: var(--mint-400); }
        .activity-icon.approve { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .activity-icon.import { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }
        .activity-icon.export { background: rgba(59, 130, 246, 0.1); color: var(--info); }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-description {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .activity-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        /* ===== OLD DATA SECTION ===== */
        .olddata-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .olddata-description {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
        }

        .data-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .data-actions {
                grid-template-columns: 1fr;
            }
        }

        .data-action-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1.5rem;
        }

        .data-action-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--mint-300);
        }

        .data-action-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: var(--mint-50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mint-400);
            font-size: 2.5rem;
        }

        .data-action-content {
            flex: 1;
        }

        .data-action-content .h4 {
            margin-bottom: 0.75rem;
        }

        .data-action-content .body {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .data-preview {
            margin-top: 3rem;
        }

        .data-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .data-preview-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 6rem 2rem;
            animation: fadeIn 0.6s ease;
        }

        .empty-icon {
            font-size: 5rem;
            color: var(--mint-100);
            margin-bottom: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        .empty-state .h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .empty-state .body {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ===== USER PROFILE ===== */
        .user-profile {
            position: relative;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: none;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .profile-trigger:hover {
            background: var(--mint-50);
        }

        body.dark-mode .profile-trigger:hover {
            background: rgba(62, 180, 137, 0.1);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            padding: 1rem;
            min-width: 280px;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            animation: slideDown 0.2s ease;
            border: 1px solid var(--border-color);
            z-index: 1000;
        }

        .profile-dropdown.active {
            display: flex;
        }

        .dropdown-header {
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
            min-height: 44px;
        }

        .dropdown-item:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(62, 180, 137, 0.1);
        }

        .dropdown-item.danger {
            color: var(--danger);
            margin-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.875rem;
        }

        .dropdown-item.danger:hover {
            background: var(--danger-light);
            color: var(--danger-dark);
        }

        body.dark-mode .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ===== FLOATING ADD BUTTON ===== */
        .floating-add-btn {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-mint);
            border: none;
            z-index: 900;
        }

        .floating-add-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 25px rgba(62, 180, 137, 0.3);
        }

        .floating-add-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 520px;
            animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-300);
        }

        /* ===== SETTINGS MODAL ===== */
        .settings-modal .modal-content {
            max-width: 600px;
        }

        .settings-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .settings-section {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-header iconify-icon {
            color: var(--mint-400);
            font-size: 1.5rem;
        }

        .settings-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .settings-item:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .settings-label {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
        }

        .settings-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .settings-description {
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .plan-badge {
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            background: var(--mint-50);
            color: var(--mint-400);
            border: 1px solid var(--mint-200);
        }

        .plan-badge.pro {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .plan-badge.premium {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
        }

        /* ===== FORM CONTROLS ===== */
        .form-group {
            margin-bottom: 1.75rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--border-hover);
            box-shadow: 0 0 0 4px rgba(62, 180, 137, 0.1);
        }

        .form-control:hover {
            border-color: var(--border-hover);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .form-control.error {
            border-color: var(--danger);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ===== FILE UPLOAD ===== */
        .file-upload {
            width: 100%;
            padding: 2rem;
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .file-upload:hover {
            border-color: var(--mint-300);
            background: var(--mint-50);
        }

        .file-upload.dragover {
            border-color: var(--mint-400);
            background: var(--mint-100);
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--mint-300);
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        /* ===== RADIO AND SEGMENTED CONTROLS ===== */
        .radio-selector {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-circle {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            cursor: pointer;
        }

        .radio-circle:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .radio-circle.selected {
            border-color: white;
            box-shadow: 0 0 0 3px var(--mint-300);
        }

        .radio-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .segmented-control {
            display: flex;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
        }

        .segmented-option {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .segmented-option:hover {
            background: var(--mint-50);
        }

        .segmented-option.selected {
            background: var(--mint-100);
            color: var(--mint-400);
            box-shadow: var(--shadow-sm);
        }

        /* ===== ICON SELECTOR ===== */
        .icon-selector {
            margin-bottom: 2rem;
        }

        .icon-search-container {
            margin-bottom: 1.5rem;
        }

        .icon-categories {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .category-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background: var(--mint-50);
            color: var(--mint-400);
        }

        .category-btn.active {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-200);
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
        }

        .icon-option {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            transform: scale(1.1);
            background: var(--mint-50);
            color: var(--mint-400);
            border-color: var(--mint-200);
        }

        .icon-option.selected {
            background: var(--mint-100);
            color: var(--mint-400);
            border-color: var(--mint-300);
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(62, 180, 137, 0.2);
        }

        /* ===== PASSWORD STRENGTH ===== */
        .password-strength-advanced {
            margin-top: 1rem;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .strength-meter {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .strength-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .strength-criteria {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .strength-criteria.valid {
            color: var(--success);
        }

        .strength-criteria.valid iconify-icon {
            color: var(--success);
        }

        .strength-score {
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ===== MODAL ACTIONS ===== */
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2.5rem;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(62, 180, 137, 0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--mint-50);
            border-color: var(--mint-300);
        }

        body.dark-mode .btn-secondary:hover {
            background: rgba(62, 180, 137, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: toastSlideIn 0.3s ease;
            transform-origin: bottom right;
            max-width: 320px;
        }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }

        .toast-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .toast.error .toast-icon {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .toast.info .toast-icon {
            background: rgba(62, 180, 137, 0.1);
            color: var(--mint-400);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100px) scale(0.9);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes copyPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .nav-tabs {
                display: none;
            }
            
            .dashboard-content {
                padding: 1.5rem 1rem;
            }
            
            .boards-grid {
                grid-template-columns: 1fr;
            }
            
            .device-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .device-actions {
                width: 100%;
                justify-content: flex-end;
                opacity: 1;
                transform: none;
            }
            
            .activity-timeline {
                padding-right: 1.5rem;
            }
            
            .activity-timeline::before {
                right: 0.5rem;
            }
            
            .day-header::before {
                right: -1.5rem;
            }
            
            .modal-content {
                padding: 2rem 1.5rem;
                margin: 0 1rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .floating-add-btn {
                bottom: 1.5rem;
                left: 1.5rem;
                width: 52px;
                height: 52px;
            }
            
            .action-btn {
                font-size: 0.8125rem;
                padding: 0 0.5rem;
            }
            
            .settings-section {
                padding: 1.25rem;
            }
            
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .logo-dashboard {
                display: none;
            }
            
            .user-info {
                display: none;
            }
            
            .profile-trigger {
                padding: 0.5rem;
            }
            
            .board-card {
                padding: 1.5rem;
            }
            
            .icon-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .toast-container {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }
            
            .toast {
                max-width: none;
            }
            
            .device-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .device-badges {
                width: 100%;
            }
            
            .activity-item {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .activity-time {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Blocked/Pending Access Overlay -->
    <div class="access-overlay" id="accessOverlay" style="display: none;">
        <div class="access-message" id="accessMessage">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">NovaPass<span class="logo-dashboard" id="dashboardLabel">Dashboard</span></span>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="dashboardSection">
                    <iconify-icon icon="mdi:view-dashboard"></iconify-icon>
                    <span>لوحة التحكم</span>
                </button>
                <button class="nav-tab" data-section="devicesSection">
                    <iconify-icon icon="mdi:devices"></iconify-icon>
                    <span>الأجهزة</span>
                </button>
                <button class="nav-tab" data-section="activitySection">
                    <iconify-icon icon="mdi:history"></iconify-icon>
                    <span>سجلات النشاط</span>
                </button>
                <button class="nav-tab" data-section="olddataSection">
                    <iconify-icon icon="mdi:database-export"></iconify-icon>
                    <span>البيانات القديمة</span>
                </button>
            </div>
            
            <div class="nav-actions">
                <!-- User Profile -->
                <div class="user-profile">
                    <button class="profile-trigger" id="profileBtn">
                        <div class="avatar" id="userAvatar">M</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">محمد</div>
                            <div class="user-status">
                                <iconify-icon icon="mdi:check-circle" style="font-size: 0.75rem;"></iconify-icon>
                                <span>متصلة</span>
                            </div>
                        </div>
                    </button>
                    
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <div class="user-name" id="dropdownName">محمد</div>
                            <div class="body-sm" style="color: var(--text-muted);" id="userEmail">mohamed@example.com</div>
                        </div>
                        
                        <a href="#" class="dropdown-item" data-section="devicesSection">
                            <iconify-icon icon="mdi:devices"></iconify-icon>
                            <span>الأجهزة</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" data-section="activitySection">
                            <iconify-icon icon="mdi:history"></iconify-icon>
                            <span>سجلات النشاط</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" data-section="olddataSection">
                            <iconify-icon icon="mdi:database-export"></iconify-icon>
                            <span>البيانات القديمة</span>
                        </a>
                        
                        <a href="#" class="dropdown-item" id="settingsBtn">
                            <iconify-icon icon="mdi:cog"></iconify-icon>
                            <span>الإعدادات</span>
                        </a>
                        
                        <a href="#" class="dropdown-item danger" id="logoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Floating Add Button -->
    <button class="floating-add-btn" id="floatingAddBtn">
        <iconify-icon icon="mdi:plus" style="font-size: 1.5rem;"></iconify-icon>
    </button>

    <!-- Main Content -->
    <main class="dashboard-content">
        <!-- Dashboard Section (Default) -->
        <div class="section active" id="dashboardSection">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <h1 class="h1" id="welcomeMessage">مرحباً محمد!</h1>
                <p class="body-lg">
                    إدارة كلمات المرور الخاصة بك أصبحت أسهل وأكثر أماناً. كل شيء في مكان واحد.
                </p>
            </div>

            <!-- Boards Grid -->
            <div class="boards-grid" id="boardsContainer">
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <iconify-icon icon="mdi:lock-outline"></iconify-icon>
                    </div>
                    <h3 class="h3">لا توجد حسابات بعد</h3>
                    <p class="body">
                        ابدأ بحفظ أول حساب لتجربة أمان NovaPass
                    </p>
                    <button class="btn btn-primary" id="firstBoardBtn" style="margin-top: 1.5rem;">
                        <iconify-icon icon="mdi:plus"></iconify-icon>
                        <span>ابدأ بإضافة حساب</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Devices Section -->
        <div class="section devices-section" id="devicesSection">
            <div class="section-header">
                <h2 class="h2">🔐 الأجهزة المتصلة</h2>
                <div class="body" style="color: var(--text-secondary);">
                    إدارة الأجهزة التي تم تسجيل الدخول منها إلى حسابك
                </div>
            </div>
            
            <div class="devices-list" id="devicesList">
                <!-- Devices will be populated by JavaScript -->
            </div>
        </div>

        <!-- Activity Logs Section -->
        <div class="section activity-section" id="activitySection">
            <div class="section-header">
                <h2 class="h2">📜 سجلات النشاط</h2>
                <div class="body" style="color: var(--text-secondary);">
                    تتبع جميع الأنشطة المهمة على حسابك للحفاظ على الأمان والخصوصية
                </div>
            </div>
            
            <div class="activity-filters" id="activityFilters">
                <!-- Filters will be populated by JavaScript -->
            </div>
            
            <div class="activity-timeline" id="activityTimeline">
                <!-- Activity logs will be populated by JavaScript -->
            </div>
        </div>

        <!-- Old Data Section -->
        <div class="section olddata-section" id="olddataSection">
            <div class="section-header">
                <h2 class="h2">📂 البيانات القديمة</h2>
                <div class="body" style="color: var(--text-secondary);">
                    إدارة وترحيل بياناتك القديمة بأمان
                </div>
            </div>
            
            <div class="olddata-description">
                <p>
                    يمكنك تصدير بياناتك القديمة أو استيرادها إلى النظام الجديد.
                    يُرجى التأكد من صحة البيانات قبل الاستيراد.
                </p>
            </div>
            
            <div class="data-actions">
                <div class="data-action-card">
                    <div class="data-action-icon">
                        <iconify-icon icon="mdi:download"></iconify-icon>
                    </div>
                    <div class="data-action-content">
                        <h4 class="h4">تصدير البيانات القديمة</h4>
                        <p class="body">
                            احفظ نسخة احتياطية من بياناتك القديمة بصيغة JSON.
                            يمكنك استخدام هذه النسخة لاستعادة البيانات لاحقاً.
                        </p>
                        <button class="btn btn-primary" id="exportOldDataBtn">
                            <iconify-icon icon="mdi:download"></iconify-icon>
                            <span>تصدير البيانات</span>
                        </button>
                    </div>
                </div>
                
                <div class="data-action-card">
                    <div class="data-action-icon">
                        <iconify-icon icon="mdi:upload"></iconify-icon>
                    </div>
                    <div class="data-action-content">
                        <h4 class="h4">استيراد البيانات القديمة</h4>
                        <p class="body">
                            استورد بياناتك القديمة إلى النظام الجديد.
                            سيتم معاينة البيانات قبل الاستيراد النهائي.
                        </p>
                        <button class="btn btn-secondary" id="importOldDataBtn">
                            <iconify-icon icon="mdi:upload"></iconify-icon>
                            <span>استيراد البيانات</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="data-preview" id="dataPreviewContainer" style="display: none;">
                <div class="data-preview-header">
                    <h3 class="h3">معاينة البيانات</h3>
                    <button class="btn btn-secondary" id="closePreviewBtn">
                        <iconify-icon icon="mdi:close"></iconify-icon>
                        <span>إغلاق المعاينة</span>
                    </button>
                </div>
                <div class="data-preview-content" id="dataPreviewContent">
                    <!-- Data preview will be populated by JavaScript -->
                </div>
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="cancelImportBtn">
                        إلغاء
                    </button>
                    <button class="btn btn-primary" id="confirmImportBtn">
                        <iconify-icon icon="mdi:check"></iconify-icon>
                        <span>تأكيد الاستيراد</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Board Modal (Add/Edit) -->
    <div class="modal" id="boardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3" id="modalTitle">إضافة حساب جديد</h3>
                <button class="close-btn" id="closeModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <form id="boardForm">
                <input type="hidden" id="boardId">
                
                <div class="form-group">
                    <label class="form-label">اسم الحساب *</label>
                    <input type="text" id="boardName" class="form-control" 
                           placeholder="مثال: Facebook, Gmail, Instagram"
                           required>
                    <div class="error-message" id="nameError"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني / اسم المستخدم *</label>
                    <input type="text" id="boardEmail" class="form-control" 
                           placeholder="user@example.com أو اسم المستخدم"
                           required>
                    <div class="error-message" id="emailError"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">كلمة المرور *</label>
                    <input type="password" id="boardPassword" class="form-control" 
                           placeholder="أدخل كلمة المرور"
                           required>
                    <div class="error-message" id="passwordError"></div>
                    
                    <!-- Advanced Password Strength Meter -->
                    <div class="password-strength-advanced">
                        <div class="strength-meter">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-details" id="strengthDetails">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="strength-score" id="strengthScore">0%</div>
                    </div>
                </div>
                
                <!-- Icon Selector -->
                <div class="icon-selector">
                    <label class="form-label">اختر الأيقونة</label>
                    
                    <div class="icon-search-container">
                        <input type="text" id="iconSearch" class="form-control" 
                               placeholder="ابحث عن أيقونة...">
                    </div>
                    
                    <div class="icon-categories" id="iconCategories">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                    
                    <div class="icon-grid" id="iconGrid">
                        <!-- Icons will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Color Selector -->
                <div class="color-selector">
                    <label class="form-label">اختر التصنيف</label>
                    <div class="radio-selector" id="colorSelector">
                        <!-- Color options will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBoardBtn">
                        <iconify-icon icon="mdi:check"></iconify-icon>
                        <span>حفظ الحساب</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal settings-modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3">الإعدادات</h3>
                <button class="close-btn" id="closeSettings">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div class="settings-sections">
                <!-- Profile Section -->
                <div class="settings-section">
                    <div class="settings-header">
                        <iconify-icon icon="mdi:account-circle"></iconify-icon>
                        <h4 class="body" style="font-weight: 600;">الملف الشخصي</h4>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الاسم الكامل</span>
                                <span class="settings-description" id="settingsName">محمد</span>
                            </div>
                            <button class="action-btn edit" id="editNameBtn">
                                <iconify-icon icon="mdi:pencil"></iconify-icon>
                                <span>تعديل</span>
                            </button>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">البريد الإلكتروني</span>
                                <span class="settings-description" id="settingsEmail">mohamed@example.com</span>
                            </div>
                            <span class="caption" style="color: var(--text-muted);">ثابت</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">تاريخ الإنشاء</span>
                                <span class="settings-description" id="settingsCreatedAt">25 ديسمبر 2024</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Appearance Section -->
                <div class="settings-section">
                    <div class="settings-header">
                        <iconify-icon icon="mdi:palette"></iconify-icon>
                        <h4 class="body" style="font-weight: 600;">المظهر</h4>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الوضع</span>
                                <span class="settings-description">اختر المظهر المناسب لك</span>
                            </div>
                            <div class="segmented-control" id="themeSelector">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Section -->
                <div class="settings-section">
                    <div class="settings-header">
                        <iconify-icon icon="mdi:shield-lock"></iconify-icon>
                        <h4 class="body" style="font-weight: 600;">الأمان</h4>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">جلسة المستخدم</span>
                                <span class="settings-description">حالة الاتصال الحالية</span>
                            </div>
                            <span class="caption" style="color: var(--success); display: flex; align-items: center; gap: 0.25rem;">
                                <iconify-icon icon="mdi:check-circle"></iconify-icon>
                                نشط
                            </span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">إظهار كلمة المرور</span>
                                <span class="settings-description">طريقة إظهار كلمات المرور</span>
                            </div>
                            <div class="segmented-control" id="passwordVisibilitySelector">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">وضع التصحيح</span>
                                <span class="settings-description">إظهار معلومات التصحيح للأجهزة</span>
                            </div>
                            <div class="segmented-control" id="debugModeSelector">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Plan Section -->
                <div class="settings-section">
                    <div class="settings-header">
                        <iconify-icon icon="mdi:crown"></iconify-icon>
                        <h4 class="body" style="font-weight: 600;">الخطة</h4>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">الخطة الحالية</span>
                                <span class="settings-description">استمتع بميزات NovaPass الأساسية</span>
                            </div>
                            <span class="plan-badge" id="currentPlan">مجانية</span>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">عدد الحسابات</span>
                                <span class="settings-description" id="boardsLimit">غير محدود</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Debug Info (Hidden by default) -->
                <div class="settings-section" id="debugInfoSection" style="display: none;">
                    <div class="settings-header">
                        <iconify-icon icon="mdi:bug"></iconify-icon>
                        <h4 class="body" style="font-weight: 600;">معلومات التصحيح</h4>
                    </div>
                    
                    <div class="settings-items">
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">معرّف الجهاز الحالي</span>
                                <span class="settings-description" id="debugDeviceId">-</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">معرّف المالك</span>
                                <span class="settings-description" id="debugOwnerId">-</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">حالة الجهاز</span>
                                <span class="settings-description" id="debugDeviceStatus">-</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-label">
                                <span class="settings-name">آخر فحص أمني</span>
                                <span class="settings-description" id="debugLastCheck">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" id="logoutSettingsBtn">
                    <iconify-icon icon="mdi:logout"></iconify-icon>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal Template -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3" id="confirmTitle">تأكيد الإجراء</h3>
                <button class="close-btn" id="closeConfirmModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div style="text-align: center; padding: 2rem 0;">
                <div id="confirmIcon" style="width: 80px; height: 80px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                    <!-- Icon will be set by JavaScript -->
                </div>
                
                <h4 class="h3" style="margin-bottom: 1rem;" id="confirmTitleText"></h4>
                <p class="body" style="color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.6;" id="confirmMessage">
                    <!-- Message will be set by JavaScript -->
                </p>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelConfirmBtn">
                    إلغاء
                </button>
                <button type="button" class="btn" id="confirmActionBtn">
                    <!-- Text will be set by JavaScript -->
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="h3">استيراد البيانات القديمة</h3>
                <button class="close-btn" id="closeImportModal">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </button>
            </div>
            
            <div style="text-align: center; padding: 2rem 0;">
                <div class="file-upload" id="fileUploadArea">
                    <iconify-icon icon="mdi:file-upload" class="file-upload-icon"></iconify-icon>
                    <h4 class="h4" style="margin-bottom: 0.5rem;">اسحب وأفلت الملف هنا</h4>
                    <p class="body" style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        أو انقر لاختيار ملف JSON
                    </p>
                    <button type="button" class="btn btn-secondary" id="browseFilesBtn">
                        <iconify-icon icon="mdi:folder-open"></iconify-icon>
                        <span>تصفح الملفات</span>
                    </button>
                    <input type="file" id="importFileInput" class="file-input" accept=".json">
                </div>
                
                <div id="fileInfo" style="display: none; margin-top: 2rem;">
                    <div class="settings-item">
                        <div class="settings-label">
                            <span class="settings-name">الملف المحدد</span>
                            <span class="settings-description" id="fileName">-</span>
                        </div>
                        <button class="action-btn delete" id="removeFileBtn">
                            <iconify-icon icon="mdi:close"></iconify-icon>
                            <span>إزالة</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelImportModalBtn">
                    إلغاء
                </button>
                <button type="button" class="btn btn-primary" id="previewImportBtn" disabled>
                    <iconify-icon icon="mdi:eye"></iconify-icon>
                    <span>معاينة البيانات</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        // ===== FIREBASE IMPORTS =====
        import { 
            auth, 
            db,
            onAuthStateChanged,
            doc, 
            setDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            collection,
            query,
            where,
            orderBy,
            getDocs,
            addDoc,
            serverTimestamp,
            signOut,
            updateProfile
        } from './firebase-config.js';

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let userBoards = [];
        let currentEditingBoard = null;
        let boardToDelete = null;
        let currentDeviceId = null;
        let accountRef = null;
        let userSettings = {};
        let securityData = {};
        let userDevices = [];
        let pendingImportData = null;
        let isOwnerDevice = false;
        let deviceStatus = 'active'; // active, pending, blocked

        // Icon Categories
        const iconCategories = {
            social: [
                { icon: 'logos:facebook', name: 'Facebook' },
                { icon: 'logos:instagram-icon', name: 'Instagram' },
                { icon: 'logos:telegram', name: 'Telegram' },
                { icon: 'logos:twitter', name: 'Twitter' },
                { icon: 'logos:linkedin-icon', name: 'LinkedIn' },
                { icon: 'logos:discord-icon', name: 'Discord' },
                { icon: 'logos:snapchat', name: 'Snapchat' }
            ],
            google: [
                { icon: 'logos:google-gmail', name: 'Gmail' },
                { icon: 'logos:google-drive', name: 'Google Drive' },
                { icon: 'logos:google', name: 'Google' },
                { icon: 'logos:outlook-icon', name: 'Outlook' }
            ],
            work: [
                { icon: 'logos:github-icon', name: 'GitHub' },
                { icon: 'logos:gitlab', name: 'GitLab' },
                { icon: 'logos:bitbucket', name: 'Bitbucket' },
                { icon: 'logos:slack-icon', name: 'Slack' },
                { icon: 'logos:notion-icon', name: 'Notion' }
            ],
            finance: [
                { icon: 'logos:paypal', name: 'PayPal' },
                { icon: 'logos:visa', name: 'Visa' },
                { icon: 'logos:mastercard', name: 'Mastercard' },
                { icon: 'logos:stripe', name: 'Stripe' }
            ],
            generic: [
                { icon: 'mdi:web', name: 'Website' },
                { icon: 'mdi:lock', name: 'Lock' },
                { icon: 'mdi:key', name: 'Key' },
                { icon: 'mdi:account', name: 'Account' },
                { icon: 'mdi:shield-lock', name: 'Shield' },
                { icon: 'mdi:email', name: 'Email' },
                { icon: 'mdi:cloud', name: 'Cloud' },
                { icon: 'mdi:database', name: 'Database' }
            ]
        };

        // Flatten icons array
        const allIcons = [
            ...iconCategories.social,
            ...iconCategories.google,
            ...iconCategories.work,
            ...iconCategories.finance,
            ...iconCategories.generic
        ];

        // Color options with labels and icons
        const colorOptions = [
            { color: '#3EB489', label: 'شخصي', class: 'personal', icon: 'mdi:account' },
            { color: '#4ECDC4', label: 'عمل', class: 'work', icon: 'mdi:briefcase' },
            { color: '#FF6B6B', label: 'مهم', class: 'important', icon: 'mdi:star' },
            { color: '#9D4EDD', label: 'اجتماعي', class: 'social', icon: 'mdi:account-group' },
            { color: '#FFD166', label: 'مالي', class: 'finance', icon: 'mdi:currency-usd' },
            { color: '#118AB2', label: 'أخرى', class: 'other', icon: 'mdi:dots-horizontal' }
        ];

        // Theme options
        const themeOptions = [
            { value: 'light', label: 'فاتح', icon: 'mdi:weather-sunny' },
            { value: 'dark', label: 'داكن', icon: 'mdi:weather-night' },
            { value: 'system', label: 'النظام', icon: 'mdi:laptop' }
        ];

        // Password visibility options
        const passwordVisibilityOptions = [
            { value: 'hold', label: 'الضغط المطول', icon: 'mdi:timer-outline' },
            { value: 'click', label: 'النقر', icon: 'mdi:cursor-click' },
            { value: 'always', label: 'دائماً', icon: 'mdi:eye-outline' }
        ];

        // Debug mode options
        const debugModeOptions = [
            { value: 'off', label: 'مخفي', icon: 'mdi:eye-off' },
            { value: 'on', label: 'مرئي', icon: 'mdi:eye' }
        ];

        // Category names for filter
        const categoryNames = {
            social: 'اجتماعي',
            google: 'جوجل',
            work: 'عمل',
            finance: 'مالي',
            generic: 'عام'
        };

        // Password strength criteria
        const passwordCriteria = [
            { id: 'length', label: '8 أحرف على الأقل', test: (p) => p.length >= 8, weight: 20 },
            { id: 'lowercase', label: 'حرف صغير', test: (p) => /[a-z]/.test(p), weight: 15 },
            { id: 'uppercase', label: 'حرف كبير', test: (p) => /[A-Z]/.test(p), weight: 15 },
            { id: 'numbers', label: 'رقم', test: (p) => /[0-9]/.test(p), weight: 15 },
            { id: 'special', label: 'رمز خاص', test: (p) => /[^A-Za-z0-9]/.test(p), weight: 15 },
            { id: 'length12', label: '12 حرف أو أكثر', test: (p) => p.length >= 12, weight: 10 },
            { id: 'unique', label: 'أحرف متنوعة', test: (p) => new Set(p).size >= 8, weight: 10 }
        ];

        // Activity types
        const activityIcons = {
            login: { icon: 'mdi:login', label: 'تسجيل دخول' },
            logout: { icon: 'mdi:logout', label: 'تسجيل خروج' },
            add: { icon: 'mdi:plus', label: 'إضافة حساب' },
            edit: { icon: 'mdi:pencil', label: 'تعديل حساب' },
            delete: { icon: 'mdi:delete', label: 'حذف حساب' },
            copy: { icon: 'mdi:content-copy', label: 'نسخ كلمة مرور' },
            theme: { icon: 'mdi:palette', label: 'تغيير المظهر' },
            device_logout: { icon: 'mdi:device-off', label: 'تسجيل خروج من جهاز' },
            trust: { icon: 'mdi:shield-check', label: 'تعيين جهاز كموثوق' },
            block: { icon: 'mdi:block-helper', label: 'منع جهاز' },
            unblock: { icon: 'mdi:lock-open', label: 'إلغاء منع جهاز' },
            approve: { icon: 'mdi:check-circle', label: 'موافقة على جهاز' },
            import: { icon: 'mdi:database-import', label: 'استيراد بيانات' },
            export: { icon: 'mdi:database-export', label: 'تصدير بيانات' }
        };

        const activityDescriptions = {
            login: (details) => `تم تسجيل الدخول ${details.isNewDevice ? 'من جهاز جديد' : ''}`,
            logout: () => 'تم تسجيل الخروج',
            add: (details) => `تم إضافة حساب جديد: ${details.boardName || ''}`,
            edit: (details) => `تم تعديل حساب: ${details.boardName || ''}`,
            delete: (details) => `تم حذف حساب: ${details.boardName || ''}`,
            copy: (details) => `تم نسخ كلمة مرور لحساب: ${details.boardName || ''}`,
            theme: (details) => `تم تغيير المظهر إلى الوضع ${details.theme === 'dark' ? 'الداكن' : 'الفاتح'}`,
            device_logout: (details) => `تم تسجيل الخروج من جهاز: ${details.deviceName || ''}`,
            trust: (details) => `تم ${details.trusted ? 'تعيين' : 'إلغاء'} الثقة في جهاز: ${details.deviceName || ''}`,
            block: (details) => `تم ${details.permanent ? 'منع نهائي' : 'منع مؤقت'} لجهاز: ${details.deviceName || ''}`,
            unblock: (details) => `تم إلغاء منع جهاز: ${details.deviceName || ''}`,
            approve: (details) => `تم الموافقة على جهاز: ${details.deviceName || ''}`,
            import: (details) => `تم استيراد ${details.count || 0} حساب من البيانات القديمة`,
            export: (details) => `تم تصدير ${details.count || 0} حساب كبيانات قديمة`
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            setupEventListeners();
            checkAuth();
        });

        // ===== AUTH CHECK =====
        async function checkAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                currentUser = user;
                currentDeviceId = getStableDeviceId();
                await initializeAccount();
                await checkDeviceAccess();
                await loadUserData();
                updateUserUI();
            });
        }

        // ===== ACCOUNT-CENTRIC STRUCTURE =====
        async function initializeAccount() {
            if (!currentUser) return;
            
            accountRef = doc(db, 'accounts', currentUser.uid);
            const accountDoc = await getDoc(accountRef);
            
            if (!accountDoc.exists()) {
                // Create new account with full account-centric structure
                await setDoc(accountRef, {
                    profile: {
                        name: currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم',
                        email: currentUser.email,
                        plan: 'مجانية',
                        createdAt: serverTimestamp()
                    },
                    vault: {
                        boards: []
                    },
                    settings: {
                        theme: 'light',
                        passwordVisibility: 'hold',
                        debugMode: 'off'
                    },
                    security: {
                        ownerDeviceId: currentDeviceId,
                        blockedDevices: {},
                        pendingDevices: {},
                        permissions: {}
                    },
                    migration: {
                        oldData: null,
                        migrated: false,
                        migratedAt: null
                    },
                    lastUpdated: serverTimestamp()
                });
                
                // Create devices subcollection
                await registerOrUpdateDevice(true);
                await logActivity('login', { isNewDevice: true, isOwner: true });
            } else {
                // Load existing account data
                const data = accountDoc.data();
                userSettings = data.settings || {};
                securityData = data.security || {};
                applyTheme(userSettings.theme || 'light');
                
                // Update device registration
                await registerOrUpdateDevice(false);
                await logActivity('login', { isNewDevice: false });
            }
        }

        // ===== DEVICE ACCESS CONTROL =====
        async function checkDeviceAccess() {
            if (!accountRef || !securityData) return;
            
            const { ownerDeviceId = '', blockedDevices = {}, pendingDevices = {} } = securityData;
            
            // Check if current device is owner
            isOwnerDevice = (ownerDeviceId === currentDeviceId);
            
            // Check if device is blocked
            if (blockedDevices[currentDeviceId]) {
                deviceStatus = 'blocked';
                showAccessOverlay('blocked', blockedDevices[currentDeviceId]);
                return;
            }
            
            // Check if device is pending (non-owner devices)
            if (!isOwnerDevice && !pendingDevices[currentDeviceId]) {
                // Add to pending devices if not owner
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${currentDeviceId}`]: {
                        deviceId: currentDeviceId,
                        addedAt: serverTimestamp(),
                        status: 'pending'
                    }
                }, { merge: true });
                
                deviceStatus = 'pending';
                showAccessOverlay('pending');
            } else if (pendingDevices[currentDeviceId]) {
                deviceStatus = 'pending';
                showAccessOverlay('pending');
            } else {
                deviceStatus = 'active';
            }
        }

        function showAccessOverlay(type, blockData = null) {
            const overlay = document.getElementById('accessOverlay');
            const message = document.getElementById('accessMessage');
            
            if (!overlay || !message) return;
            
            let title = '';
            let text = '';
            let icon = '';
            let actions = '';
            
            switch(type) {
                case 'blocked':
                    title = '⛔ تم منع هذا الجهاز';
                    text = blockData?.reason || 'تم منع هذا الجهاز من الوصول إلى هذا الحساب.';
                    if (blockData?.blockedAt) {
                        const blockedDate = new Date(blockData.blockedAt.seconds * 1000);
                        text += `<br><small>تم المنع في: ${formatDate(blockedDate)}</small>`;
                    }
                    icon = '<iconify-icon icon="mdi:block-helper" style="font-size: 2.5rem;"></iconify-icon>';
                    actions = `
                        <button class="btn btn-danger" id="blockedLogoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </button>
                    `;
                    break;
                    
                case 'pending':
                    title = '⏳ في انتظار الموافقة';
                    text = 'هذا الجهاز في انتظار موافقة الجهاز الرئيسي. يرجى الانتظار أو تسجيل الخروج.';
                    icon = '<iconify-icon icon="mdi:clock-outline" style="font-size: 2.5rem;"></iconify-icon>';
                    actions = `
                        <button class="btn btn-secondary" id="refreshAccessBtn" style="margin-left: 0.5rem;">
                            <iconify-icon icon="mdi:refresh"></iconify-icon>
                            <span>تحديث الحالة</span>
                        </button>
                        <button class="btn btn-danger" id="pendingLogoutBtn">
                            <iconify-icon icon="mdi:logout"></iconify-icon>
                            <span>تسجيل الخروج</span>
                        </button>
                    `;
                    break;
            }
            
            message.innerHTML = `
                <div class="access-icon ${type}">
                    ${icon}
                </div>
                <h3 class="h3">${title}</h3>
                <p class="body">${text}</p>
                <div class="access-actions">
                    ${actions}
                </div>
            `;
            
            overlay.style.display = 'flex';
            
            // Setup event listeners for overlay buttons
            setTimeout(() => {
                document.getElementById('blockedLogoutBtn')?.addEventListener('click', handleLogout);
                document.getElementById('pendingLogoutBtn')?.addEventListener('click', handleLogout);
                document.getElementById('refreshAccessBtn')?.addEventListener('click', async () => {
                    await checkDeviceAccess();
                });
            }, 100);
        }

        function hideAccessOverlay() {
            const overlay = document.getElementById('accessOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ===== DEVICE MANAGEMENT =====
        function getStableDeviceId() {
            let deviceId = localStorage.getItem('novapass_device_id');
            
            if (!deviceId) {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substr(2, 8);
                deviceId = `device_${timestamp}_${random}`;
                localStorage.setItem('novapass_device_id', deviceId);
            }
            
            return deviceId;
        }

        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceName = 'Unknown Device';
            let browser = 'Unknown Browser';
            let os = 'Unknown OS';
            
            // Detect device type
            if (/mobile/i.test(userAgent)) {
                deviceName = 'هاتف محمول';
            } else if (/tablet/i.test(userAgent)) {
                deviceName = 'تابلت';
            } else {
                deviceName = 'حاسوب';
            }
            
            // Detect browser
            if (/edg/i.test(userAgent)) {
                browser = 'Microsoft Edge';
            } else if (/chrome/i.test(userAgent) && !/edg/i.test(userAgent)) {
                browser = 'Google Chrome';
            } else if (/firefox/i.test(userAgent)) {
                browser = 'Mozilla Firefox';
            } else if (/safari/i.test(userAgent) && !/chrome/i.test(userAgent)) {
                browser = 'Safari';
            } else if (/opera/i.test(userAgent)) {
                browser = 'Opera';
            }
            
            // Detect OS
            if (/windows/i.test(userAgent)) {
                os = 'Windows';
            } else if (/macintosh/i.test(userAgent)) {
                os = 'macOS';
            } else if (/linux/i.test(userAgent)) {
                os = 'Linux';
            } else if (/android/i.test(userAgent)) {
                os = 'Android';
            } else if (/iphone|ipad|ipod/i.test(userAgent)) {
                os = 'iOS';
            }
            
            return { 
                name: deviceName, 
                browser, 
                os,
                userAgent: userAgent.substring(0, 100)
            };
        }

        async function registerOrUpdateDevice(isFirstDevice = false) {
            if (!accountRef) return;
            
            const deviceInfo = getDeviceInfo();
            
            const devicesRef = collection(accountRef, 'devices');
            const deviceDocRef = doc(devicesRef, currentDeviceId);
            
            const deviceData = {
                deviceName: deviceInfo.name,
                browser: deviceInfo.browser,
                os: deviceInfo.os,
                userAgent: deviceInfo.userAgent,
                isCurrent: true,
                trusted: isOwnerDevice,
                lastActive: serverTimestamp(),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            const deviceDoc = await getDoc(deviceDocRef);
            
            if (deviceDoc.exists()) {
                // Update existing device
                await updateDoc(deviceDocRef, {
                    ...deviceData,
                    createdAt: deviceDoc.data().createdAt
                });
            } else {
                // Create new device
                await setDoc(deviceDocRef, deviceData);
            }
            
            // Update other devices to not current
            const allDevices = await getDocs(devicesRef);
            allDevices.forEach(async (doc) => {
                if (doc.id !== currentDeviceId) {
                    await updateDoc(doc.ref, {
                        isCurrent: false,
                        updatedAt: serverTimestamp()
                    });
                }
            });
        }

        async function loadDevices() {
            if (!accountRef) return [];
            
            try {
                const devicesRef = collection(accountRef, 'devices');
                const q = query(devicesRef, orderBy('lastActive', 'desc'));
                const snapshot = await getDocs(q);
                
                const devices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    devices.push({
                        id: doc.id,
                        ...data,
                        lastActive: data.lastActive?.toDate?.() || new Date(),
                        createdAt: data.createdAt?.toDate?.() || new Date()
                    });
                });
                
                return devices;
            } catch (error) {
                console.error('Error loading devices:', error);
                return [];
            }
        }

        async function updateDeviceStatus(deviceId, updates) {
            try {
                const deviceRef = doc(accountRef, 'devices', deviceId);
                await updateDoc(deviceRef, {
                    ...updates,
                    updatedAt: serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('Error updating device:', error);
                return false;
            }
        }

        // ===== SECURITY MANAGEMENT =====
        async function blockDevice(deviceId, permanent = false, reason = '') {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه منع الأجهزة', 'error');
                return false;
            }
            
            try {
                const blockData = {
                    deviceId,
                    blockedAt: serverTimestamp(),
                    blockedBy: currentDeviceId,
                    permanent,
                    reason: reason || (permanent ? 'منع نهائي' : 'منع مؤقت')
                };
                
                await updateDoc(accountRef, {
                    [`security.blockedDevices.${deviceId}`]: blockData
                }, { merge: true });
                
                // Remove from pending if exists
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await logActivity('block', { 
                    deviceId, 
                    permanent, 
                    reason,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error blocking device:', error);
                return false;
            }
        }

        async function unblockDevice(deviceId) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه إلغاء منع الأجهزة', 'error');
                return false;
            }
            
            try {
                await updateDoc(accountRef, {
                    [`security.blockedDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await logActivity('unblock', { 
                    deviceId,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error unblocking device:', error);
                return false;
            }
        }

        async function approveDevice(deviceId) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه الموافقة على الأجهزة', 'error');
                return false;
            }
            
            try {
                await updateDoc(accountRef, {
                    [`security.pendingDevices.${deviceId}`]: deleteField()
                }, { merge: true });
                
                await updateDeviceStatus(deviceId, { trusted: true });
                
                await logActivity('approve', { 
                    deviceId,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error approving device:', error);
                return false;
            }
        }

        async function toggleDeviceTrust(deviceId, trusted) {
            if (!isOwnerDevice) {
                showToast('فقط الجهاز الرئيسي يمكنه تغيير حالة الثقة', 'error');
                return false;
            }
            
            try {
                await updateDeviceStatus(deviceId, { trusted });
                
                await logActivity('trust', { 
                    deviceId,
                    trusted,
                    deviceName: userDevices.find(d => d.id === deviceId)?.deviceName || deviceId
                });
                
                return true;
            } catch (error) {
                console.error('Error toggling device trust:', error);
                return false;
            }
        }

        // ===== ACTIVITY LOGS =====
        async function logActivity(action, details = {}) {
            if (!accountRef) return;
            
            try {
                const logsRef = collection(accountRef, 'activity_logs');
                const deviceInfo = getDeviceInfo();
                
                await addDoc(logsRef, {
                    action,
                    details,
                    deviceId: currentDeviceId,
                    deviceName: deviceInfo.name,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function loadActivityLogs(filter = 'all') {
            if (!accountRef) return [];
            
            try {
                const logsRef = collection(accountRef, 'activity_logs');
                const q = query(logsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                const logs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    logs.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate?.() || new Date()
                    });
                });
                
                if (filter !== 'all') {
                    return logs.filter(log => 
                        (filter === 'security' && ['login', 'logout', 'device_logout', 'trust', 'block', 'unblock', 'approve'].includes(log.action)) ||
                        (filter === 'vault' && ['add', 'edit', 'delete', 'copy'].includes(log.action)) ||
                        (filter === 'migration' && ['import', 'export'].includes(log.action))
                    );
                }
                
                return logs;
            } catch (error) {
                console.error('Error loading activity logs:', error);
                return [];
            }
        }

        // ===== MIGRATION SYSTEM =====
        async function exportOldData() {
            try {
                // Get old data from account
                const accountDoc = await getDoc(accountRef);
                const data = accountDoc.data();
                
                const exportData = {
                    exportedAt: new Date().toISOString(),
                    accounts: data.vault?.boards || [],
                    metadata: {
                        totalAccounts: data.vault?.boards?.length || 0,
                        userEmail: currentUser.email,
                        exportVersion: '1.0'
                    }
                };
                
                // Create JSON file
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `novapass-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                await logActivity('export', { count: exportData.accounts.length });
                showToast('تم تصدير البيانات بنجاح', 'success');
                
                return true;
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('حدث خطأ أثناء تصدير البيانات', 'error');
                return false;
            }
        }

        async function importOldData(data) {
            try {
                // Validate data structure
                if (!data.accounts || !Array.isArray(data.accounts)) {
                    throw new Error('بيانات غير صالحة');
                }
                
                // Merge with existing boards
                const existingBoards = userBoards || [];
                const importedBoards = data.accounts.map(board => ({
                    ...board,
                    id: generateId(),
                    importedAt: new Date().toISOString(),
                    createdAt: board.createdAt || new Date().toISOString()
                }));
                
                const mergedBoards = [...existingBoards, ...importedBoards];
                
                // Update account with merged data
                await updateDoc(accountRef, {
                    'vault.boards': mergedBoards,
                    'migration.oldData': data,
                    'migration.migrated': true,
                    'migration.migratedAt': serverTimestamp(),
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                userBoards = mergedBoards;
                renderBoards();
                
                await logActivity('import', { count: importedBoards.length });
                showToast(`تم استيراد ${importedBoards.length} حساب بنجاح`, 'success');
                
                return true;
            } catch (error) {
                console.error('Error importing data:', error);
                showToast('حدث خطأ أثناء استيراد البيانات', 'error');
                return false;
            }
        }

        // ===== UI INITIALIZATION =====
        function initializeUI() {
            setupIconCategories();
            populateIconGrid();
            setupColorSelector();
            setupPasswordStrength();
            setupThemeSelector();
            setupPasswordVisibilitySelector();
            setupDebugModeSelector();
        }

        function setupIconCategories() {
            const categoriesContainer = document.getElementById('iconCategories');
            if (!categoriesContainer) return;
            
            categoriesContainer.innerHTML = '';
            
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn active';
            allBtn.textContent = 'الكل';
            allBtn.setAttribute('data-category', 'all');
            allBtn.addEventListener('click', (e) => filterIconsByCategory('all', e.target));
            categoriesContainer.appendChild(allBtn);
            
            Object.keys(categoryNames).forEach(categoryKey => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = categoryNames[categoryKey];
                btn.setAttribute('data-category', categoryKey);
                btn.addEventListener('click', (e) => filterIconsByCategory(categoryKey, e.target));
                categoriesContainer.appendChild(btn);
            });
        }

        function populateIconGrid() {
            const iconGrid = document.getElementById('iconGrid');
            if (!iconGrid) return;
            
            iconGrid.innerHTML = '';
            
            allIcons.forEach((iconData, index) => {
                const iconElement = createIconElement(iconData, index === 0);
                iconGrid.appendChild(iconElement);
            });
        }

        function createIconElement(iconData, isSelected = false) {
            const iconElement = document.createElement('div');
            iconElement.className = `icon-option ${isSelected ? 'selected' : ''}`;
            iconElement.setAttribute('data-icon', iconData.icon);
            iconElement.setAttribute('data-name', iconData.name);
            iconElement.setAttribute('title', iconData.name);
            
            let category = 'generic';
            if (iconCategories.social.includes(iconData)) category = 'social';
            else if (iconCategories.google.includes(iconData)) category = 'google';
            else if (iconCategories.work.includes(iconData)) category = 'work';
            else if (iconCategories.finance.includes(iconData)) category = 'finance';
            
            iconElement.setAttribute('data-category', category);
            
            try {
                iconElement.innerHTML = `<iconify-icon icon="${iconData.icon}"></iconify-icon>`;
            } catch (error) {
                iconElement.innerHTML = `<iconify-icon icon="mdi:web"></iconify-icon>`;
            }
            
            iconElement.addEventListener('click', () => {
                selectIcon(iconElement);
            });
            
            return iconElement;
        }

        function filterIconsByCategory(category, button) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            const iconOptions = document.querySelectorAll('.icon-option');
            iconOptions.forEach(icon => {
                if (category === 'all') {
                    icon.style.display = 'flex';
                } else {
                    icon.style.display = icon.getAttribute('data-category') === category ? 'flex' : 'none';
                }
            });
        }

        function setupColorSelector() {
            const colorSelector = document.getElementById('colorSelector');
            if (!colorSelector) return;
            
            colorSelector.innerHTML = '';
            
            colorOptions.forEach((colorData, index) => {
                const colorElement = document.createElement('div');
                colorElement.className = 'radio-option';
                
                colorElement.innerHTML = `
                    <div class="radio-circle" style="background: ${colorData.color};" 
                         data-color="${colorData.color}" 
                         data-class="${colorData.class}"
                         data-label="${colorData.label}"
                         title="${colorData.label}">
                        <iconify-icon icon="${colorData.icon}"></iconify-icon>
                    </div>
                    <span class="radio-label">${colorData.label}</span>
                `;
                
                const radioCircle = colorElement.querySelector('.radio-circle');
                radioCircle.addEventListener('click', () => {
                    selectColor(radioCircle);
                });
                
                if (index === 0) {
                    radioCircle.classList.add('selected');
                }
                
                colorSelector.appendChild(colorElement);
            });
        }

        function setupPasswordStrength() {
            const passwordInput = document.getElementById('boardPassword');
            if (!passwordInput) return;
            
            passwordInput.addEventListener('input', updatePasswordStrength);
            updatePasswordStrength();
        }

        function updatePasswordStrength() {
            const password = document.getElementById('boardPassword').value;
            const strengthFill = document.getElementById('strengthFill');
            const strengthDetails = document.getElementById('strengthDetails');
            const strengthScore = document.getElementById('strengthScore');
            
            if (!strengthFill || !strengthDetails || !strengthScore) return;
            
            let totalScore = 0;
            let totalWeight = 0;
            
            const criteriaResults = passwordCriteria.map(criteria => {
                const passes = criteria.test(password);
                const score = passes ? criteria.weight : 0;
                totalScore += score;
                totalWeight += criteria.weight;
                
                return {
                    ...criteria,
                    passes,
                    score
                };
            });
            
            const lengthBonus = Math.min(password.length * 2, 20);
            totalScore += lengthBonus;
            totalWeight += 20;
            
            const percentage = Math.min(Math.round((totalScore / totalWeight) * 100), 100);
            
            strengthFill.style.width = `${percentage}%`;
            strengthScore.textContent = `${percentage}%`;
            
            strengthDetails.innerHTML = '';
            criteriaResults.forEach(criteria => {
                const criteriaElement = document.createElement('div');
                criteriaElement.className = `strength-criteria ${criteria.passes ? 'valid' : ''}`;
                criteriaElement.innerHTML = `
                    <iconify-icon icon="${criteria.passes ? 'mdi:check-circle' : 'mdi:close-circle'}"></iconify-icon>
                    <span>${criteria.label}</span>
                `;
                strengthDetails.appendChild(criteriaElement);
            });
            
            const lengthElement = document.createElement('div');
            lengthElement.className = 'strength-criteria valid';
            lengthElement.innerHTML = `
                <iconify-icon icon="mdi:check-circle"></iconify-icon>
                <span>${password.length} حرف (${lengthBonus}%)</span>
            `;
            strengthDetails.appendChild(lengthElement);
        }

        function setupThemeSelector() {
            const themeSelector = document.getElementById('themeSelector');
            if (!themeSelector) return;
            
            themeSelector.innerHTML = '';
            
            themeOptions.forEach(theme => {
                const option = document.createElement('div');
                option.className = 'segmented-option';
                option.setAttribute('data-theme', theme.value);
                option.innerHTML = `
                    <iconify-icon icon="${theme.icon}"></iconify-icon>
                    <span>${theme.label}</span>
                `;
                
                option.addEventListener('click', () => {
                    selectTheme(option);
                });
                
                themeSelector.appendChild(option);
                
                if (theme.value === (userSettings.theme || 'light')) {
                    option.classList.add('selected');
                }
            });
        }

        function setupPasswordVisibilitySelector() {
            const selector = document.getElementById('passwordVisibilitySelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            
            passwordVisibilityOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'segmented-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.innerHTML = `
                    <iconify-icon icon="${option.icon}"></iconify-icon>
                    <span>${option.label}</span>
                `;
                
                optionElement.addEventListener('click', () => {
                    selectPasswordVisibility(optionElement);
                });
                
                selector.appendChild(optionElement);
                
                if (option.value === (userSettings.passwordVisibility || 'hold')) {
                    optionElement.classList.add('selected');
                }
            });
        }

        function setupDebugModeSelector() {
            const selector = document.getElementById('debugModeSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            
            debugModeOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'segmented-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.innerHTML = `
                    <iconify-icon icon="${option.icon}"></iconify-icon>
                    <span>${option.label}</span>
                `;
                
                optionElement.addEventListener('click', () => {
                    selectDebugMode(optionElement);
                });
                
                selector.appendChild(optionElement);
                
                if (option.value === (userSettings.debugMode || 'off')) {
                    optionElement.classList.add('selected');
                }
            });
        }

        // ===== THEME MANAGEMENT =====
        function applyTheme(theme) {
            let isDark = false;
            
            if (theme === 'system') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = theme === 'dark';
            }
            
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('novapass_theme', theme);
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Navigation Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const sectionId = e.currentTarget.getAttribute('data-section');
                    showSection(sectionId);
                    
                    // Update active tab
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    e.currentTarget.classList.add('active');
                });
            });
            
            // Profile dropdown navigation
            document.querySelectorAll('.dropdown-item[data-section]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.currentTarget.getAttribute('data-section');
                    showSection(sectionId);
                    
                    // Update active tab
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.getAttribute('data-section') === sectionId) {
                            tab.classList.add('active');
                        }
                    });
                    
                    closeProfileDropdown();
                });
            });
            
            // Floating add button
            document.getElementById('floatingAddBtn')?.addEventListener('click', () => openBoardModal('add'));
            document.getElementById('firstBoardBtn')?.addEventListener('click', () => openBoardModal('add'));
            
            // Profile dropdown
            document.getElementById('profileBtn')?.addEventListener('click', toggleProfileDropdown);
            document.addEventListener('click', closeProfileDropdown);
            
            // Icon search
            document.getElementById('iconSearch')?.addEventListener('input', searchIcons);
            
            // Modals
            document.getElementById('closeModal')?.addEventListener('click', closeAllModals);
            document.getElementById('cancelBtn')?.addEventListener('click', closeAllModals);
            document.getElementById('closeConfirmModal')?.addEventListener('click', closeAllModals);
            document.getElementById('cancelConfirmBtn')?.addEventListener('click', closeAllModals);
            document.getElementById('closeSettings')?.addEventListener('click', closeAllModals);
            document.getElementById('closeImportModal')?.addEventListener('click', closeAllModals);
            document.getElementById('cancelImportModalBtn')?.addEventListener('click', closeAllModals);
            document.getElementById('closePreviewBtn')?.addEventListener('click', closeDataPreview);
            document.getElementById('cancelImportBtn')?.addEventListener('click', closeDataPreview);
            
            // Board form
            document.getElementById('boardForm')?.addEventListener('submit', handleBoardSubmit);
            
            // Confirm action
            document.getElementById('confirmActionBtn')?.addEventListener('click', handleConfirmAction);
            
            // Settings
            document.getElementById('settingsBtn')?.addEventListener('click', openSettingsModal);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('logoutSettingsBtn')?.addEventListener('click', handleLogout);
            document.getElementById('editNameBtn')?.addEventListener('click', editUserName);
            
            // Old Data actions
            document.getElementById('exportOldDataBtn')?.addEventListener('click', exportOldData);
            document.getElementById('importOldDataBtn')?.addEventListener('click', openImportModal);
            document.getElementById('browseFilesBtn')?.addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });
            document.getElementById('importFileInput')?.addEventListener('change', handleFileSelect);
            document.getElementById('previewImportBtn')?.addEventListener('click', previewImportData);
            document.getElementById('confirmImportBtn')?.addEventListener('click', confirmImportData);
            document.getElementById('removeFileBtn')?.addEventListener('click', removeSelectedFile);
            
            // File upload drag & drop
            const fileUploadArea = document.getElementById('fileUploadArea');
            if (fileUploadArea) {
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });
                
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect({ target: { files } });
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAllModals();
                if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    openBoardModal('add');
                }
            });
            
            // System theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (userSettings.theme === 'system') {
                    applyTheme('system');
                }
            });
        }

        function searchIcons(e) {
            const searchTerm = e.target.value.toLowerCase();
            const iconOptions = document.querySelectorAll('.icon-option');
            
            iconOptions.forEach(icon => {
                const iconName = icon.getAttribute('data-name').toLowerCase();
                if (iconName.includes(searchTerm)) {
                    icon.style.display = 'flex';
                } else {
                    icon.style.display = 'none';
                }
            });
        }

        // ===== SECTION MANAGEMENT =====
        function showSection(sectionId) {
            // Hide access overlay if showing
            hideAccessOverlay();
            
            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                updateNavLabel(sectionId);
                
                // Load section data
                switch(sectionId) {
                    case 'devicesSection':
                        loadAndRenderDevices();
                        break;
                    case 'activitySection':
                        loadAndRenderActivityLogs();
                        setupActivityFilters();
                        break;
                    case 'olddataSection':
                        // Nothing to load
                        break;
                }
            }
            
            // Show/hide floating button
            const floatingBtn = document.getElementById('floatingAddBtn');
            if (floatingBtn) {
                floatingBtn.style.display = sectionId === 'dashboardSection' ? 'flex' : 'none';
            }
        }

        function updateNavLabel(sectionId) {
            const label = document.getElementById('dashboardLabel');
            switch(sectionId) {
                case 'devicesSection': label.textContent = 'الأجهزة'; break;
                case 'activitySection': label.textContent = 'سجلات النشاط'; break;
                case 'olddataSection': label.textContent = 'البيانات القديمة'; break;
                default: label.textContent = 'Dashboard';
            }
        }

        // ===== PROFILE DROPDOWN =====
        function toggleProfileDropdown(e) {
            e?.stopPropagation();
            document.getElementById('profileDropdown')?.classList.toggle('active');
        }

        function closeProfileDropdown(e) {
            if (!e?.target.closest('.user-profile')) {
                document.getElementById('profileDropdown')?.classList.remove('active');
            }
        }

        // ===== MODAL MANAGEMENT =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            resetBoardForm();
            resetImportModal();
        }

        function openBoardModal(mode, board = null) {
            const modal = document.getElementById('boardModal');
            const title = document.getElementById('modalTitle');
            
            if (!modal || !title) return;
            
            if (mode === 'edit' && board) {
                title.textContent = 'تعديل الحساب';
                document.getElementById('boardId').value = board.id;
                document.getElementById('boardName').value = board.name;
                document.getElementById('boardEmail').value = board.email;
                document.getElementById('boardPassword').value = board.password;
                updatePasswordStrength();
                
                const iconToSelect = document.querySelector(`.icon-option[data-icon="${board.icon}"]`);
                if (iconToSelect) {
                    document.querySelectorAll('.icon-option').forEach(icon => icon.classList.remove('selected'));
                    iconToSelect.classList.add('selected');
                }
                
                const colorToSelect = document.querySelector(`.radio-circle[data-color="${board.color}"]`);
                if (colorToSelect) {
                    document.querySelectorAll('.radio-circle').forEach(circle => circle.classList.remove('selected'));
                    colorToSelect.classList.add('selected');
                }
                
                currentEditingBoard = board.id;
            } else {
                title.textContent = 'إضافة حساب جديد';
                currentEditingBoard = null;
            }
            
            openModal('boardModal');
            document.getElementById('boardName').focus();
        }

        function resetBoardForm() {
            const boardForm = document.getElementById('boardForm');
            if (boardForm) {
                boardForm.reset();
                document.getElementById('boardId').value = '';
                document.getElementById('iconSearch').value = '';
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.category-btn[data-category="all"]').classList.add('active');
                showAllIcons();
                currentEditingBoard = null;
                updatePasswordStrength();
            }
        }

        function showAllIcons() {
            const iconOptions = document.querySelectorAll('.icon-option');
            iconOptions.forEach(icon => {
                icon.style.display = 'flex';
            });
        }

        // ===== IMPORT MODAL FUNCTIONS =====
        function openImportModal() {
            resetImportModal();
            openModal('importModal');
        }

        function resetImportModal() {
            const fileInput = document.getElementById('importFileInput');
            const fileInfo = document.getElementById('fileInfo');
            const previewBtn = document.getElementById('previewImportBtn');
            
            if (fileInput) fileInput.value = '';
            if (fileInfo) fileInfo.style.display = 'none';
            if (previewBtn) previewBtn.disabled = true;
            
            pendingImportData = null;
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.name.endsWith('.json')) {
                showToast('الرجاء اختيار ملف JSON فقط', 'error');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error');
                return;
            }
            
            // Read file
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    pendingImportData = data;
                    
                    // Update UI
                    const fileInfo = document.getElementById('fileInfo');
                    const fileName = document.getElementById('fileName');
                    const previewBtn = document.getElementById('previewImportBtn');
                    
                    if (fileInfo && fileName && previewBtn) {
                        fileName.textContent = `${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
                        fileInfo.style.display = 'block';
                        previewBtn.disabled = false;
                    }
                    
                    showToast('تم تحميل الملف بنجاح', 'success');
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showToast('خطأ في قراءة الملف. تأكد من صحة تنسيق JSON', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function removeSelectedFile() {
            const fileInput = document.getElementById('importFileInput');
            const fileInfo = document.getElementById('fileInfo');
            const previewBtn = document.getElementById('previewImportBtn');
            
            if (fileInput) fileInput.value = '';
            if (fileInfo) fileInfo.style.display = 'none';
            if (previewBtn) previewBtn.disabled = true;
            
            pendingImportData = null;
        }

        function previewImportData() {
            if (!pendingImportData) {
                showToast('لا توجد بيانات للمعاينة', 'error');
                return;
            }
            
            try {
                const previewContent = document.getElementById('dataPreviewContent');
                const previewContainer = document.getElementById('dataPreviewContainer');
                
                if (previewContent && previewContainer) {
                    // Format and display data
                    const formattedData = JSON.stringify(pendingImportData, null, 2);
                    previewContent.textContent = formattedData;
                    previewContainer.style.display = 'block';
                    
                    // Scroll to preview
                    previewContainer.scrollIntoView({ behavior: 'smooth' });
                    
                    closeAllModals();
                }
            } catch (error) {
                console.error('Error previewing data:', error);
                showToast('حدث خطأ أثناء معاينة البيانات', 'error');
            }
        }

        function closeDataPreview() {
            const previewContainer = document.getElementById('dataPreviewContainer');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        }

        async function confirmImportData() {
            if (!pendingImportData) {
                showToast('لا توجد بيانات للاستيراد', 'error');
                return;
            }
            
            try {
                const success = await importOldData(pendingImportData);
                if (success) {
                    closeDataPreview();
                    resetImportModal();
                }
            } catch (error) {
                console.error('Error confirming import:', error);
                showToast('حدث خطأ أثناء استيراد البيانات', 'error');
            }
        }

        // ===== CONFIRM MODAL SYSTEM =====
        let currentConfirmAction = null;
        let currentConfirmData = null;

        function showConfirmModal(config) {
            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmTitle');
            const titleText = document.getElementById('confirmTitleText');
            const message = document.getElementById('confirmMessage');
            const icon = document.getElementById('confirmIcon');
            const actionBtn = document.getElementById('confirmActionBtn');
            
            if (!modal || !title || !message || !actionBtn) return;
            
            // Set modal content
            title.textContent = config.title;
            titleText.textContent = config.titleText || config.title;
            message.textContent = config.message;
            
            // Set icon
            icon.innerHTML = `<iconify-icon icon="${config.icon || 'mdi:alert-circle'}" style="font-size: 2.5rem;"></iconify-icon>`;
            icon.style.background = config.iconBg || 'var(--danger-light)';
            icon.style.color = config.iconColor || 'var(--danger)';
            
            // Set action button
            actionBtn.textContent = config.actionText || 'تأكيد';
            actionBtn.className = `btn ${config.actionType || 'btn-danger'}`;
            if (config.actionIcon) {
                actionBtn.innerHTML = `<iconify-icon icon="${config.actionIcon}"></iconify-icon> <span>${config.actionText || 'تأكيد'}</span>`;
            }
            
            // Store action callback
            currentConfirmAction = config.action;
            currentConfirmData = config.data;
            
            openModal('confirmModal');
        }

        async function handleConfirmAction() {
            if (currentConfirmAction) {
                await currentConfirmAction(currentConfirmData);
            }
            closeAllModals();
            currentConfirmAction = null;
            currentConfirmData = null;
        }

        // ===== SETTINGS MODAL =====
        function openSettingsModal() {
            if (!currentUser) {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            updateSettingsUI();
            openModal('settingsModal');
        }

        function updateSettingsUI() {
            if (!currentUser) return;
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            const email = currentUser.email || 'غير محدد';
            const createdAt = userSettings.createdAt ? formatDate(userSettings.createdAt.toDate()) : formatDate(new Date());
            
            document.getElementById('settingsName').textContent = displayName;
            document.getElementById('settingsEmail').textContent = email;
            document.getElementById('settingsCreatedAt').textContent = createdAt;
            
            const plan = userSettings.plan || 'مجانية';
            document.getElementById('currentPlan').textContent = plan;
            document.getElementById('currentPlan').className = `plan-badge ${plan === 'مجانية' ? '' : 'pro'}`;
            
            document.getElementById('boardsLimit').textContent = plan === 'مجانية' ? '10 حسابات' : 'غير محدود';
            
            // Theme selector
            const currentTheme = userSettings.theme || 'light';
            const themeOptions = document.querySelectorAll('#themeSelector .segmented-option');
            themeOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-theme') === currentTheme) {
                    option.classList.add('selected');
                }
            });
            
            // Password visibility selector
            const currentVisibility = userSettings.passwordVisibility || 'hold';
            const visibilityOptions = document.querySelectorAll('#passwordVisibilitySelector .segmented-option');
            visibilityOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-value') === currentVisibility) {
                    option.classList.add('selected');
                }
            });
            
            // Debug mode selector
            const currentDebugMode = userSettings.debugMode || 'off';
            const debugOptions = document.querySelectorAll('#debugModeSelector .segmented-option');
            debugOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-value') === currentDebugMode) {
                    option.classList.add('selected');
                }
            });
            
            // Debug info section
            const debugSection = document.getElementById('debugInfoSection');
            if (debugSection) {
                debugSection.style.display = currentDebugMode === 'on' ? 'block' : 'none';
                
                if (currentDebugMode === 'on') {
                    document.getElementById('debugDeviceId').textContent = currentDeviceId || '-';
                    document.getElementById('debugOwnerId').textContent = securityData?.ownerDeviceId || '-';
                    document.getElementById('debugDeviceStatus').textContent = deviceStatus || '-';
                    document.getElementById('debugLastCheck').textContent = new Date().toLocaleString('ar-SA');
                }
            }
        }

        function editUserName() {
            const currentName = document.getElementById('settingsName').textContent;
            const newName = prompt('أدخل اسمك الجديد:', currentName);
            
            if (newName && newName.trim() && newName !== currentName) {
                const trimmedName = newName.trim();
                updateUserName(trimmedName);
            }
        }

        async function updateUserName(name) {
            try {
                await updateProfile(currentUser, {
                    displayName: name
                });
                
                await updateDoc(accountRef, {
                    'profile.name': name,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                updateUserUI();
                updateSettingsUI();
                showToast('تم تحديث الاسم بنجاح', 'success');
            } catch (error) {
                console.error('Error updating name:', error);
                showToast('حدث خطأ أثناء تحديث الاسم', 'error');
            }
        }

        function selectTheme(option) {
            const theme = option.getAttribute('data-theme');
            
            document.querySelectorAll('#themeSelector .segmented-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            applyTheme(theme);
            
            userSettings.theme = theme;
            updateSettings();
            
            logActivity('theme', { theme });
        }

        function selectPasswordVisibility(option) {
            const value = option.getAttribute('data-value');
            
            document.querySelectorAll('#passwordVisibilitySelector .segmented-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            userSettings.passwordVisibility = value;
            updateSettings();
            showToast('تم حفظ التفضيل', 'success');
        }

        function selectDebugMode(option) {
            const value = option.getAttribute('data-value');
            
            document.querySelectorAll('#debugModeSelector .segmented-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            userSettings.debugMode = value;
            updateSettings();
            
            // Update UI immediately
            const debugSection = document.getElementById('debugInfoSection');
            if (debugSection) {
                debugSection.style.display = value === 'on' ? 'block' : 'none';
            }
            
            showToast('تم تغيير وضع التصحيح', 'success');
        }

        async function updateSettings() {
            if (!accountRef) return;
            
            try {
                await updateDoc(accountRef, {
                    settings: userSettings,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error updating settings:', error);
            }
        }

        // ===== UI RENDERING =====
        async function loadAndRenderDevices() {
            userDevices = await loadDevices();
            renderDevices(userDevices);
        }

        function renderDevices(devices) {
            const devicesList = document.getElementById('devicesList');
            if (!devicesList) return;
            
            if (devices.length === 0) {
                devicesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <iconify-icon icon="mdi:devices"></iconify-icon>
                        </div>
                        <h3 class="h3">لا توجد أجهزة</h3>
                        <p class="body">
                            سيظهر هنا أي جهاز تقوم بتسجيل الدخول منه
                        </p>
                    </div>
                `;
                return;
            }
            
            devicesList.innerHTML = '';
            
            devices.forEach(device => {
                const deviceElement = createDeviceElement(device);
                devicesList.appendChild(deviceElement);
            });
        }

        function createDeviceElement(device) {
            const isCurrent = device.id === currentDeviceId;
            const isOwner = securityData?.ownerDeviceId === device.id;
            const isBlocked = securityData?.blockedDevices?.[device.id];
            const isPending = securityData?.pendingDevices?.[device.id] && !isOwner;
            
            let deviceClass = 'device-card';
            if (isCurrent) deviceClass += ' current';
            if (isBlocked) deviceClass += ' blocked';
            if (isPending) deviceClass += ' pending';
            
            const element = document.createElement('div');
            element.className = deviceClass;
            
            const lastActive = formatTimeAgo(device.lastActive);
            const deviceIcon = getDeviceIcon(device.deviceName);
            
            element.innerHTML = `
                <div class="device-icon">
                    <iconify-icon icon="${deviceIcon}"></iconify-icon>
                </div>
                
                <div class="device-info">
                    <div class="device-header">
                        <div>
                            <div class="device-name">${device.deviceName}</div>
                            <div class="device-details">
                                ${device.browser} • ${device.os}
                            </div>
                        </div>
                        <div class="device-badges">
                            ${isCurrent ? `
                                <span class="device-badge current">
                                    <iconify-icon icon="mdi:check-circle"></iconify-icon>
                                    هذا الجهاز
                                </span>
                            ` : ''}
                            ${isOwner ? `
                                <span class="device-badge owner">
                                    <iconify-icon icon="mdi:crown"></iconify-icon>
                                    المالك
                                </span>
                            ` : ''}
                            ${device.trusted && !isBlocked ? `
                                <span class="device-badge trusted">
                                    <iconify-icon icon="mdi:shield-check"></iconify-icon>
                                    موثوق
                                </span>
                            ` : ''}
                            ${isBlocked ? `
                                <span class="device-badge blocked">
                                    <iconify-icon icon="mdi:block-helper"></iconify-icon>
                                    محظور
                                </span>
                            ` : ''}
                            ${isPending ? `
                                <span class="device-badge pending">
                                    <iconify-icon icon="mdi:clock-outline"></iconify-icon>
                                    في انتظار الموافقة
                                </span>
                            ` : ''}
                            ${userSettings.debugMode === 'on' ? `
                                <span class="device-badge debug">
                                    <iconify-icon icon="mdi:bug"></iconify-icon>
                                    ${device.id.substring(0, 8)}...
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="device-time">
                        <iconify-icon icon="mdi:clock-outline"></iconify-icon>
                        <span>آخر نشاط: ${lastActive}</span>
                    </div>
                </div>
                
                <div class="device-actions">
                    ${renderDeviceActions(device, isCurrent, isOwner, isBlocked, isPending)}
                </div>
            `;
            
            // Add event listeners for action buttons
            setTimeout(() => {
                if (!isCurrent) {
                    const logoutBtn = element.querySelector('.logout');
                    const trustBtn = element.querySelector('.trust');
                    const untrustBtn = element.querySelector('.untrust');
                    const blockBtn = element.querySelector('.block');
                    const unblockBtn = element.querySelector('.unblock');
                    const approveBtn = element.querySelector('.approve');
                    
                    logoutBtn?.addEventListener('click', () => signOutDevice(device));
                    trustBtn?.addEventListener('click', () => toggleDeviceTrustAction(device.id, true));
                    untrustBtn?.addEventListener('click', () => toggleDeviceTrustAction(device.id, false));
                    blockBtn?.addEventListener('click', () => blockDeviceAction(device));
                    unblockBtn?.addEventListener('click', () => unblockDeviceAction(device.id));
                    approveBtn?.addEventListener('click', () => approveDeviceAction(device.id));
                }
            }, 100);
            
            return element;
        }

        function renderDeviceActions(device, isCurrent, isOwner, isBlocked, isPending) {
            if (isCurrent) {
                return ''; // No actions for current device
            }
            
            if (!isOwnerDevice) {
                return ''; // Only owner device can perform actions
            }
            
            let actions = '';
            
            if (isBlocked) {
                actions += `
                    <button class="device-action-btn unblock" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:lock-open"></iconify-icon>
                        إلغاء المنع
                    </button>
                `;
            } else if (isPending) {
                actions += `
                    <button class="device-action-btn approve" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:check-circle"></iconify-icon>
                        الموافقة
                    </button>
                    <button class="device-action-btn block" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:block-helper"></iconify-icon>
                        رفض
                    </button>
                `;
            } else {
                actions += `
                    <button class="device-action-btn logout" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:logout"></iconify-icon>
                        تسجيل الخروج
                    </button>
                    ${device.trusted ? `
                        <button class="device-action-btn untrust" data-device-id="${device.id}">
                            <iconify-icon icon="mdi:shield-off"></iconify-icon>
                            إلغاء الثقة
                        </button>
                    ` : `
                        <button class="device-action-btn trust" data-device-id="${device.id}">
                            <iconify-icon icon="mdi:shield-check"></iconify-icon>
                            تعيين كموثوق
                        </button>
                    `}
                    <button class="device-action-btn block" data-device-id="${device.id}">
                        <iconify-icon icon="mdi:block-helper"></iconify-icon>
                        منع
                    </button>
                `;
            }
            
            return actions;
        }

        function setupActivityFilters() {
            const filtersContainer = document.getElementById('activityFilters');
            if (!filtersContainer) return;
            
            const filters = [
                { value: 'all', label: 'الكل' },
                { value: 'security', label: 'الأمان' },
                { value: 'vault', label: 'الحسابات' },
                { value: 'migration', label: 'الترحيل' }
            ];
            
            filtersContainer.innerHTML = filters.map(filter => `
                <button class="activity-filter ${filter.value === 'all' ? 'active' : ''}" 
                        data-filter="${filter.value}">
                    ${filter.label}
                </button>
            `).join('');
            
            filtersContainer.querySelectorAll('.activity-filter').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const filter = e.target.getAttribute('data-filter');
                    
                    filtersContainer.querySelectorAll('.activity-filter').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    await loadAndRenderActivityLogs(filter);
                });
            });
        }

        async function loadAndRenderActivityLogs(filter = 'all') {
            const logs = await loadActivityLogs(filter);
            renderActivityLogs(logs);
        }

        function renderActivityLogs(logs) {
            const timeline = document.getElementById('activityTimeline');
            if (!timeline) return;
            
            if (logs.length === 0) {
                timeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <iconify-icon icon="mdi:history"></iconify-icon>
                        </div>
                        <h3 class="h3">لا توجد سجلات نشاط</h3>
                        <p class="body">
                            سيظهر هنا أي نشاط تقوم به على حسابك
                        </p>
                    </div>
                `;
                return;
            }
            
            const logsByDay = groupLogsByDay(logs);
            
            timeline.innerHTML = '';
            
            Object.keys(logsByDay).forEach(day => {
                const dayGroup = document.createElement('div');
                dayGroup.className = 'activity-day-group';
                
                dayGroup.innerHTML = `
                    <div class="day-header">
                        <h3 class="day-label">${day}</h3>
                        <span class="day-count">${logsByDay[day].length} نشاط</span>
                    </div>
                    <div class="activity-items">
                        ${logsByDay[day].map(log => createActivityItem(log)).join('')}
                    </div>
                `;
                
                timeline.appendChild(dayGroup);
            });
        }

        function createActivityItem(log) {
            const activity = getActivityInfo(log.action);
            const description = getActivityDescription(log.action, log.details);
            
            return `
                <div class="activity-item">
                    <div class="activity-icon ${log.action}">
                        <iconify-icon icon="${activity.icon}"></iconify-icon>
                    </div>
                    <div class="activity-content">
                        <div class="activity-description">${description}</div>
                        <div class="activity-details">
                            ${log.deviceName ? `من ${log.deviceName}` : ''}
                        </div>
                    </div>
                    <div class="activity-time">
                        ${formatTime(log.timestamp)}
                    </div>
                </div>
            `;
        }

        // ===== BOARD OPERATIONS =====
        async function loadUserData() {
            if (!accountRef) return;
            
            const accountDoc = await getDoc(accountRef);
            if (accountDoc.exists()) {
                const data = accountDoc.data();
                userBoards = data.vault?.boards || [];
                userSettings = data.settings || {};
                securityData = data.security || {};
                
                renderBoards();
            }
        }

        async function handleBoardSubmit(e) {
            e.preventDefault();
            
            const boardName = document.getElementById('boardName').value.trim();
            const boardEmail = document.getElementById('boardEmail').value.trim();
            const boardPassword = document.getElementById('boardPassword').value.trim();
            
            let isValid = true;
            
            if (!boardName) {
                showError('nameError', 'اسم الحساب مطلوب');
                isValid = false;
            } else {
                hideError('nameError');
            }
            
            if (!boardEmail) {
                showError('emailError', 'البريد الإلكتروني مطلوب');
                isValid = false;
            } else {
                hideError('emailError');
            }
            
            if (!boardPassword) {
                showError('passwordError', 'كلمة المرور مطلوبة');
                isValid = false;
            } else {
                hideError('passwordError');
            }
            
            if (!isValid) {
                showToast('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            const selectedIcon = document.querySelector('.icon-option.selected');
            const selectedColor = document.querySelector('.radio-circle.selected');
            
            if (!selectedIcon || !selectedColor) {
                showToast('الرجاء اختيار أيقونة وتصنيف', 'error');
                return;
            }
            
            const boardIcon = selectedIcon.getAttribute('data-icon');
            const boardColor = selectedColor.getAttribute('data-color');
            const boardColorClass = selectedColor.getAttribute('data-class');
            const boardColorLabel = selectedColor.getAttribute('data-label');
            
            const saveBtn = document.getElementById('saveBoardBtn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<iconify-icon icon="mdi:loading" style="animation: spin 1s linear infinite;"></iconify-icon> جاري الحفظ...';
            saveBtn.disabled = true;
            
            try {
                const boardData = {
                    id: currentEditingBoard || generateId(),
                    name: boardName,
                    email: boardEmail,
                    password: boardPassword,
                    icon: boardIcon,
                    color: boardColor,
                    colorClass: boardColorClass,
                    colorLabel: boardColorLabel,
                    updatedAt: new Date().toISOString(),
                    createdAt: currentEditingBoard ? 
                        userBoards.find(b => b.id === currentEditingBoard)?.createdAt || new Date().toISOString() : 
                        new Date().toISOString()
                };
                
                if (currentEditingBoard) {
                    const index = userBoards.findIndex(b => b.id === currentEditingBoard);
                    if (index !== -1) {
                        userBoards[index] = boardData;
                        showToast('تم تحديث الحساب بنجاح!', 'success');
                    }
                } else {
                    userBoards.push(boardData);
                    showToast('تم إضافة الحساب بنجاح!', 'success');
                }
                
                await updateDoc(accountRef, {
                    'vault.boards': userBoards,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                await logActivity(currentEditingBoard ? 'edit' : 'add', { boardName: boardName });
                renderBoards();
                closeAllModals();
            } catch (error) {
                console.error('Error saving board:', error);
                showToast('حدث خطأ أثناء حفظ الحساب', 'error');
            } finally {
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
            }
        }

        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
                const input = document.getElementById(errorId.replace('Error', ''));
                if (input) {
                    input.classList.add('error');
                }
            }
        }

        function hideError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.classList.remove('show');
                const input = document.getElementById(errorId.replace('Error', ''));
                if (input) {
                    input.classList.remove('error');
                }
            }
        }

        function showDeleteConfirmation(board) {
            showConfirmModal({
                title: 'حذف حساب',
                titleText: `حذف ${board.name}`,
                message: `سيتم حذف حساب "${board.name}" نهائياً. لا يمكن التراجع عن هذا الإجراء.`,
                icon: 'mdi:delete',
                iconBg: 'var(--danger-light)',
                iconColor: 'var(--danger)',
                actionText: 'نعم، احذف',
                actionIcon: 'mdi:delete',
                actionType: 'btn-danger',
                action: () => deleteBoard(board),
                data: board
            });
        }

        async function deleteBoard(board) {
            try {
                userBoards = userBoards.filter(b => b.id !== board.id);
                
                await updateDoc(accountRef, {
                    'vault.boards': userBoards,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                await logActivity('delete', { boardName: board.name });
                renderBoards();
                showToast('تم حذف الحساب بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting board:', error);
                showToast('حدث خطأ أثناء حذف الحساب', 'error');
            }
        }

        function renderBoards() {
            const container = document.getElementById('boardsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (userBoards.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    container.appendChild(emptyState);
                }
                return;
            }
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            userBoards.forEach(board => {
                const boardElement = createBoardElement(board);
                if (boardElement) {
                    container.appendChild(boardElement);
                }
            });
        }

        function createBoardElement(board) {
            const element = document.createElement('div');
            element.className = 'board-card';
            
            const password = board.password;
            let strength = 0;
            let totalWeight = 0;
            
            passwordCriteria.forEach(criteria => {
                if (criteria.test(password)) {
                    strength += criteria.weight;
                }
                totalWeight += criteria.weight;
            });
            
            const lengthBonus = Math.min(password.length * 2, 20);
            strength += lengthBonus;
            totalWeight += 20;
            
            const percentage = Math.min(Math.round((strength / totalWeight) * 100), 100);
            
            element.innerHTML = `
                <div class="card-header">
                    <div class="board-icon-wrapper">
                        <div class="board-icon">
                            <iconify-icon icon="${board.icon || 'mdi:web'}"></iconify-icon>
                        </div>
                        <div class="color-dot ${board.colorClass || 'personal'}" title="${board.colorLabel || 'شخصي'}"></div>
                    </div>
                    
                    <div class="board-info">
                        <h4 class="board-name">${escapeHtml(board.name)}</h4>
                        <div class="board-username">${escapeHtml(board.email)}</div>
                    </div>
                </div>
                
                <div class="password-section">
                    <div class="password-label">
                        <span class="caption">كلمة المرور</span>
                        <span class="caption" style="color: var(--text-muted);">• إظهار بالضغط المطول</span>
                    </div>
                    
                    <div class="password-field">
                        <input type="password" 
                               class="password-input" 
                               value="${escapeHtml(board.password)}" 
                               readonly>
                        <div style="display: flex; gap: 0.25rem;">
                            <button class="action-btn toggle" 
                                    type="button"
                                    aria-label="إظهار كلمة المرور">
                                <iconify-icon icon="mdi:eye"></iconify-icon>
                            </button>
                            <button class="action-btn copy" 
                                    type="button"
                                    aria-label="نسخ كلمة المرور">
                                <iconify-icon icon="mdi:content-copy"></iconify-icon>
                            </button>
                        </div>
                    </div>
                    
                    <div class="password-strength-advanced">
                        <div class="strength-meter">
                            <div class="strength-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="strength-score">${percentage}%</div>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="action-btn copy email-copy" 
                            type="button"
                            aria-label="نسخ البريد الإلكتروني">
                        <iconify-icon icon="mdi:email"></iconify-icon>
                        <span>نسخ البريد</span>
                    </button>
                    <button class="action-btn edit" 
                            type="button"
                            aria-label="تعديل الحساب"
                            data-id="${board.id}">
                        <iconify-icon icon="mdi:pencil"></iconify-icon>
                        <span>تعديل</span>
                    </button>
                    <button class="action-btn delete" 
                            type="button"
                            aria-label="حذف الحساب"
                            data-id="${board.id}">
                        <iconify-icon icon="mdi:delete"></iconify-icon>
                        <span>حذف</span>
                    </button>
                </div>
            `;
            
            const copyEmailBtn = element.querySelector('.email-copy');
            const copyPasswordBtn = element.querySelector('.password-field .action-btn.copy');
            const editButton = element.querySelector('.action-btn.edit');
            const deleteButton = element.querySelector('.action-btn.delete');
            const toggleButton = element.querySelector('.action-btn.toggle');
            const passwordInput = element.querySelector('.password-input');
            
            copyEmailBtn.addEventListener('click', () => {
                copyToClipboard(board.email, copyEmailBtn, board.name);
            });
            
            copyPasswordBtn.addEventListener('click', () => {
                copyToClipboard(board.password, copyPasswordBtn, board.name);
            });
            
            editButton.addEventListener('click', () => {
                const boardToEdit = userBoards.find(b => b.id === board.id);
                if (boardToEdit) openBoardModal('edit', boardToEdit);
            });
            
            deleteButton.addEventListener('click', () => {
                showDeleteConfirmation(board);
            });
            
            if (toggleButton && passwordInput) {
                const visibilityMode = userSettings.passwordVisibility || 'hold';
                
                if (visibilityMode === 'always') {
                    passwordInput.type = 'text';
                    toggleButton.innerHTML = '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                    toggleButton.addEventListener('click', () => {
                        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                        toggleButton.innerHTML = passwordInput.type === 'password' ? 
                            '<iconify-icon icon="mdi:eye"></iconify-icon>' : 
                            '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                    });
                } else if (visibilityMode === 'click') {
                    toggleButton.addEventListener('click', () => {
                        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                        toggleButton.innerHTML = passwordInput.type === 'password' ? 
                            '<iconify-icon icon="mdi:eye"></iconify-icon>' : 
                            '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                    });
                } else {
                    let holdTimer;
                    
                    const showPassword = () => {
                        passwordInput.type = 'text';
                        toggleButton.innerHTML = '<iconify-icon icon="mdi:eye-off"></iconify-icon>';
                    };
                    
                    const hidePassword = () => {
                        clearTimeout(holdTimer);
                        passwordInput.type = 'password';
                        toggleButton.innerHTML = '<iconify-icon icon="mdi:eye"></iconify-icon>';
                    };
                    
                    toggleButton.addEventListener('mousedown', () => {
                        holdTimer = setTimeout(showPassword, 500);
                    });
                    
                    toggleButton.addEventListener('mouseup', hidePassword);
                    toggleButton.addEventListener('mouseleave', hidePassword);
                    
                    toggleButton.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        holdTimer = setTimeout(showPassword, 500);
                    });
                    
                    toggleButton.addEventListener('touchend', hidePassword);
                    toggleButton.addEventListener('touchcancel', hidePassword);
                }
            }
            
            return element;
        }

        // ===== DEVICE ACTIONS HANDLERS =====
        async function signOutDevice(device) {
            try {
                const deviceRef = doc(accountRef, 'devices', device.id);
                await deleteDoc(deviceRef);
                
                await logActivity('device_logout', {
                    deviceName: device.deviceName
                });
                
                await loadAndRenderDevices();
                showToast('تم تسجيل الخروج من الجهاز بنجاح', 'success');
            } catch (error) {
                console.error('Error signing out device:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج من الجهاز', 'error');
            }
        }

        function toggleDeviceTrustAction(deviceId, trusted) {
            showConfirmModal({
                title: trusted ? 'تعيين كموثوق' : 'إلغاء الثقة',
                titleText: trusted ? 'تعيين الجهاز كموثوق' : 'إلغاء الثقة عن الجهاز',
                message: trusted 
                    ? 'هل تريد تعيين هذا الجهاز كموثوق؟ الأجهزة الموثوقة يمكنها الوصول بدون موافقة.'
                    : 'هل تريد إلغاء الثقة عن هذا الجهاز؟ سيحتاج الجهاز إلى موافقة عند تسجيل الدخول التالي.',
                icon: trusted ? 'mdi:shield-check' : 'mdi:shield-off',
                iconBg: 'var(--mint-50)',
                iconColor: 'var(--mint-400)',
                actionText: trusted ? 'نعم، تعيين' : 'نعم، إلغاء',
                actionIcon: trusted ? 'mdi:shield-check' : 'mdi:shield-off',
                actionType: 'btn-primary',
                action: async () => {
                    const success = await toggleDeviceTrust(deviceId, trusted);
                    if (success) {
                        await loadAndRenderDevices();
                    }
                },
                data: { deviceId, trusted }
            });
        }

        function blockDeviceAction(device) {
            showConfirmModal({
                title: 'منع جهاز',
                titleText: `منع ${device.deviceName}`,
                message: 'اختر نوع المنع:<br><br>' +
                        '• <strong>منع مؤقت</strong>: يمكن إلغاؤه لاحقاً<br>' +
                        '• <strong>منع نهائي</strong>: لا يمكن إلغاؤه',
                icon: 'mdi:block-helper',
                iconBg: 'var(--danger-light)',
                iconColor: 'var(--danger)',
                actionText: 'مؤقت',
                actionIcon: 'mdi:clock-alert',
                actionType: 'btn-warning',
                action: async (data) => {
                    const permanent = data?.permanent || false;
                    const reason = data?.reason || '';
                    const success = await blockDevice(device.id, permanent, reason);
                    if (success) {
                        await loadAndRenderDevices();
                    }
                },
                data: { deviceId: device.id, permanent: false }
            });
            
            // Add permanent block button
            const modalActions = document.querySelector('#confirmModal .modal-actions');
            if (modalActions) {
                const permanentBtn = document.createElement('button');
                permanentBtn.className = 'btn btn-danger';
                permanentBtn.innerHTML = '<iconify-icon icon="mdi:block-helper"></iconify-icon> <span>نهائي</span>';
                permanentBtn.onclick = () => {
                    const reason = prompt('أدخل سبب المنع النهائي (اختياري):', 'منع نهائي من المالك');
                    showConfirmModal({
                        title: 'تأكيد المنع النهائي',
                        titleText: `منع نهائي لـ ${device.deviceName}`,
                        message: `⚠️ <strong>تحذير:</strong> هذا الإجراء لا يمكن التراجع عنه.<br><br>` +
                                `سيتم منع الجهاز ${device.deviceName} نهائياً من الوصول إلى الحساب.`,
                        icon: 'mdi:alert-circle',
                        iconBg: 'var(--danger-light)',
                        iconColor: 'var(--danger)',
                        actionText: 'نعم، منع نهائي',
                        actionIcon: 'mdi:block-helper',
                        actionType: 'btn-danger',
                        action: async () => {
                            const success = await blockDevice(device.id, true, reason);
                            if (success) {
                                await loadAndRenderDevices();
                            }
                        },
                        data: { deviceId: device.id, permanent: true, reason }
                    });
                };
                
                const cancelBtn = document.getElementById('cancelConfirmBtn');
                modalActions.insertBefore(permanentBtn, cancelBtn.nextSibling);
            }
        }

        function unblockDeviceAction(deviceId) {
            showConfirmModal({
                title: 'إلغاء منع جهاز',
                titleText: 'إلغاء المنع عن الجهاز',
                message: 'هل تريد إلغاء منع هذا الجهاز؟ سيكون بإمكان الجهاز تسجيل الدخول مرة أخرى.',
                icon: 'mdi:lock-open',
                iconBg: 'var(--mint-50)',
                iconColor: 'var(--mint-400)',
                actionText: 'نعم، إلغاء المنع',
                actionIcon: 'mdi:lock-open',
                actionType: 'btn-primary',
                action: async () => {
                    const success = await unblockDevice(deviceId);
                    if (success) {
                        await loadAndRenderDevices();
                    }
                },
                data: { deviceId }
            });
        }

        function approveDeviceAction(deviceId) {
            showConfirmModal({
                title: 'الموافقة على جهاز',
                titleText: 'الموافقة على الجهاز',
                message: 'هل تريد الموافقة على هذا الجهاز؟ سيتمكن الجهاز من الوصول إلى الحساب.',
                icon: 'mdi:check-circle',
                iconBg: 'rgba(16, 185, 129, 0.1)',
                iconColor: 'var(--success)',
                actionText: 'نعم، الموافقة',
                actionIcon: 'mdi:check-circle',
                actionType: 'btn-primary',
                action: async () => {
                    const success = await approveDevice(deviceId);
                    if (success) {
                        await loadAndRenderDevices();
                    }
                },
                data: { deviceId }
            });
        }

        // ===== UTILITY FUNCTIONS =====
        function selectIcon(iconElement) {
            document.querySelectorAll('.icon-option').forEach(icon => {
                icon.classList.remove('selected');
            });
            iconElement.classList.add('selected');
            
            iconElement.style.animation = 'copyPulse 0.6s';
            setTimeout(() => {
                iconElement.style.animation = '';
            }, 600);
        }

        function selectColor(colorCircle) {
            document.querySelectorAll('.radio-circle').forEach(circle => {
                circle.classList.remove('selected');
            });
            colorCircle.classList.add('selected');
            
            colorCircle.style.boxShadow = '0 0 0 4px rgba(62, 180, 137, 0.2)';
            setTimeout(() => {
                colorCircle.style.boxShadow = '';
            }, 300);
        }

        function getDeviceIcon(deviceName) {
            if (deviceName.includes('هاتف')) return 'mdi:cellphone';
            if (deviceName.includes('تابلت')) return 'mdi:tablet';
            if (deviceName.includes('حاسوب')) return 'mdi:laptop';
            return 'mdi:devices';
        }

        function getActivityInfo(action) {
            return activityIcons[action] || { icon: 'mdi:information', label: 'نشاط' };
        }

        function getActivityDescription(action, details) {
            return activityDescriptions[action]?.(details) || 'نشاط جديد';
        }

        function groupLogsByDay(logs) {
            const groups = {};
            
            logs.forEach(log => {
                const date = log.timestamp.toLocaleDateString('ar-SA', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!groups[date]) {
                    groups[date] = [];
                }
                
                groups[date].push(log);
            });
            
            return groups;
        }

        function copyToClipboard(text, button, boardName = '') {
            navigator.clipboard.writeText(text).then(() => {
                showToast('تم النسخ إلى الحافظة!', 'success');
                
                if (button) {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<iconify-icon icon="mdi:check" style="color: var(--success);"></iconify-icon>';
                    
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                    }, 2000);
                }
                
                if (boardName) {
                    logActivity('copy', { boardName: boardName });
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('حدث خطأ أثناء النسخ', 'error');
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatDate(date) {
            if (!date) return '-';
            
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(date) {
            if (!date) return '';
            
            return date.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
            if (diffHours < 24) return `منذ ${diffHours} ساعة`;
            if (diffDays < 7) return `منذ ${diffDays} يوم`;
            
            return date.toLocaleDateString('ar-SA');
        }

        function updateUserUI() {
            if (!currentUser) return;
            
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'المستخدم';
            document.getElementById('userName').textContent = displayName;
            document.getElementById('dropdownName').textContent = displayName;
            document.getElementById('userEmail').textContent = currentUser.email || 'user@example.com';
            document.getElementById('welcomeMessage').textContent = `مرحباً ${displayName}!`;
            
            const initial = displayName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
        }

        // ===== LOGOUT =====
        async function handleLogout(e) {
            if (e) e.preventDefault();
            
            try {
                await logActivity('logout');
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
            }
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            
            const icon = {
                success: 'mdi:check-circle',
                error: 'mdi:alert-circle',
                info: 'mdi:information'
            }[type];
            
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <iconify-icon icon="${icon}"></iconify-icon>
                </div>
                <span class="body-sm">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Firebase deleteField helper
        const deleteField = () => {
            // This is a placeholder for Firebase's deleteField()
            // In actual Firebase, you would import { deleteField } from 'firebase/firestore'
            return null;
        };
    </script>
</body>
</html>